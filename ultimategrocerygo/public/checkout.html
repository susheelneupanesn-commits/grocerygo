<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo â€” Secure Checkout</title>
<script src="https://js.stripe.com/v3"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background:#f3f4f6; }
.StripeElement { box-sizing:border-box; height:48px; padding:12px; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; transition: all 0.15s ease; }
.StripeElement--focus { box-shadow:0 0 0 3px rgba(79,70,229,0.15); border-color:#4f46e5; }
.summary-card { position: sticky; top: 1rem; }
.time-slot-radio:checked + label { background:#4f46e5; color:#fff; border-color:#4f46e5; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
</style>
</head>
<body class="min-h-screen p-4 lg:p-8">
<div class="max-w-5xl mx-auto">
  <h1 class="text-3xl lg:text-4xl font-extrabold mb-6 text-center text-gray-800">Secure Checkout</h1>

  <form id="payment-form" class="lg:grid lg:grid-cols-3 lg:gap-12" novalidate>
    <div class="lg:col-span-2 space-y-6">
      <!-- Shipping Information -->
      <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Shipping Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label><span class="text-sm font-medium">Full Name</span>
            <input id="name" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
          </label>
          <label><span class="text-sm font-medium">Email</span>
            <input id="email" type="email" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
          <label><span class="text-sm font-medium">Mobile Phone</span>
            <input id="phone" type="tel" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
          </label>
          <label><span class="text-sm font-medium">Address Line 1</span>
            <input id="address" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
          </label>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
          <label><span class="text-sm font-medium">Suburb</span>
            <input id="suburb" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
          </label>
          <label><span class="text-sm font-medium">State</span>
            <input id="state" value="QLD" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
          </label>
          <label><span class="text-sm font-medium">Postcode</span>
            <input id="postcode" maxlength="4" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
          </label>
        </div>
      </section>

      <!-- Delivery Slot -->
      <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Choose Delivery Slot</h2>
        <label class="block mb-4">
          <span class="text-sm font-medium">Delivery Date</span>
          <input id="delivery-date" type="date" class="mt-1 w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
        </label>
        <div class="text-sm font-medium mb-3">Available Time Slots (<span id="selected-day-display" class="font-semibold text-indigo-600">Please Select a Date</span>)</div>
        <div id="time-slot-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
          <p class="text-gray-500 col-span-full text-sm">Please select a delivery date first.</p>
        </div>
        <input id="deliverySlot" type="hidden" value="">
      </section>

      <!-- Payment Details -->
      <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Payment Details</h2>
        <label class="block text-sm font-medium mb-2">Card Details (Secured by Stripe)</label>
        <div id="card-element" class="mt-2"></div>
        <div id="message-box" class="hidden mt-4 p-3 rounded-lg text-sm" role="alert"><p id="message-text"></p></div>
      </section>

      <div class="lg:hidden pb-8">
        <button id="submit-button-mobile" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-50" disabled>
          <span id="button-text-mobile">Pay $0.00</span>
        </button>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="lg:col-span-1 mt-8 lg:mt-0">
      <div class="summary-card bg-indigo-50 p-6 rounded-xl shadow-xl border border-indigo-200">
        <h2 class="text-2xl font-bold text-indigo-800 mb-4">Order Summary</h2>
        <div id="order-details" class="mt-3 text-gray-700 space-y-2 border-b pb-3">
          <div class="flex justify-between"><span>Items Subtotal</span><span id="subtotal-display" class="font-semibold">$0.00</span></div>
        </div>
        <div class="pt-3 mt-3 space-y-2">
          <div class="flex justify-between items-center">
            <span>Delivery Fee</span>
            <span id="delivery-fee-display" class="font-semibold text-gray-700">$0.00</span>
          </div>
          <div class="flex justify-between items-center text-2xl font-extrabold text-indigo-800 border-t pt-3 mt-3">
            <span>Grand Total</span>
            <span id="final-total-display">$0.00 AUD</span>
          </div>
        </div>
        <p id="delivery-info" class="text-xs text-red-600 mt-4 text-center font-medium">Please enter a valid postcode and select a slot.</p>
        <button id="submit-button-desktop" class="hidden lg:block w-full py-3 mt-4 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-50" disabled>
          <span id="button-text-desktop">Pay $0.00</span>
        </button>
      </div>
    </div>
  </form>
</div>

<script type="module">
import { supabase } from '/js/supabase-js.js';

const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SUX2cAtxwsqQt5Tf4eFuJC4uXKoauXjBAU5TiHC7MZnlR7rI6HIyHCMYJFeaCU7rSkQ4FBJD5q53QOw3DPKcOlg00VHp43m4l';
const SERVER_CREATE_PI = '/api/create-payment-intent';

let stripe = null;
let cardElement = null;

// --- DELIVERY ZONES & FEES ---
const GROUP_A = [4300,4301,4303,4304,4305,4306,4307,4308,4311,4114,4118,4124,4125,4127,4128,4129,4131,4132,4133,4207,4280,4285,4290];
const GROUP_B = [4169,4170,4171,4172,4173,4174,4178,4179,4157,4158,4159,4160,4161,4163,4164,4165];
const GROUP_C = [4000,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4017,4018,4025,4029,4030,4031,4032,4034,4035,4036,4051,4053,4054,4055,4059,4060,4061,4064,4065,4066,4067,4068,4069,4070,4072,4073,4074,4075,4076,4077,4078,4101,4102,4103,4104,4105,4106,4107,4108,4109,4110,4111,4112,4113,4114,4115,4116,4117,4118,4119,4120,4121,4122,4123,4124,4125,4127,4128,4129,4130,4132,4133,4151,4152,4153,4154,4155,4156,4157,4158,4159,4160,4161,4163,4164,4165,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4520];

const POSTCODE_DISTANCES = {};
GROUP_A.forEach((pc,i)=>POSTCODE_DISTANCES[pc]=30+(i%5));
GROUP_B.forEach((pc,i)=>POSTCODE_DISTANCES[pc]=15+(i%5));
GROUP_C.forEach((pc,i)=>POSTCODE_DISTANCES[pc]=1+(i%10));

const DISTANCE_FEES = [ {maxKm:10,fee:10},{maxKm:20,fee:15},{maxKm:30,fee:20},{maxKm:Infinity,fee:25} ];

function getDeliveryFee(postcode){
    const dist = POSTCODE_DISTANCES[Number(postcode)];
    if(dist===undefined) return -1;
    for(const df of DISTANCE_FEES) if(dist<=df.maxKm) return df.fee;
    return 25;
}

// DOM Elements
const dateInput=document.getElementById('delivery-date');
const postcodeInput=document.getElementById('postcode');
const slotContainer=document.getElementById('time-slot-container');
const deliverySlotInput=document.getElementById('deliverySlot');
const desktopButton=document.getElementById('submit-button-desktop');
const mobileButton=document.getElementById('submit-button-mobile');

// --- Utilities ---
function getTrolleyData(){
    return JSON.parse(localStorage.getItem('trolley')||'[]').map(item=>({id:item.id,price:item.price||0,quantity:item.quantity||1}));
}

function calculateSubtotal(trolley){ return trolley.reduce((sum,item)=>sum+(item.price||0)*(item.quantity||1),0); }

function showMessage(text,isError=false){
    const box=document.getElementById('message-box');
    const textEl=document.getElementById('message-text');
    box.classList.remove('hidden');
    box.className=isError?'mt-4 p-3 rounded-lg text-sm bg-red-100 text-red-800':'mt-4 p-3 rounded-lg text-sm bg-green-100 text-green-800';
    textEl.textContent=text;
}

// --- Stripe ---
function initializeStripe(){
    stripe=Stripe(STRIPE_PUBLISHABLE_KEY);
    const elements=stripe.elements();
    cardElement=elements.create('card',{style:{base:{fontSize:'16px','::placeholder':{color:'#9ca3af'}}},hidePostalCode:true});
    cardElement.mount('#card-element');
    cardElement.on('change',e=>{ if(e.error) showMessage(e.error.message,true); else document.getElementById('message-box').classList.add('hidden'); checkFormValidity(); });
    document.getElementById('payment-form').addEventListener('submit',handlePayment);
}

// --- Payment Handler ---
async function handlePayment(e){
    e.preventDefault();
    desktopButton.disabled=mobileButton.disabled=true;
    showMessage('Processing payment...');
    const customer={
        name:document.getElementById('name').value,
        email:document.getElementById('email').value,
        mobile:document.getElementById('phone').value,
        address:document.getElementById('address').value,
        suburb:document.getElementById('suburb').value,
        state:document.getElementById('state').value,
        postcode:document.getElementById('postcode').value,
        deliverySlot:deliverySlotInput.value,
        deliveryDate:dateInput.value
    };
    try{
        const trolley=getTrolleyData();
        if(!trolley.length) throw new Error("Trolley is empty");
        const res=await fetch(SERVER_CREATE_PI,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({trolley,customer})});
        const data=await res.json();
        if(data.error){ showMessage(data.error,true); return; }
        const result=await stripe.confirmCardPayment(data.clientSecret,{payment_method:{card:cardElement,billing_details:{name:customer.name,email:customer.email}}});
        if(result.error) showMessage(result.error.message,true);
        else if(result.paymentIntent?.status==='succeeded'){
            localStorage.removeItem('trolley');
            window.location.href=`/success.html?order=${encodeURIComponent(data.orderNumber)}`;
        }else showMessage('Payment status unknown',true);
    }catch(err){ console.error(err); showMessage(err.message,true);}
    finally{ checkFormValidity(); }
}

// --- Initialization ---
window.onload=()=>{
    dateInput.min=new Date().toISOString().split('T')[0];
    dateInput.addEventListener('change',updateTimeSlots);
    postcodeInput.addEventListener('input',calculateDeliveryEstimate);
    updateOrderSummary(getDeliveryFee(postcodeInput.value.trim()));
    updateTimeSlots();
    initializeStripe();
};
</script>
</body>
</html>
