<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GroceryGo | Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --primary-color:#DC143C;
  --secondary-color:#003893;
  --highlight-color:#FFD700;
  --bg-color:#f8f9fa;
  --text-color:#222;
  --border-color:#ddd;
  --nepali-blue:#003893;
}
*{box-sizing:border-box;}
body{font-family:'Poppins',sans-serif;margin:0;background:var(--bg-color);color:var(--text-color);}
header{background:linear-gradient(to right,var(--primary-color),var(--secondary-color));color:#fff;padding:15px 10px;text-align:center;position:sticky;top:0;z-index:1000;}
header h1{margin:0;font-size:30px;font-weight:900;display:flex;justify-content:center;align-items:center;height:60px;}
nav a{color:white;text-decoration:none;margin:0 10px;font-weight:600;font-size:14px;padding:5px 0;display:inline-block;}
nav a:hover{text-decoration:underline;}

.checkout-container{max-width:1200px;margin:40px auto;padding:10px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06);}
h2{font-size:1.5rem;margin-bottom:15px;}
label{display:block;margin:10px 0 5px;font-weight:600;}
input, select{padding:10px;margin-bottom:10px;border-radius:6px;border:1px solid var(--border-color);}
.row{display:flex;gap:10px;flex-wrap:wrap;}
.row > div{flex:1;min-width:100px;}
#payOptions button{flex:1;padding:12px;margin:5px;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:0.2s;}
#payOptions button:hover{opacity:0.85;}
#orderSummary{background:#f9f9f9;padding:15px;border-radius:8px;margin-top:10px;}
.summary-item{display:flex;justify-content:space-between;margin-bottom:8px;font-weight:500;}
</style>
</head>
<body>

<header>
  <h1>GroceryGo Checkout</h1>
  <nav>
    <a href="index.html">HOME</a>
    <a href="store.html">STORE</a>
  </nav>
</header>

<div class="checkout-container">
  <h2>Billing & Delivery Details</h2>
  <div class="row">
    <div>
      <label for="name">Full Name</label>
      <input type="text" id="name" required>
    </div>
    <div>
      <label for="email">Email</label>
      <input type="email" id="email" required>
    </div>
    <div>
      <label for="phone">Mobile</label>
      <input type="text" id="phone" required>
    </div>
  </div>

  <label for="address">Address Line 1</label>
  <input type="text" id="address" required>
  <label for="address2">Address Line 2</label>
  <input type="text" id="address2">

  <div class="row">
    <div>
      <label for="suburb">Suburb</label>
      <input type="text" id="suburb" required>
    </div>
    <div>
      <label for="postcode">Postcode</label>
      <input type="text" id="postcode" required>
    </div>
    <div>
      <label for="state">State</label>
      <select id="state">
        <option value="QLD">Queensland</option>
        <option value="NSW">New South Wales</option>
        <option value="VIC">Victoria</option>
        <option value="WA">Western Australia</option>
        <option value="SA">South Australia</option>
        <option value="TAS">Tasmania</option>
        <option value="NT">Northern Territory</option>
        <option value="ACT">Australian Capital Territory</option>
      </select>
    </div>
  </div>

  <label for="deliverySlot">Delivery Time Slot</label>
  <select id="deliverySlot">
    <option value="">Select a time slot</option>
  </select>

  <div id="orderSummary">
    <h3>Order Summary</h3>
    <div class="summary-item"><span>Subtotal:</span> <span id="checkoutSubtotal">$0.00</span></div>
    <div class="summary-item"><span>Delivery Fee:</span> <span id="deliveryFee">$0.00</span></div>
    <div class="summary-item"><span>Total:</span> <span id="checkoutTotal">$0.00</span></div>
  </div>

  <div id="payOptions" class="row">
    <button id="payCard" style="background:#fbbf24;color:white;">Pay with Card</button>
    <button id="payApple" style="background:#000;color:white;">Apple Pay</button>
    <button id="payGoogle" style="background:#4285F4;color:white;">Google Pay</button>
  </div>

  <div id="otpSection" style="margin-top:15px;display:none;">
    <label for="otpInput">Enter OTP (for testing shown below)</label>
    <input type="text" id="otpInput">
    <div id="displayOTP" style="font-weight:bold;color:red;margin-top:5px;"></div>
  </div>

</div>

<script>
const SUPABASE_URL = "https://gikdqaxdqfmzdvolkxbn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdpa2RxYXhkcWZtemR2b2xreGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyOTQwNDIsImV4cCI6MjA3Nzg3MDA0Mn0.pJ-9KfCxV7YT5loiURW14xRmf72s1EZRFRh4iKGnQis";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let trolley = JSON.parse(localStorage.getItem('grocerygo_trolley')) || [];
let subtotal = parseFloat(localStorage.getItem('grocerygo_subtotal')) || 0;
let deliveryFee = 10.00;

// Delivery Zones
const zones = {
  A:['Monday 8-11','Tuesday 11-15','Wednesday 15-19','Thursday 8-11','Friday 11-15','Saturday 15-19'],
  B:['Monday 11-15','Tuesday 15-19','Wednesday 8-11','Thursday 11-15','Friday 15-19','Saturday 8-11'],
  C:['Monday 15-19','Tuesday 8-11','Wednesday 11-15','Thursday 15-19','Friday 8-11','Saturday 11-15']
};
const zoneA = [4000,4005,4006,4007,4008,4009]; // example subset
const zoneB = [4530,4532,4535];
const zoneC = [4560,4561,4562];

function getZone(postcode){
  postcode = parseInt(postcode);
  if(zoneA.includes(postcode)) return 'A';
  if(zoneB.includes(postcode)) return 'B';
  if(zoneC.includes(postcode)) return 'C';
  return null;
}

function populateSlots(){
  const postcode = document.getElementById('postcode').value;
  const slotSelect = document.getElementById('deliverySlot');
  slotSelect.innerHTML = '<option value="">Select a time slot</option>';
  const zone = getZone(postcode);
  const deliveryFeeEl = document.getElementById('deliveryFee');
  if(!zone){
    slotSelect.innerHTML = '<option>Delivery not available in your area</option>';
    deliveryFeeEl.textContent = "$0.00";
    return;
  }
  zones[zone].forEach(slot=>{
    const opt = document.createElement('option');
    opt.textContent = slot;
    slotSelect.appendChild(opt);
  });
  deliveryFeeEl.textContent = `$${deliveryFee.toFixed(2)}`;
}

// Update summary
function updateSummary(){
  document.getElementById('checkoutSubtotal').textContent = `$${subtotal.toFixed(2)}`;
  document.getElementById('checkoutTotal').textContent = `$${(subtotal+deliveryFee).toFixed(2)}`;
}

document.getElementById('postcode').addEventListener('change', populateSlots);
updateSummary();

// Stripe
const stripe = Stripe("YOUR_STRIPE_PUBLISHABLE_KEY"); // Replace with your key

async function handlePayment(method){
  const name = document.getElementById('name').value;
  const email = document.getElementById('email').value;
  const phone = document.getElementById('phone').value;
  const address = document.getElementById('address').value;
  const suburb = document.getElementById('suburb').value;
  const postcode = document.getElementById('postcode').value;
  const state = document.getElementById('state').value;
  const deliverySlot = document.getElementById('deliverySlot').value;

  if(!name || !email || !phone || !address || !suburb || !postcode || !deliverySlot){
    alert("Please fill all required fields and select a delivery slot");
    return;
  }

  // Generate OTP for verification (testing)
  const otp = Math.floor(100000 + Math.random()*900000);
  document.getElementById('otpSection').style.display = "block";
  document.getElementById('displayOTP').textContent = `Your OTP (for testing): ${otp}`;

  const userOTP = prompt("Enter OTP to confirm payment:");
  if(parseInt(userOTP) !== otp){
    alert("OTP incorrect");
    return;
  }

  // Create PaymentIntent
  const response = await fetch('/api/create-payment-intent', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      amount: Math.round((subtotal+deliveryFee)*100),
      name,email,phone,address,suburb,postcode,state,deliverySlot,
      cart: trolley,
      method
    })
  });

  const data = await response.json();
  if(data.error){
    alert(data.error);
    return;
  }

  const result = await stripe.confirmCardPayment(data.clientSecret, {
    payment_method:{
      card:{}, // handled via Stripe Elements for real
      billing_details:{name,email}
    }
  });

  if(result.error) alert(result.error.message);
  else if(result.paymentIntent.status==='succeeded'){
    localStorage.removeItem('grocerygo_trolley');
    localStorage.removeItem('grocerygo_subtotal');
    window.location.href = "success.html";
  }
}

document.getElementById('payCard').addEventListener('click', ()=>handlePayment('card'));
document.getElementById('payApple').addEventListener('click', ()=>handlePayment('applepay'));
document.getElementById('payGoogle').addEventListener('click', ()=>handlePayment('googlepay'));
</script>
</body>
</html>
