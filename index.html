<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GroceryGo | Nepali/South Asian Grocery</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
/* --- BASE THEME STYLES --- */
:root{
  --primary-color:#DC143C; /* Crimson Red */
  --secondary-color:#003893; /* Royal Blue */
  --highlight-color:#FFD700; /* Yellow */
  --logo-grocery-color:#FF8C00; /* Deep Orange for 'Grocery' */
  --logo-trolley-color:#DC143C; /* Red for the Trolley 'G' */
  --bg-color:#f8f9fa;
  --text-color:#222;
  --border-color:#ddd;
}
*{box-sizing:border-box}
body{font-family:'Poppins',sans-serif;margin:0;background:var(--bg-color);color:var(--text-color);line-height:1.6}
/* --- STICKY HEADER & TOOLS --- */
header{background:linear-gradient(to right,var(--primary-color),var(--secondary-color));color:#fff;padding:15px 10px 5px 10px;text-align:center;
    position:sticky; 
    top:0;
    z-index:50
}

/* -------------------------------------
   NEW REALISTIC LOGO CSS IMPLEMENTATION
   ------------------------------------- */
header h1{
    margin:0 0 5px 0;
    font-size:30px;
    font-weight:900;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 60px;
    letter-spacing: -2px; /* Close up the 'Go' */
}

/* The entire "Go" container for layout */
.logo-container {
    display: flex;
    align-items: center;
    position: relative;
    padding-left: 10px; 
}

/* The 'G' that acts as the Trolley */
.logo-trolley-g {
    /* Base text properties for 'G' */
    font-size: 55px; /* Large G */
    color: white; 
    font-weight: 900;
    line-height: 1;
    position: relative;
    padding-right: 2px;
    
    /* 3D/Shading Effect for the Trolley */
    text-shadow: 
        1px 1px 0 var(--logo-trolley-color), /* Primary color shadow */
        2px 2px 2px rgba(0,0,0,0.5); /* Deep shadow for 3D depth */
    
    /* Styling for the content INSIDE the G */
    z-index: 5;
}

/* The word 'Grocery' sitting inside the 'G' Trolley */
.logo-grocery-text {
    position: absolute;
    top: -4px; 
    left: 10px; 
    font-size: 14px; 
    font-weight: 700;
    color: var(--logo-grocery-color); /* Orange color */
    letter-spacing: 0.5px;
    white-space: nowrap;
    text-shadow: 0 0 1px rgba(0,0,0,0.4);
    z-index: 10; /* Ensure it is above the 'G' */
    transform: rotate(-5deg); /* Slight angle to match the trolley shape */
    
    /* Simulate the contents being carried */
    padding: 2px 4px;
    background: rgba(255, 255, 255, 0.1); 
    border-radius: 3px;
}

/* The 'o' that completes "Go" */
.logo-o {
    font-size: 55px;
    color: white; 
    font-weight: 900;
    line-height: 1;
    text-shadow: 
        1px 1px 0 var(--logo-trolley-color), 
        2px 2px 2px rgba(0,0,0,0.5);
    /* Dynamic push/motion angle on the 'o' */
    transform: translateX(-5px) rotate(2deg); 
    position: relative;
    z-index: 5;
}
/* -------------------------------------
   END NEW LOGO CSS
   ------------------------------------- */

nav{margin-top:5px}
nav a{color:white;text-decoration:none;margin:0 10px;font-weight:600;font-size:14px;padding:5px 0;display:inline-block}
nav a:hover{text-decoration:underline}

/* DYNAMIC BANNER STYLES */
.banner{background:teal;color:white;padding:10px 0;text-align:center;font-weight:700;font-size:16px;position:relative;overflow:hidden; z-index: 49; height: 36px; /* Fixed height for cleaner transitions */}
.banner-content {
    display: flex;
    justify-content: center;
    align-items: center;
    white-space: nowrap;
    transition: opacity 0.5s, transform 0.5s;
    height: 100%; /* Ensure content fills banner height */
}
.banner-text {
    display: inline-block;
    padding-right: 15px;
}
.banner-add-btn {
    background: var(--highlight-color);
    color: var(--text-color);
    border: none;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    margin-left: 10px;
}
.banner-add-btn:hover {
    background: #FFC300;
}

.header-tools{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto;padding:5px 10px;}
.search-wrap{flex-grow:1;position:relative;margin-right:20px}
#headerSearch{width:100%;padding:8px 15px;border:none;border-radius:6px;font-size:16px;box-sizing:border-box}
#headerSearchSuggestions{border:1px solid var(--border-color);border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;background:white;position:absolute;width:100%;display:none;z-index:60;color:var(--text-color);box-shadow:0 4px 6px rgba(0,0,0,0.1);top:100%;}
#headerSearchSuggestions div{padding:8px 12px;cursor:pointer}
#headerSearchSuggestions div:hover{background:var(--highlight-color);color:#000}
#trolleyIcon{cursor:pointer;font-size:18px;font-weight:700;display:flex;align-items:center;padding:5px 10px;border:2px solid var(--highlight-color);border-radius:6px;background:rgba(255, 255, 255, 0.1);transition:background 0.2s}
#trolleyIcon:hover{background:rgba(255, 255, 255, 0.2)}
#trolleyCount{background:var(--highlight-color);color:var(--text-color);padding:1px 6px;border-radius:50%;margin-left:5px;font-size:14px;font-weight:900}
/* --- GENERAL UTILS --- */
.container{width:95%;max-width:1200px;margin:20px auto;padding:10px}
.hidden-section{display:none}
h2{color:var(--secondary-color);border-bottom:2px solid var(--primary-color);padding-bottom:5px;margin-top:20px;font-weight:600}
table{width:100%;border-collapse:collapse;margin-bottom:20px;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.1);border-radius:8px;overflow:hidden}
th,td{border:1px solid var(--border-color);padding:12px;text-align:left;vertical-align:middle}
th{background:var(--secondary-color);color:white;font-weight:600;font-size:14px}
button{background:var(--primary-color);color:white;border:none;padding:10px 15px;cursor:pointer;border-radius:6px;font-weight:600;margin-right:10px;transition:0.2s}
button:hover{background:#b10e21}
button:disabled{background:#ccc;cursor:not-allowed}
.remove-btn{background:#6c757d;padding:5px 8px;font-size:0.8em;margin-left:10px}
.remove-btn:hover{background:#dc3545}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-weight:600;margin-bottom:5px;color:var(--secondary-color)}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:4px;font-size:16px;box-sizing:border-box;transition:0.2s}
footer{background:var(--secondary-color);color:white;padding:15px;text-align:center;font-size:14px}
.promo{background:var(--highlight-color);color:#000;padding:8px 10px;border-radius:6px;cursor:pointer;margin:5px;display:inline-block;font-weight:600;animation:blink 1.5s infinite}
@keyframes blink{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
.star-btn{font-size:28px;cursor:pointer;border:none;background:none;margin:0 6px;transition:0.15s;color:#ccc}
.star-btn.shining{color:gold;}
.star-btn:hover{color:gold}

/* Custom Orange-Yellow Banner Toast (Used for real-time status updates) */
#centerToast{
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  background:rgba(0, 0, 0, 0.95); /* Black background, slightly less transparent */
  color:white;padding:25px 40px;border-radius:12px;z-index:9999;font-weight:700;display:none;min-width:300px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.4);
  font-size: 1.2em; /* Larger font for emphasis */
  animation: fadeInOut 0.5s ease-in-out;
}
@keyframes fadeInOut {
    0% { opacity: 0; transform: translate(-50%, -30%); }
    100% { opacity: 1; transform: translate(-50%, -50%); }
}

/* --- HORIZONTAL CATEGORIES STYLES --- */
.category-pill-btn {
    padding: 8px 15px;
    margin-right: 8px;
    border: 1px solid var(--secondary-color);
    border-radius: 20px;
    background: white;
    color: var(--secondary-color);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-block;
}
.category-pill-btn:hover {
    background: #e8f7ff;
}
.category-pill-btn.active {
    background: var(--secondary-color);
    color: white;
    border-color: var(--secondary-color);
}

/* --- PRODUCT GRID STYLES (Responsive) --- */
#productGrid, #featuredGrid, #popularGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
    gap: 20px;
    margin-top: 20px;
}
.product-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    text-align: center;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    min-height: 420px; 
}
.product-image-container {height: 150px;width: 100%;margin-bottom: 10px;display: flex;justify-content: center;align-items: center;}
.product-card img {max-width: 100%;max-height: 100%;border-radius: 4px;object-fit: contain;}
.product-info {flex-grow: 1;text-align: left;margin-bottom: 10px;}
.product-name {font-weight: 600;margin: 5px 0 0;font-size: 1.1em;min-height: 40px;}
.product-brand {color: #555;font-size: 0.9em;margin-bottom: 5px;display: block;}
.product-price {font-size: 1.4em;font-weight: 700;color: var(--primary-color);margin-bottom: 5px;display: block;}
.original-price {font-size: 0.8em;color: #999;text-decoration: line-through;margin-left: 5px;font-weight: 400;}
.promo-badge {position: absolute;top: 0;left: 0;background: var(--highlight-color);color: var(--text-color);padding: 5px 10px;font-size: 0.8em;font-weight: 700;border-radius: 8px 0 8px 0;z-index: 5;}
.variant-selection {display: flex;flex-wrap: wrap;gap: 5px;margin-top: 5px;min-height: 40px; justify-content: center;}
.grid-variant-btn {padding: 5px 8px;border: 1px solid #ccc;border-radius: 4px;cursor: pointer;background: #f0f0f0;font-size: 0.9em;color: #333;white-space: nowrap;transition: background 0.2s;}
.grid-variant-btn.selected {background: var(--secondary-color);color: white;border-color: var(--secondary-color);}
.add-to-cart-btn {width: 100%;margin-top: 10px;padding: 10px 12px; border-radius: 8px; font-size: 1.1em;}

/* --- CHECKOUT/MODAL/STATUS STYLES --- */
.slot-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.slot{padding:6px 8px;border:1px solid #ccc;border-radius:4px;cursor:pointer;background:white; text-align: center; line-height: 1.2;}
.slot.selected{background:#e8f7ff;border-color:#91d5ff}
#feedbackPopup, #confirmAddModal, #confirmPromoModal, #confirmCancelModal, #confirmClearTrolleyModal{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:white;padding:20px;border-radius:8px;box-shadow:0 3px 6px rgba(0,0,0,0.2);z-index:120;width:90%;max-width:400px;text-align:center
}
#starContainer{display:flex;justify-content:center;margin:8px 0}
#otpModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0, 0, 0, 0.5);z-index:1000;align-items:center;justify-content:center}
.otp-content{background:white;padding:30px;border-radius:8px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.2);text-align:center;width:90%;max-width:350px;}
.otp-code{font-size: 1.5em;font-weight: 700;color: var(--primary-color);margin: 10px 0;padding: 5px;border: 1px dashed var(--highlight-color);display: inline-block;}
#trolleySubtotal {
    text-align: right;
    font-size: 1.2em;
    margin-bottom: 2px;
    padding: 10px 12px; 
    border-top: 1px solid var(--border-color);
    background: #f0f0f0; 
}
#orderStatusContent {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
.status-update {
    padding: 10px;
    border-left: 3px solid var(--secondary-color);
    margin-bottom: 10px;
    background: #e8f7ff;
    border-radius: 4px;
    font-size: 0.95em;
}
</style>
</head>
<body>

<header>
  <h1>
    <div class="logo-container">
      <span class="logo-trolley-g">G
        <span class="logo-grocery-text">Grocery</span>
      </span>
      <span class="logo-o">o</span>
    </div>
  </h1> 
  <nav>
    <a href="#" onclick="showPage('home'); return false;">HOME</a>
    <a href="#" onclick="showPage('store'); return false;">STORE</a>
    <a href="#" onclick="showPage('orderStatus'); return false;" id="navOrderStatus" class="hidden-section">ORDER STATUS</a>
    <a href="#" onclick="showPage('about'); return false;">ABOUT US</a>
    <a href="#" onclick="showPage('contact'); return false;">CONTACT</a>
  </nav>
  <div class="header-tools">
    <div class="search-wrap">
      <input type="text" id="headerSearch" placeholder="🔍 Search (e.g., 'rice', 'MDH')...">
      <div id="headerSearchSuggestions"></div>
    </div>
    <div id="trolleyIcon" onclick="showPage('store')">
      🛒 <span id="trolleyCount">0</span>
    </div>
  </div>
  <div class="banner">
      <div id="dynamicBannerContent" class="banner-content">
          <span id="dynamicBannerText" class="banner-text"></span>
          </div>
  </div>
</header>

<div class="container">

  <section id="homeContent">
    <h2>Welcome to GroceryGo!</h2>
    <p>Discover the best Nepali & South Asian groceries with multiple brands and sizes. <span class="splash-text">New stock just arrived!</span></p>
    
    <h3>✨ Featured Products</h3>
    <div id="featuredGrid"></div>
    
    <h3>🔥 Hot Deals This Week - Click to Add Directly!</h3>
    <div id="homepagePromos" style="text-align:center;"></div>
    
    <div style="text-align:center;margin-top:15px">
      <button onclick="showPage('store')">🛒 View All Products</button>
    </div>
  </section>

  <section id="storeContent" class="hidden-section">
    <div id="horizontal-categories-container" style="overflow-x: auto; white-space: nowrap; padding: 10px 0; border-bottom: 1px solid var(--border-color); margin-top: -10px;">
        </div>

    <h2>✨ Very Popular Items</h2>
    <div id="popularGrid"></div>

    <h2>All Products</h2>
    <div id="productGrid"></div>
    
    <p class="trolleyNote" style="margin-top:20px;">Your trolley items:</p>
    
    <h2>Your Trolley</h2>
    <table id="trolleyTable">
      <thead><tr><th>Item</th><th>Brand & Variant</th><th>Quantity</th><th>Subtotal (AUD $)</th></tr></thead>
      <tbody></tbody>
    </table>

    <div id="trolleySubtotal"><b>Subtotal: $0.00</b></div>
    <div style="text-align:right;margin-bottom:10px;"><small>Delivery fee calculated at checkout</small></div>

    <div style="text-align:center;margin-top:10px;">
      <button id="clearTrolley" onclick="showConfirmClearTrolleyModal()">🗑️ Clear Trolley</button>
      <button id="placeOrder">💳 Proceed to Checkout</button>
    </div>
  </section>
  
  <section id="orderStatusContent" class="hidden-section">
    <h2>Order Status: <span id="currentOrderStatus"></span></h2>
    <div id="orderStatusSummary" style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;"></div>
    <div id="statusTimeline"></div>
    <button id="cancelOrderBtn" onclick="showConfirmCancelModal()">❌ Cancel Order</button>
  </section>

  <section id="checkoutForm" class="hidden-section">
    <h2>Checkout</h2>
    <div class="form-group"><label for="custName">Full Name</label><input id="custName" placeholder="John Citizen" value="Test Customer"></div>
    <div class="form-group"><label for="custEmail">Email</label><input id="custEmail" placeholder="example@gmail.com" value="test@grocerygo.com"></div>
    <div class="form-group"><label for="custMobile">Mobile Number</label><input id="custMobile" maxlength="10" placeholder="04XXXXXXXX" value="0412345678"></div>
    <div class="form-group"><label for="address">Your Delivery Address</label><input id="address" placeholder="123 Main St" value="123 Example Street"></div>
    <div class="form-group"><label for="suburb">Suburb</label><input id="suburb" placeholder="South Brisbane" value="Ormeau"></div>
    <div class="form-group"><label for="stateSelect">State/Territory</label>
      <select id="stateSelect">
        <option value="">Select State</option><option selected>QLD</option><option>NSW</option><option>VIC</option><option>SA</option><option>WA</option><option>TAS</option><option>NT</option><option>ACT</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="postcode">Postcode</label>
      <input id="postcode" maxlength="4" placeholder="4000" value="4205">
      <div id="postcodeNote" class="note-small" style="color:red; font-weight:600; min-height:16px;">Enter postcode to check serviceability.</div>
    </div>

    <div class="form-group">
      <label><strong>Preferred delivery date & time slot</strong></label>
      <div id="deliveryTimes" class="slot-grid"></div>
      <div class="note-small">Delivery available Mon–Sat. Slots generated based on postcode.</div>
    </div>

    <div class="form-group"><label for="cardNumber">Card Number</label><input id="cardNumber" maxlength="16" placeholder="1234 5678 9012 3456" value="1234567890123456"></div>
    <div class="form-group"><label for="cardExpiry">Expiry (MM/YY)</label><input id="cardExpiry" maxlength="5" placeholder="MM/YY" value="12/28"></div>
    <div class="form-group"><label for="cardCVV">CVV</label><input id="cardCVV" maxlength="3" placeholder="123" value="123"></div>
    <div class="form-group"><label for="specialInstructions">Special Instructions</label><textarea id="specialInstructions" placeholder="E.g., leave at front door, gate code, or please call when you arrive, etc."></textarea></div>
    
    <div id="checkoutTotals" style="text-align:right; margin-top:20px; padding-top:10px; border-top:1px dashed #ccc;">
        <div id="checkoutSubtotal" style="font-size:1em;">Subtotal: $0.00</div>
        <div id="checkoutDelivery" style="font-size:1em;">Delivery Fee: $0.00</div>
        <div id="checkoutGrandTotal" style="font-size:1.5em; font-weight:700; color:var(--secondary-color); margin-top:5px;">Grand Total: $0.00</div>
    </div>

    <div style="text-align:center;margin-top:20px;">
      <button onclick="showPage('store')">◀️ Back to Trolley</button>
      <button id="checkoutPayBtn" onclick="preProcessCheckout()">Place Order & Pay</button>
    </div>
  </section>

  <section id="aboutContent" class="hidden-section"><h2>About Us</h2><p>GroceryGo delivers premium Nepali & South Asian groceries to your doorstep. Fresh, high-quality products with multiple brands and sizes. Weekly deals, promotions, and a seamless online shopping experience!</p></section>
  <section id="contactContent" class="hidden-section"><h2>Contact Us</p><p>Email: support@grocerygo.com</p><p>Phone: +61 412 345 678</p><p>Address: Brisbane Convention & Exhibition Centre, Merivale St, South Brisbane QLD 4101, Australia</p></section>

  <div id="confirmAddModal">
    <h3>Add to Trolley Confirmation</h3>
    <div id="confirmAddContent"></div>
    <div class="form-group" style="margin-top: 15px;">
        <label for="modalQuantity" style="color:#222;">Quantity:</label>
        <input type="number" id="modalQuantity" value="1" min="1" style="width: 80px; display: inline-block; padding: 5px;">
    </div>
    <div id="modalVariantContainer" class="variant-selection" style="justify-content:center;"></div>
    <button style="margin-top:15px;" id="confirmModalAddBtn">✅ Confirm Add</button>
    <button style="background:#6c757d;" onclick="document.getElementById('confirmAddModal').style.display='none'">Cancel</button>
  </div>
  
  <div id="confirmPromoModal">
    <h3>Confirm Hot Deal</h3>
    <div id="promoConfirmContent"></div>
    <p>Are you sure you want to add this hot deal to your trolley?</p>
    <button style="margin-top:15px;" id="confirmPromoAddBtn">✅ Yes, Add</button>
    <button style="background:#6c757d;" onclick="document.getElementById('confirmPromoModal').style.display='none'">Cancel</button>
  </div>

  <div id="confirmCancelModal">
    <h3>Cancel Order</h3>
    <div id="cancelConfirmationMessage"></div>
    <p>Are you sure you want to cancel Order #<span id="cancelOrderId"></span>?</p>
    <button style="margin-top:15px;" id="confirmCancelBtn">✅ Confirm Cancellation</button>
    <button style="background:#6c757d;" onclick="document.getElementById('confirmCancelModal').style.display='none'">No, Keep Order</button>
  </div>

  <div id="confirmClearTrolleyModal">
    <h3>Clear Trolley Confirmation</h3>
    <p>Are you sure you want to **clear all items** from your trolley? This action cannot be undone.</p>
    <button style="margin-top:15px; background: #DC143C;" id="confirmClearTrolleyBtn">⚠️ Yes, Clear Trolley</button>
    <button style="background:#6c757d;" onclick="document.getElementById('confirmClearTrolleyModal').style.display='none'">No, Keep Items</button>
  </div>

  <div id="feedbackPopup">
    <h3>How did we do today?</h3>
    <div id="starContainer"></div>
    <select id="feedbackReason" style="margin-top:10px;width:100%;padding:8px;border-radius:4px;"><option value="0">Select Reason (optional)</option></select>
    <textarea id="feedbackCustom" placeholder="Or write your own..." style="width:100%;margin-top:5px;padding:8px;border-radius:4px;"></textarea>
    <button style="margin-top:10px;" onclick="submitFeedback()">Submit Feedback</button>
  </div>
  
  <div id="otpModal">
      <div class="otp-content">
          <h3>Verify Payment</h3>
          <p>Please enter the 4-digit OTP sent to your mobile and email.</p>
          <div style="font-size:0.9em; margin-bottom:10px;">For testing, the code is: <span id="testOtpCode" class="otp-code">0000</span></div>
          <input type="text" id="otpInput" maxlength="4" placeholder="XXXX" />
          <button onclick="verifyOTP()">Verify Code</button>
          <button style="background:#6c757d;" onclick="document.getElementById('otpModal').style.display='none'; showCenterToast('Payment verification cancelled.')">Cancel</button>
      </div>
  </div>

</div>

<footer>© 2025 GroceryGo. All rights reserved.</footer>

<div id="centerToast" role="status" aria-live="polite"></div>

<script>
/* -------------------------
  DATA & STATE (Retained from previous version)
--------------------------*/

const products = [
  // RICE AND GRAINS
  {id:1,name:"Daawat Basmati Rice",brand:"Daawat",category:"Rice and Grains",featured:true, popular:true, variants:[{size:"1kg",price:6.99,originalPrice:7.99,promo:false,img:"https://via.placeholder.com/200x150?text=Daawat+Basmati+1kg"},{size:"5kg",price:25.99,originalPrice:28.99,promo:true,img:"https://via.placeholder.com/200x150?text=Daawat+Basmati+5kg"}], promoBadge: 'Hot Deal', featuredVariantSize: "5kg"}, 
  {id:2,name:"Nepali Taichin Rice",brand:"Nepali Choice",category:"Rice and Grains",featured:true, popular:false, variants:[{size:"1kg",price:4.99,originalPrice:5.99,promo:true,img:"https://via.placeholder.com/200x150?text=Taichin+Rice+1kg"},{size:"5kg",price:23.99,originalPrice:23.99,promo:false,img:"https://via.placeholder.com/200x150?text=Taichin+Rice+5kg"}], promoBadge: 'New Arrived', featuredVariantSize: "1kg"},
  {id:3,name:"Sona Masoori Rice",brand:"India Gate",category:"Rice and Grains",featured:false, popular:true, variants:[{size:"5kg",price:20.99,originalPrice:20.99,promo:false,img:"https://via.placeholder.com/200x150?text=Sona+Masoori+5kg"},{size:"10kg",price:38.99,originalPrice:42.99,promo:true,img:"https://via.placeholder.com/200x150?text=Sona+Masoori+10kg"}], promoBadge: 'Hot Deal', featuredVariantSize: "10kg"},
  {id:19,name:"Poha (Flattened Rice)",brand:"Haldiram's",category:"Rice and Grains",featured:false, popular:false, variants:[{size:"500g",price:3.99,originalPrice:3.99,promo:false,img:"https://via.placeholder.com/200x150?text=Poha+500g"}], promoBadge: 'New Arrived', featuredVariantSize: "500g"},

  // PULSES
  {id:4,name:"Chana Dal (Split Chickpeas)",brand:"Lal Qilla",category:"Pulses",featured:true, popular:true, variants:[{size:"500g",price:3.50,originalPrice:3.50,promo:false,img:"https://via.placeholder.com/200x150?text=Chana+Dal+500g"},{size:"1kg",price:6.50,originalPrice:6.99,promo:true,img:"https://via.placeholder.com/200x150?text=Chana+Dal+1kg"}], promoBadge: 'Hot Deal', featuredVariantSize: "1kg"},
  {id:5,name:"Masoor Dal (Red Lentils)",brand:"Organic Life",category:"Pulses",featured:true, popular:false, variants:[{size:"500g",price:3.99,originalPrice:3.99,promo:false,img:"https://via.placeholder.com/200x150?text=Masoor+Dal+500g"},{size:"1kg",price:7.50,originalPrice:7.99,promo:true,img:"https://via.placeholder.com/200x150?text=Masoor+Dal+1kg"}], promoBadge: 'New Arrived', featuredVariantSize: "1kg"},
  {id:16,name:"Toor Dal (Pigeon Peas)",brand:"Moti",category:"Pulses",featured:false, popular:false, variants:[{size:"1kg",price:5.99,originalPrice:6.50,promo:true,img:"https://via.placeholder.com/200x150?text=Toor+Dal+1kg"},{size:"5kg",price:27.50,originalPrice:27.50,promo:false,img:"https://via.placeholder.com/200x150?text=Toor+Dal+5kg"}], promoBadge: 'Hot Deal', featuredVariantSize: "1kg"},
  {id:20,name:"Urad Dal (Black Gram)",brand:"Shakti",category:"Pulses",featured:false, popular:false, variants:[{size:"1kg",price:7.99,originalPrice:7.99,promo:false,img:"https://via.placeholder.com/200x150?text=Urad+Dal+1kg"}], promoBadge: 'New Arrived', featuredVariantSize: "1kg"},

  // FLOUR
  {id:6,name:"Whole Wheat Atta",brand:"Aashirvaad",category:"Flour",featured:false, popular:true, variants:[{size:"5kg",price:10.99,originalPrice:10.99,promo:false,img:"https://via.placeholder.com/200x150?text=Aashirvaad+Atta+5kg"},{size:"10kg",price:20.99,originalPrice:22.99,promo:true,img:"https://via.placeholder.com/200x150?text=Aashirvaad+Atta+10kg"}], promoBadge: 'Hot Deal', featuredVariantSize: "10kg"},
  {id:7,name:"Besan (Gram Flour)",brand:"Laxmi",category:"Flour",featured:false, popular:false, variants:[{size:"1kg",price:5.50,originalPrice:5.50,promo:false,img:"https://via.placeholder.com/200x150?text=Laxmi+Besan+1kg"}], promoBadge: 'Authentic', featuredVariantSize: "1kg"},
  {id:21,name:"Maida (All-Purpose Flour)",brand:"Pillsbury",category:"Flour",featured:false, popular:false, variants:[{size:"1kg",price:3.99,originalPrice:3.99,promo:false,img:"https://via.placeholder.com/200x150?text=Maida+1kg"}], promoBadge: 'New Arrived', featuredVariantSize: "1kg"},

  // SPICES AND MASALAS
  {id:8,name:"Garam Masala Powder",brand:"MDH",category:"Spices and Masalas",featured:false, popular:true, variants:[{size:"100g",price:3.99,originalPrice:3.99,promo:false,img:"https://via.placeholder.com/200x150?text=MDH+Garam+Masala+100g"},{size:"200g",price:7.50,originalPrice:8.99,promo:true,img:"https://via.placeholder.com/200x150?text=MDH+Garam+Masala+200g"}], promoBadge: 'Hot Deal', featuredVariantSize: "200g"},
  {id:9,name:"Turmeric Powder",brand:"Everest",category:"Spices and Masalas",featured:false, popular:false, variants:[{size:"100g",price:2.99,originalPrice:2.99,promo:false,img:"https://via.placeholder.com/200x150?text=Everest+Turmeric+100g"}], promoBadge: 'Authentic', featuredVariantSize: "100g"},
  {id:17,name:"Kashmiri Chilli Powder",brand:"Rajah",category:"Spices and Masalas",featured:false, popular:false, variants:[{size:"100g",price:4.50,originalPrice:4.50,promo:false,img:"https://via.placeholder.com/200x150?text=Rajah+Chilli+100g"}], promoBadge: 'New Arrived', featuredVariantSize: "100g"},
  {id:22,name:"Cumin Seeds (Jeera)",brand:"Shan",category:"Spices and Masalas",featured:false, popular:true, variants:[{size:"200g",price:4.99,originalPrice:4.99,promo:false,img:"https://via.placeholder.com/200x150?text=Cumin+Seeds+200g"}], promoBadge: 'Authentic', featuredVariantSize: "200g"},

  // OILS AND GHEE
  {id:10,name:"Mustard Oil (Kachi Ghani)",brand:"Fortune",category:"Oils and Ghee",featured:true, popular:true, variants:[{size:"500ml",price:6.99,originalPrice:6.99,promo:false,img:"https://via.placeholder.com/200x150?text=Mustard+Oil+500ml"},{size:"1L",price:12.99,originalPrice:14.99,promo:true,img:"https://via.placeholder.com/200x150?text=Mustard+Oil+1L"}], promoBadge: 'Hot Deal', featuredVariantSize: "1L"},
  {id:11,name:"Amul Ghee",brand:"Amul",category:"Oils and Ghee",featured:false, popular:false, variants:[{size:"500ml",price:10.99,originalPrice:10.99,promo:false,img:"https://via.placeholder.com/200x150?text=Amul+Ghee+500ml"},{size:"1L",price:21.99,originalPrice:21.99,promo:false,img:"https://via.placeholder.com/200x150?text=Amul+Ghee+1L"}], promoBadge: 'Authentic', featuredVariantSize: "500ml"},
  {id:18,name:"Soybean Oil",brand:"Saffola",category:"Oils and Ghee",featured:false, popular:false, variants:[{size:"1L",price:5.50,originalPrice:5.50,promo:false,img:"https://via.placeholder.com/200x150?text=Saffola+Oil+1L"},{size:"2L",price:9.99,originalPrice:10.99,promo:true,img:"https://via.placeholder.com/200x150?text=Saffola+Oil+2L"}], promoBadge: 'Hot Deal', featuredVariantSize: "2L"},
  {id:23,name:"Sesame Oil",brand:"Tilsona",category:"Oils and Ghee",featured:true, popular:false, variants:[{size:"500ml",price:8.99,originalPrice:8.99,promo:false,img:"https://via.placeholder.com/200x150?text=Sesame+Oil+500ml"}], promoBadge: 'Authentic', featuredVariantSize: "500ml"},

  // SNACKS AND CEREALS
  {id:12,name:"Wai Wai Instant Noodles",brand:"Wai Wai",category:"Snacks and Cereals",featured:false, popular:true, variants:[{size:"Single Pack",price:1.50,originalPrice:1.50,promo:false,img:"https://via.placeholder.com/200x150?text=Wai+Wai+Single"},{size:"Box (30)",price:39.99,originalPrice:45.00,promo:true,img:"https://via.placeholder.com/200x150?text=Wai+Wai+Box"}], promoBadge: 'Hot Deal', featuredVariantSize: "Box (30)"},
  {id:13,name:"Aloo Bhujia",brand:"Haldiram's",category:"Snacks and Cereals",featured:false, popular:false, variants:[{size:"200g",price:3.50,originalPrice:3.50,promo:false,img:"https://via.placeholder.com/200x150?text=Aloo+Bhujia+200g"},{size:"1kg",price:15.00,originalPrice:16.99,promo:true,img:"https://via.placeholder.com/200x150?text=Aloo+Bhujia+1kg"}], promoBadge: 'Hot Deal', featuredVariantSize: "1kg"},
  {id:24,name:"Parle-G Biscuits",brand:"Parle",category:"Snacks and Cereals",featured:false, popular:true, variants:[{size:"Small Pack",price:1.00,originalPrice:1.00,promo:false,img:"https://via.placeholder.com/200x150?text=Parle-G+Small"},{size:"Mega Pack",price:4.50,originalPrice:4.50,promo:false,img:"https://via.placeholder.com/200x150?text=Parle-G+Mega"}], promoBadge: 'New Arrived', featuredVariantSize: "Mega Pack"},

  // DAIRY/MEAT (FROZEN/FRESH)
  {id:14,name:"Paneer (Indian Cottage Cheese)",brand:"Fresh Foods",category:"Dairy/Meat",featured:false, popular:false, variants:[{size:"500g",price:8.99,originalPrice:8.99,promo:false,img:"https://via.placeholder.com/200x150?text=Fresh+Paneer+500g"},{size:"1kg",price:16.99,originalPrice:16.99,promo:false,img:"https://via.placeholder.com/200x150?text=Fresh+Paneer+1kg"}], promoBadge: 'Authentic', featuredVariantSize: "1kg"},
  {id:15,name:"Frozen Chicken Seekh Kebab",brand:"Shana",category:"Dairy/Meat",featured:false, popular:false, variants:[{size:"500g",price:9.99,originalPrice:9.99,promo:false,img:"https://via.placeholder.com/200x150?text=Frozen+Kebab+500g"}], promoBadge: 'New Arrived', featuredVariantSize: "500g"},
  {id:25,name:"Yoghurt (Dahi)",brand:"Amul",category:"Dairy/Meat",featured:false, popular:false, variants:[{size:"1kg Tub",price:3.99,originalPrice:3.99,promo:false,img:"https://via.placeholder.com/200x150?text=Amul+Yoghurt+1kg"}], promoBadge: 'Authentic', featuredVariantSize: "1kg Tub"},
]; 

// Define the badges for dynamic banner
const bannerBadges = [
    { text: "Featured: Daawat Basmati Rice 5kg", color: "#DC143C", type: 'product', id: 1, size: "5kg" },
    { text: "New Arrival: Nepali Taichin Rice 1kg - Try Now!", color: "#003893", type: 'product', id: 2, size: "1kg" },
    { text: "Authentic: Amul Ghee - Classic Taste!", color: "#FFD700", type: 'general' },
    { text: "Hot Deal: Whole Wheat Atta 10kg - Save Big!", color: "#DC143C", type: 'product', id: 6, size: "10kg" },
    { text: "Featured: Fortune Mustard Oil 1L", color: "#003893", type: 'product', id: 10, size: "1L" },
    { text: "Authentic: Shan Cumin Seeds - Freshly Ground!", color: "#FFD700", type: 'product', id: 22, size: "200g" },
    { text: "New Arrival: Frozen Chicken Seekh Kebab!", color: "#003893", type: 'product', id: 15, size: "500g" },
];

let trolley = JSON.parse(localStorage.getItem('trolley')) || [];
let selectedSlot = null;
let currentRating = 0; 
let currentProductIdForModal = null; 
let currentSearchQuery = ''; 
let currentCategoryFilter = ''; 

let currentOrder = JSON.parse(localStorage.getItem('currentOrder')) || null;
let currentOrderStatus = currentOrder ? currentOrder.status : 'N/A';
const orderStatuses = ["Confirmed", "Packed", "Out for Delivery", "Arrived"];

// Delivery Rules (Extensive SEQ Postcodes - Including 4205)
const deliveryRules = { 
    // Brisbane Metro ($5.00) - BRISBANE COUNCIL
    '4000': { fee: 5.00, available: true }, '4005': { fee: 5.00, available: true }, '4006': { fee: 5.00, available: true }, '4030': { fee: 5.00, available: true }, '4031': { fee: 5.00, available: true }, '4034': { fee: 5.00, available: true }, '4051': { fee: 5.00, available: true }, '4064': { fee: 5.00, available: true }, '4068': { fee: 5.00, available: true }, '4077': { fee: 5.00, available: true }, '4101': { fee: 5.00, available: true }, '4103': { fee: 5.00, available: true }, '4109': { fee: 5.00, available: true }, '4113': { fee: 5.00, available: true }, '4120': { fee: 5.00, available: true }, '4122': { fee: 5.00, available: true }, '4152': { fee: 5.00, available: true }, '4157': { fee: 5.00, available: true }, '4170': { fee: 5.00, available: true }, '4178': { fee: 5.00, available: true },
    
    // SEQ Fringe ($10.00) - LOGAN, IPSWICH, REDLAND, MORETON BAY COUNCILS + BRISBANE OUTER
    '4114': { fee: 10.00, available: true }, '4118': { fee: 10.00, available: true }, '4127': { fee: 10.00, available: true }, '4128': { fee: 10.00, available: true }, '4132': { fee: 10.00, available: true }, // Logan
    '4205': { fee: 10.00, available: true }, '4207': { fee: 10.00, available: true }, '4280': { fee: 10.00, available: true }, // Logan South / Gold Coast North
    '4300': { fee: 10.00, available: true }, '4301': { fee: 10.00, available: true }, '4305': { fee: 10.00, available: true }, // Ipswich
    '4500': { fee: 10.00, available: true }, '4503': { fee: 10.00, available: true }, '4509': { fee: 10.00, available: true }, '4510': { fee: 10.00, available: true }, // Moreton Bay
    '4163': { fee: 10.00, available: true }, '4164': { fee: 10.00, available: true }, '4165': { fee: 10.00, available: true }, // Redlands
    
    // Default/Unavailable 
    '4214': { fee: 0.00, available: false },
    '0000': { fee: 0.00, available: false } 
};

const feedbackReasons = {
    5: ["Excellent Service", "Great Value", "Quality Products"],
    4: ["Good Experience", "Met Expectations"],
    3: ["Average", "Minor Issue"],
    2: ["Shipping Delay", "Damaged Packaging"],
    1: ["Missing Item", "Poor Product Quality"]
};

/* -------------------------
  CORE UTILITY FUNCTIONS
--------------------------*/

function showPage(pageId) {
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
    document.getElementById('navOrderStatus').classList.toggle('hidden-section', !currentOrder);

    const content = document.getElementById(pageId + 'Content');
    if (content) {
        content.classList.remove('hidden-section');
    } else if (pageId === 'store') {
        document.getElementById('storeContent').classList.remove('hidden-section');
        renderStorePage(); // Calls renderHorizontalCategories and renders all products
    } else if (pageId === 'checkout') {
        if (trolley.length === 0) {
            showCenterToast("Trolley is empty. Add items first!", true);
            return;
        }
        document.getElementById('checkoutForm').classList.remove('hidden-section');
        updateCheckoutTotals(); 
        const postcode = document.getElementById('postcode').value;
        if (postcode.length === 4) generateDeliverySlots(postcode);
    } else if (pageId === 'home') {
        document.getElementById('homeContent').classList.remove('hidden-section');
        renderHomepageFeatures();
        renderHomepagePromos();
    } else if (pageId === 'orderStatus') {
        if (currentOrder) {
            document.getElementById('orderStatusContent').classList.remove('hidden-section');
            renderOrderStatus();
        } else {
            showCenterToast("No active order found.", true);
            showPage('home');
        }
    }
}

// REAL-TIME STATUS TOAST (Centralized Pop-up)
function showCenterToast(message, isError = false) {
    const toast = document.getElementById('centerToast');
    toast.innerHTML = isError ? `⚠️ ${message}` : message;
    
    toast.style.display = 'block';
    
    // Fade out after 3 seconds
    setTimeout(() => { 
        toast.style.opacity = '0'; 
        setTimeout(() => {
            toast.style.display = 'none';
            toast.style.opacity = '1'; // Reset opacity for next appearance
        }, 500); // Wait for fade-out transition
    }, 3000);
}

// SIMULATED COMMS FUNCTION
function sendComms(type, orderId, mobile, email, message) {
    // SMS Simulation (Mobile)
    console.log(`[SMS Sent to ${mobile}] Order ${orderId}: ${message}`);
    // Email Simulation (Email)
    console.log(`[Email Sent to ${email}] Order ${orderId}: ${message}`);
}

function calculateTrolleyTotal() {
    return trolley.reduce((total, item) => total + (item.price * item.quantity), 0);
}

function updateTotals() {
    const total = calculateTrolleyTotal();
    document.getElementById('trolleySubtotal').innerHTML = `<b>Subtotal: $${total.toFixed(2)}</b>`;
}

function updateTrolleyCount() {
    const totalCount = trolley.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('trolleyCount').textContent = totalCount;
    localStorage.setItem('trolley', JSON.stringify(trolley));
}

// NEW FUNCTION: Show Clear Trolley Confirmation Modal
function showConfirmClearTrolleyModal() {
    if (trolley.length === 0) {
        showCenterToast("Trolley is already empty.", false);
        return;
    }
    document.getElementById('confirmClearTrolleyModal').style.display = 'block';
}

// NEW FUNCTION: Actual Clear Trolley Logic
document.getElementById('confirmClearTrolleyBtn').addEventListener('click', () => {
    document.getElementById('confirmClearTrolleyModal').style.display = 'none';
    trolley = [];
    updateTrolleyCount();
    renderTrolley();
    showCenterToast("🗑️ Trolley has been successfully cleared.");
});


document.getElementById('placeOrder').addEventListener('click', () => {
    if (trolley.length === 0) {
        showCenterToast("Your trolley is empty! Add items first.", true);
        return;
    }
    showPage('checkout');
});

/* -------------------------
  PRODUCT GRID & TROLLEY
--------------------------*/

function renderStorePage() {
    // 1. Render Horizontal Categories and ensure the correct pill is active
    renderHorizontalCategories();
    
    // 2. Render Popular Items Grid (filtered only by search query)
    renderProductGrid(currentSearchQuery, 'popularGrid', '', true); 
    
    // 3. Render All Products Grid (filtered by category OR search)
    renderProductGrid(currentSearchQuery, 'productGrid', currentCategoryFilter);

    // 4. Render Trolley
    renderTrolley();
}

function renderHorizontalCategories() {
    const container = document.getElementById('horizontal-categories-container');
    container.innerHTML = '';
    
    const categories = ['All Products', ...new Set(products.map(p => p.category))].sort();

    categories.forEach(cat => {
        const button = document.createElement('button');
        button.className = 'category-pill-btn';
        button.textContent = cat;
        button.dataset.category = cat === 'All Products' ? '' : cat;
        
        // Logic to make the 'All Products' button active when the store page loads 
        // AND no search filter is active.
        const isActive = (cat === 'All Products' && currentCategoryFilter === '' && currentSearchQuery === '') || (cat === currentCategoryFilter && currentSearchQuery === '');
        if (isActive) {
            button.classList.add('active');
        }

        button.onclick = function() {
            document.querySelectorAll('.category-pill-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentCategoryFilter = this.dataset.category; // Set the new active category
            currentSearchQuery = ''; // Clear search when selecting a category
            document.getElementById('headerSearch').value = '';

            // Re-render the grids based on the selected category
            renderProductGrid(currentSearchQuery, 'popularGrid', '', true);
            renderProductGrid(currentSearchQuery, 'productGrid', currentCategoryFilter);
        };
        container.appendChild(button);
    });
}

function renderProductGrid(filter = '', targetId = 'productGrid', category = '', popularOnly = false) {
    const grid = document.getElementById(targetId);
    grid.innerHTML = '';
    const filterQuery = filter.toLowerCase();

    let filteredProducts = products.filter(p => 
        (p.name.toLowerCase().includes(filterQuery) || 
        p.brand.toLowerCase().includes(filterQuery) ||
        p.category.toLowerCase().includes(filterQuery))
    );
    
    // Apply Popularity Filter
    if (popularOnly) {
        filteredProducts = filteredProducts.filter(p => p.popular);
    }

    // Apply Category Filter (only to the main grid, and only if no search is active)
    if (targetId === 'productGrid' && category !== '' && filterQuery === '') {
        filteredProducts = filteredProducts.filter(p => p.category === category);
    }
    
    // Filter out popular items from the main grid if they were already displayed above AND no search is active
    if (targetId === 'productGrid' && filterQuery === '') {
        // Get IDs of items in the popular grid (so we don't duplicate them in the main grid)
        const popularIds = products.filter(p => p.popular).map(p => p.id);
        filteredProducts = filteredProducts.filter(p => !popularIds.includes(p.id));
    }
    
    // If no products found after filtering, show a message
    if (filteredProducts.length === 0) {
        grid.innerHTML = popularOnly 
            ? '<p style="text-align:center; color:#555;">No current popular deals matching your filter.</p>'
            : '<p style="text-align:center; color:#555;">No products found matching your search or in this category.</p>';
        return;
    }


    filteredProducts.forEach(product => {
        // Use featuredVariantSize if available, otherwise find promo or use the first variant
        let selectedVariant = product.variants.find(v => v.size === product.featuredVariantSize) || 
                              product.variants.find(v => v.promo) || 
                              product.variants[0];

        const variantButtons = product.variants.map(v => `
            <span 
                class="grid-variant-btn ${v.size === selectedVariant.size ? 'selected' : ''}" 
                data-size="${v.size}" 
                data-price="${v.price}"
                data-original-price="${v.originalPrice}"
                data-promo="${v.promo}"
                onclick="selectVariant(this, ${product.id})"
            >
                ${v.size}
            </span>
        `).join('');

        const priceDisplay = selectedVariant.promo && selectedVariant.originalPrice > selectedVariant.price ? 
            `<span class="product-price">$${selectedVariant.price.toFixed(2)} <span class="original-price">$${selectedVariant.originalPrice.toFixed(2)}</span></span>` :
            `<span class="product-price">$${selectedVariant.price.toFixed(2)}</span>`;

        const card = document.createElement('div');
        card.className = 'product-card';
        card.setAttribute('data-product-id', product.id);
        card.innerHTML = `
            ${product.promoBadge ? `<div class="promo-badge">${product.promoBadge}</div>` : ''}
            <div class="product-image-container"><img src="${selectedVariant.img}" alt="${product.name}"></div>
            <div class="product-info">
                <span class="product-brand">${product.brand}</span>
                <h3 class="product-name">${product.name}</h3>
                <div class="price-display">${priceDisplay}</div>
            </div>
            <div class="variant-selection">${variantButtons}</div>
            <button class="add-to-cart-btn" onclick="showConfirmAddModal(${product.id})">➕ Add to Trolley</button>
        `;
        grid.appendChild(card);
    });
}

function selectVariant(button, productId) {
    const card = button.closest('.product-card') || document.getElementById('modalVariantContainer').closest('#confirmAddModal');
    
    const variantContainer = card.querySelector('.variant-selection') || document.getElementById('modalVariantContainer');
    variantContainer.querySelectorAll('.grid-variant-btn').forEach(btn => btn.classList.remove('selected'));
    button.classList.add('selected');

    if (card.classList.contains('product-card')) {
        const priceDiv = card.querySelector('.price-display');
        const newPrice = parseFloat(button.dataset.price);
        const originalPrice = parseFloat(button.dataset.originalPrice);
        const isPromo = button.dataset.promo === 'true';

        let priceHtml = '';
        if (isPromo && originalPrice > newPrice) {
            priceHtml = `<span class="product-price">$${newPrice.toFixed(2)} <span class="original-price">$${originalPrice.toFixed(2)}</span></span>`;
        } else {
            priceHtml = `<span class="product-price">$${newPrice.toFixed(2)}</span>`;
        }
        priceDiv.innerHTML = priceHtml;
    }
}

function renderTrolley() {
    const tbody = document.getElementById('trolleyTable').querySelector('tbody');
    tbody.innerHTML = '';

    if (trolley.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Your trolley is empty.</td></tr>';
    }

    trolley.forEach((item, index) => {
        const subtotal = item.price * item.quantity;
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.brand} - ${item.variantSize}</td>
            <td>
                <input type="number" value="${item.quantity}" min="1" style="width:60px;padding:4px;" 
                       onchange="updateTrolleyQuantity(${index}, this.value)">
                <button class="remove-btn" onclick="removeItemFromTrolley(${index})">X</button>
            </td>
            <td>$${subtotal.toFixed(2)}</td>
        `;
    });

    updateTotals();
}

function updateTrolleyQuantity(index, newQuantity) {
    const quantity = parseInt(newQuantity);
    if (quantity > 0) {
        trolley[index].quantity = quantity;
        showCenterToast(`🛒 Updated quantity of ${trolley[index].name}.`);
    } else {
        removeItemFromTrolley(index);
    }
    updateTrolleyCount();
    renderTrolley();
}

function removeItemFromTrolley(index) {
    const removedItemName = trolley[index].name;
    trolley.splice(index, 1);
    updateTrolleyCount();
    renderTrolley();
    showCenterToast(`🗑️ Removed ${removedItemName} from trolley.`);
}

/* -------------------------
  HOMEPAGE & PROMOS (Dynamic)
--------------------------*/

function renderHomepageFeatures() {
    // Render the grid normally, using the product's internal 'featured' flag
    renderProductGrid('', 'featuredGrid'); 
}

// NEW FUNCTION: For the dynamic banner text
let currentBannerIndex = 0;
function updateDynamicBanner() {
    const bannerTextElement = document.getElementById('dynamicBannerText');
    const bannerContent = document.getElementById('dynamicBannerContent');
    const badge = bannerBadges[currentBannerIndex];
    
    // Smooth transition
    bannerContent.style.opacity = '0';
    
    setTimeout(() => {
        bannerTextElement.textContent = badge.text;
        bannerTextElement.style.color = badge.color; 
        
        // Remove previous buttons
        const oldButton = bannerContent.querySelector('.banner-add-btn');
        if (oldButton) oldButton.remove();

        // Add 'Add to Trolley' button for featured products
        if (badge.type === 'product') {
            const product = products.find(p => p.id === badge.id);
            const variant = product.variants.find(v => v.size === badge.size);
            const button = document.createElement('button');
            button.className = 'banner-add-btn';
            button.textContent = `🛒 Add $${variant.price.toFixed(2)}`;
            button.onclick = () => showConfirmPromoModal(badge.id, badge.size);
            bannerContent.appendChild(button);
        }

        bannerContent.style.opacity = '1';
        
        currentBannerIndex = (currentBannerIndex + 1) % bannerBadges.length;
    }, 500); // 500ms for fade out

}

function renderHomepagePromos() {
    const homepagePromos = document.getElementById('homepagePromos');
    homepagePromos.innerHTML = '';

    const dealProducts = products.filter(p => 
        p.variants.some(v => v.promo && v.originalPrice > v.price)
    );

    const shuffledDeals = dealProducts.sort(() => 0.5 - Math.random());
    const selectedDeals = shuffledDeals.slice(0, 7); 

    if (selectedDeals.length === 0) {
        homepagePromos.innerHTML = '<p>No hot deals this week, check back soon!</p>';
        return;
    }

    selectedDeals.forEach(product => {
        const promoVariant = product.variants.find(v => v.promo) || product.variants[0]; 
        const savings = (promoVariant.originalPrice - promoVariant.price).toFixed(2);
        
        const promoHtml = `
            <span class="promo" onclick="showConfirmPromoModal(${product.id}, '${promoVariant.size}')">
                ${product.brand} ${product.name} (${promoVariant.size}) 
                <s>$${promoVariant.originalPrice.toFixed(2)}</s> 
                $${promoVariant.price.toFixed(2)}!
                <small style="margin-left:5px; color:#DC143C; font-weight:700;">Save $${savings}</small>
            </span>
        `;
        homepagePromos.insertAdjacentHTML('beforeend', promoHtml);
    });
}

function showConfirmPromoModal(productId, size) {
    const product = products.find(p => p.id === productId);
    const promoVariant = product.variants.find(v => v.size === size);

    document.getElementById('promoConfirmContent').innerHTML = `
        <p>You are adding **${product.brand} ${product.name}** (${size}) for **$${promoVariant.price.toFixed(2)}**.</p>
    `;
    
    document.getElementById('confirmPromoAddBtn').onclick = () => {
        directAddToTrolley(productId, size, promoVariant.price, product.brand, product.name, 1);
    };

    document.getElementById('confirmPromoModal').style.display = 'block';
}

function directAddToTrolley(itemId, size, price, brand, name, quantity) {
    document.getElementById('confirmPromoModal').style.display = 'none';
    document.getElementById('confirmAddModal').style.display = 'none';

    const existingItem = trolley.find(item => item.itemId === itemId && item.variantSize === size);

    if (existingItem) {
        existingItem.quantity += quantity;
    } else {
        trolley.push({
            itemId: itemId,
            variantSize: size,
            name: name,
            brand: brand,
            price: price,
            quantity: quantity
        });
    }

    updateTrolleyCount();
    showCenterToast(`✅ Added ${quantity} x ${name} (${size}) to trolley!`);
}

/* -------------------------
  MODAL & CONFIRMATION FLOW
--------------------------*/

function showConfirmAddModal(productId) {
    const product = products.find(p => p.id === productId);
    currentProductIdForModal = productId;
    const modal = document.getElementById('confirmAddModal');
    const content = document.getElementById('confirmAddContent');
    const variantContainer = document.getElementById('modalVariantContainer');
    const quantityInput = document.getElementById('modalQuantity');
    const confirmBtn = document.getElementById('confirmModalAddBtn');

    content.innerHTML = `<h4>${product.brand} ${product.name}</h4>`;
    variantContainer.innerHTML = '';
    quantityInput.value = 1;

    let defaultVariant = product.variants.find(v => v.promo) || product.variants[0];
    
    // Check if the card exists and retrieve the currently selected variant size
    const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    if (card) {
        const selectedButton = card.querySelector('.grid-variant-btn.selected');
        if (selectedButton) {
            defaultVariant = product.variants.find(v => v.size === selectedButton.dataset.size) || defaultVariant;
        }
    }


    product.variants.forEach(v => {
        const isSelected = v.size === defaultVariant.size;
        const button = document.createElement('span');
        button.className = `grid-variant-btn ${isSelected ? 'selected' : ''}`;
        button.textContent = `${v.size} - $${v.price.toFixed(2)}`;
        button.dataset.size = v.size;
        button.dataset.price = v.price;
        button.onclick = () => selectVariant(button, productId);
        variantContainer.appendChild(button);
    });
    
    confirmBtn.onclick = finalAddToTrolleyFromModal;

    modal.style.display = 'block';
}

function finalAddToTrolleyFromModal() {
    const productId = currentProductIdForModal;
    const selectedButton = document.getElementById('modalVariantContainer').querySelector('.grid-variant-btn.selected');
    const quantity = parseInt(document.getElementById('modalQuantity').value);

    if (!selectedButton || quantity < 1) {
        showCenterToast("Please select a variant and quantity.", true);
        return;
    }

    const size = selectedButton.dataset.size;
    const price = parseFloat(selectedButton.dataset.price);
    const product = products.find(p => p.id === productId);

    directAddToTrolley(productId, size, price, product.brand, product.name, quantity);
    document.getElementById('confirmAddModal').style.display = 'none';
    renderTrolley(); 
}


/* -------------------------
  STICKY HEADER SEARCH
--------------------------*/

document.getElementById('headerSearch').addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    const suggestionsDiv = document.getElementById('headerSearchSuggestions');
    suggestionsDiv.innerHTML = '';
    suggestionsDiv.style.display = 'none';

    if (query.length < 2) return;

    const matches = products.filter(p => 
        p.name.toLowerCase().includes(query) || 
        p.brand.toLowerCase().includes(query) || 
        p.category.toLowerCase().includes(query)
    ).slice(0, 10); 

    if (matches.length > 0) {
        matches.forEach(product => {
            const displayName = `${product.name} (${product.brand})`;
            
            const highlightedText = displayName.replace(
                new RegExp(query, 'gi'), 
                (match) => `<b style="color:var(--highlight-color);">${match}</b>`
            );

            const suggestionItem = document.createElement('div');
            suggestionItem.innerHTML = highlightedText;
            suggestionItem.onclick = () => {
                filterProductGrid(query); // Call the filter function with the actual query
                document.getElementById('headerSearch').value = query; // Keep the search box populated
                suggestionsDiv.style.display = 'none';
            };
            suggestionsDiv.appendChild(suggestionItem);
        });
        suggestionsDiv.style.display = 'block';
    }
});

function filterProductGrid(query) {
    currentSearchQuery = query;
    showPage('store'); // Direct the customer to the store page
    
    // De-select the category buttons when a search is active
    document.querySelectorAll('.category-pill-btn').forEach(b => b.classList.remove('active'));
    currentCategoryFilter = ''; // Clear category filter when searching
    
    // The renderStorePage function now uses currentSearchQuery to filter the grids
    renderStorePage(); 
}

/* -------------------------
  CHECKOUT & ORDER LOGIC
--------------------------*/

// Auto-add slash to expiry date
document.getElementById('cardExpiry').addEventListener('input', function(e) {
    let input = e.target.value.replace(/\D/g, ''); 
    const currentLength = input.length;

    if (currentLength > 4) {
        input = input.substring(0, 4);
    }

    let formattedValue = input;
    if (currentLength >= 3) {
        formattedValue = input.substring(0, 2) + '/' + input.substring(2);
    }
    
    e.target.value = formattedValue;
});

function getCalculatedDeliveryFee(postcode) {
    const rule = deliveryRules[postcode];
    if (rule && rule.available) return rule.fee;
    if (deliveryRules.hasOwnProperty(postcode) && !deliveryRules[postcode].available) return 0.00;
    
    return 0.00; 
}

function updateCheckoutTotals() {
    const subtotal = calculateTrolleyTotal();
    const postcode = document.getElementById('postcode').value;
    const deliveryFee = postcode.length === 4 ? getCalculatedDeliveryFee(postcode) : 0.00;
    const grandTotal = subtotal + deliveryFee;

    document.getElementById('checkoutSubtotal').textContent = `Subtotal: $${subtotal.toFixed(2)}`;
    document.getElementById('checkoutDelivery').textContent = `Delivery Fee: $${deliveryFee.toFixed(2)}`;
    document.getElementById('checkoutGrandTotal').textContent = `Grand Total: $${grandTotal.toFixed(2)}`;
}

document.getElementById('postcode').addEventListener('input', function() {
    const postcode = this.value;
    if (postcode.length === 4) {
        generateDeliverySlots(postcode);
        updateCheckoutTotals();
    } else {
        document.getElementById('postcodeNote').innerHTML = 'Enter a valid 4-digit postcode.';
        document.getElementById('deliveryTimes').innerHTML = '';
        updateCheckoutTotals(); 
    }
});

// UPDATED FUNCTION: Simplified to next 3 business days with alternating slots
function generateDeliverySlots(postcode) {
    const rule = deliveryRules[postcode] || deliveryRules['0000'];
    const deliveryTimesDiv = document.getElementById('deliveryTimes');
    const postcodeNote = document.getElementById('postcodeNote');
    deliveryTimesDiv.innerHTML = '';
    selectedSlot = null; 
    
    document.querySelectorAll('.slot').forEach(slot => slot.classList.remove('selected'));

    if (!rule.available) {
        postcodeNote.innerHTML = `⚠️ Delivery is currently **unavailable** for Postcode ${postcode}.`;
        return;
    }

    postcodeNote.innerHTML = `✅ Delivery Fee for ${postcode}: **$${rule.fee.toFixed(2)}**. Select a time slot below.`;
    
    let daysToGenerate = 3;
    let dayCount = 0;
    let date = new Date();
    date.setDate(date.getDate()); 

    while (daysToGenerate > 0) {
        date.setDate(date.getDate() + 1);
        const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday

        // Skip Sunday (assuming Mon-Sat delivery)
        if (dayOfWeek === 0) continue; 

        const dayString = date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
        let slots = [];
        
        // Alternating time slots logic (Day 1 & 3: Morning/Mid-day. Day 2: Mid-day/Evening)
        if ((dayCount + 1) % 2 !== 0) {
            // Day 1, 3, 5, etc.
            slots = ['8am-12pm', '1pm-5pm'];
        } else {
            // Day 2, 4, 6, etc.
            slots = ['1pm-5pm', '5pm-7pm'];
        }

        slots.forEach(time => {
            const slotValue = `${dayString} ${time}`;
            const slotHtml = `
                <div class="slot" data-slot="${slotValue}" onclick="selectSlot(this)">
                    ${dayString}<br><small>${time}</small>
                </div>
            `;
            deliveryTimesDiv.insertAdjacentHTML('beforeend', slotHtml);
        });
        
        dayCount++;
        daysToGenerate--;
    }
}

function selectSlot(element) {
    document.querySelectorAll('.slot').forEach(slot => slot.classList.remove('selected'));
    element.classList.add('selected');
    selectedSlot = element.dataset.slot;
}

function preProcessCheckout() {
    const postcode = document.getElementById('postcode').value;
    const isSlotSelected = selectedSlot !== null;
    const deliveryAvailable = (deliveryRules[postcode] && deliveryRules[postcode].available) || false;

    if (!document.getElementById('custName').value || !document.getElementById('address').value || !document.getElementById('cardNumber').value) {
        showCenterToast("Please fill in all mandatory contact and payment fields.", true);
        return;
    }
    if (postcode.length !== 4) {
         showCenterToast("Please enter a valid 4-digit postcode.", true);
         return;
    }
    if (!deliveryAvailable) {
        showCenterToast(`Delivery is not available for postcode ${postcode}.`, true);
        return;
    }
    if (!isSlotSelected) {
        showCenterToast("Please select a delivery date and time slot.", true);
        return;
    }

    const otp = Math.floor(1000 + Math.random() * 9000); 
    document.getElementById('testOtpCode').textContent = otp;
    document.getElementById('otpInput').value = '';
    document.getElementById('otpModal').style.display = 'flex';
}

function verifyOTP() {
    const enteredOTP = document.getElementById('otpInput').value;
    const correctOTP = document.getElementById('testOtpCode').textContent;

    if (enteredOTP === correctOTP) {
        document.getElementById('otpModal').style.display = 'none';
        
        // --- Order Placement and Notification Chain ---
        
        const orderId = 'GG' + Math.floor(1000 + Math.random() * 9000); // Generate 4-digit ID
        const deliveryFee = getCalculatedDeliveryFee(document.getElementById('postcode').value);
        const subtotal = calculateTrolleyTotal();
        const grandTotal = subtotal + deliveryFee;

        currentOrder = {
            id: orderId,
            items: [...trolley],
            subtotal: subtotal,
            deliveryFee: deliveryFee,
            grandTotal: grandTotal,
            slot: selectedSlot,
            mobile: document.getElementById('custMobile').value,
            email: document.getElementById('custEmail').value,
            address: document.getElementById('address').value + ', ' + document.getElementById('suburb').value + ' ' + document.getElementById('postcode').value,
            status: "Confirmed",
            timeline: [{ time: new Date().toLocaleTimeString('en-AU'), status: "Order Confirmed" }]
        };

        localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
        currentOrderStatus = currentOrder.status;

        // 1. Order Confirmation (Immediate)
        const confirmationMessage = `Order ${orderId} Confirmed! Total: $${grandTotal.toFixed(2)}. Delivery slot: ${selectedSlot}.`;
        showCenterToast(confirmationMessage);
        sendComms('Confirmed', currentOrder.id, currentOrder.mobile, currentOrder.email, confirmationMessage);
        sendEmailReceipt(currentOrder);
        
        // Schedule real-time status updates after delay
        setTimeout(() => updateOrderStatus("Packed"), 5000); 
        setTimeout(() => updateOrderStatus("Out for Delivery"), 10000);
        setTimeout(() => updateOrderStatus("Arriving in 20 mins"), 15000); 
        setTimeout(() => updateOrderStatus("Arrived"), 20000); // FINAL STATUS UPDATE
        
        trolley = [];
        updateTrolleyCount();
        selectedSlot = null;

        // Reset checkout form fields (optional, but good practice)
        document.getElementById('postcode').value = '4205'; // Keep the postcode for next test
        document.getElementById('deliveryTimes').innerHTML = '';
        
        showPage('orderStatus');
        setTimeout(showFeedbackPopup, 30000); // Ask for feedback after completion
    } else {
        showCenterToast("❌ Incorrect OTP. Please try again.", true);
    }
}

// --- Status Update Function ---
function updateOrderStatus(newStatus) {
    if (!currentOrder || currentOrder.status === 'Cancelled' || currentOrder.status === 'Arrived') return;
    
    let notificationTitle = '';
    let notificationMessage = '';

    if (newStatus === "Packed") {
        notificationTitle = `Order ${currentOrder.id} Packed!`;
        notificationMessage = "Your groceries are ready to go. Next stop: delivery!";
        currentOrder.status = newStatus;
        currentOrder.timeline.push({ time: new Date().toLocaleTimeString('en-AU'), status: newStatus });
    } else if (newStatus === "Out for Delivery") {
        notificationTitle = `Order ${currentOrder.id} Out for Delivery!`;
        notificationMessage = `Your driver is on the way. Expected delivery: ${currentOrder.slot}.`;
        currentOrder.status = newStatus;
        currentOrder.timeline.push({ time: new Date().toLocaleTimeString('en-AU'), status: newStatus });
    } else if (newStatus === "Arriving in 20 mins") {
        notificationTitle = `Driver is nearby!`;
        notificationMessage = `Order ${currentOrder.id} arriving in approx. 20 minutes to ${currentOrder.address}!`;
        // Log this special status, but don't change the main status yet
        currentOrder.timeline.push({ time: new Date().toLocaleTimeString('en-AU'), status: "Driver is nearby (20 mins)" });
    } else if (newStatus === "Arrived") {
        notificationTitle = `Your order has arrived!`; 
        notificationMessage = `Order ${currentOrder.id} delivered to ${currentOrder.address}. Thank you for choosing GroceryGo.`;
        
        // Final actions for delivered order
        currentOrder.status = 'Arrived'; 
        currentOrder.timeline.push({ time: new Date().toLocaleTimeString('en-AU'), status: "Order Arrived" });
        
        // Clear order state
        localStorage.removeItem('currentOrder');
        currentOrder = null;
        document.getElementById('navOrderStatus').classList.add('hidden-section');
    }

    if (notificationTitle) {
        showCenterToast(`📢 ${notificationMessage}`);
        // Send SMS/Email for all status updates
        sendComms(newStatus, currentOrder ? currentOrder.id : 'N/A', currentOrder ? currentOrder.mobile : 'N/A', currentOrder ? currentOrder.email : 'N/A', notificationMessage);
    }

    if(currentOrder) localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
    if(currentOrder) currentOrderStatus = currentOrder.status;
    
    // Re-render status screen if the customer is currently viewing it
    if (!document.getElementById('orderStatusContent').classList.contains('hidden-section')) {
        renderOrderStatus();
    }
}

// --- Order Status Rendering ---
function renderOrderStatus() {
    if (!currentOrder) return;
    
    document.getElementById('currentOrderStatus').textContent = currentOrder.status;
    document.getElementById('orderStatusSummary').innerHTML = `
        <p><strong>Order ID:</strong> ${currentOrder.id}</p>
        <p><strong>Delivery Slot:</strong> ${currentOrder.slot}</p>
        <p><strong>Delivery Address:</strong> ${currentOrder.address}</p>
        <p><strong>Grand Total:</strong> $${currentOrder.grandTotal.toFixed(2)}</p>
    `;

    const timelineDiv = document.getElementById('statusTimeline');
    timelineDiv.innerHTML = '<h4>Timeline</h4>';
    currentOrder.timeline.forEach(event => {
        timelineDiv.innerHTML += `<div class="status-update"><strong>${event.status}</strong> (${event.time})</div>`;
    });
    
    // Cancellation Button Logic
    const cancelBtn = document.getElementById('cancelOrderBtn');
    if (currentOrder.status === 'Cancelled' || currentOrder.status === 'Arrived') {
        cancelBtn.disabled = true;
        cancelBtn.textContent = currentOrder.status === 'Cancelled' ? 'Order Cancelled' : 'Order Delivered';
    } else {
        cancelBtn.disabled = false;
        cancelBtn.textContent = '❌ Cancel Order';
    }
}

// --- Cancellation Logic ---
function showConfirmCancelModal() {
    if (!currentOrder) return;

    const modal = document.getElementById('confirmCancelModal');
    const messageDiv = document.getElementById('cancelConfirmationMessage');
    const orderIdSpan = document.getElementById('cancelOrderId');
    orderIdSpan.textContent = currentOrder.id;

    // Check if the order status indicates it is already out for delivery (or near)
    const isOutForDelivery = currentOrder.status.includes('Out for Delivery');

    if (isOutForDelivery) {
        messageDiv.innerHTML = `<p style="color:red; font-weight:700;">WARNING: The order is already out for delivery. If you proceed, **only the item costs will be refunded**. The $${currentOrder.deliveryFee.toFixed(2)} delivery fee is non-refundable.</p>`;
    } else {
        messageDiv.innerHTML = `<p style="color:green;">The order is currently being prepared. You can cancel now for a **full refund**, including the delivery fee.</p>`;
    }

    document.getElementById('confirmCancelBtn').onclick = processOrderCancellation;
    modal.style.display = 'block';
}

function processOrderCancellation() {
    const modal = document.getElementById('confirmCancelModal');
    modal.style.display = 'none';

    if (!currentOrder) return;

    const isOutForDelivery = currentOrder.status.includes('Out for Delivery');
    
    let refundAmount = currentOrder.grandTotal;
    let message = `Order ${currentOrder.id} has been **fully cancelled** and $${currentOrder.grandTotal.toFixed(2)} refunded.`;

    if (isOutForDelivery) {
        refundAmount = currentOrder.grandTotal - currentOrder.deliveryFee;
        message = `Order ${currentOrder.id} has been **cancelled**. $${refundAmount.toFixed(2)} refunded. The $${currentOrder.deliveryFee.toFixed(2)} delivery fee is non-refundable.`;
    }

    currentOrder.status = 'Cancelled';
    currentOrder.timeline.push({ time: new Date().toLocaleTimeString('en-AU'), status: `Order Cancelled. Refund Amount: $${refundAmount.toFixed(2)}` });
    
    sendComms('Cancelled', currentOrder.id, currentOrder.mobile, currentOrder.email, message);
    
    localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
    currentOrderStatus = 'Cancelled';

    showCenterToast(`❌ ${message}`);
    renderOrderStatus(); // Update the status display

    // Hide order status link as the order is complete/cancelled
    document.getElementById('navOrderStatus').classList.add('hidden-section');
    currentOrder = null; 
    localStorage.removeItem('currentOrder');
}


// --- Email Receipt Simulation (Standard Format) ---
function sendEmailReceipt(order) {
    // This is a simulation, the structure uses a standard HTML table for clear receipt formatting
    const receiptHtml = `
        <h3>GroceryGo Order Receipt #${order.id}</h3>
        <p>Thank you for your order! This email confirms your purchase details.</p>
        <p><strong>Delivery Slot:</strong> ${order.slot}</p>
        <p><strong>Shipping To:</strong> ${order.address}</p>
        <table border="1" style="width:100%; border-collapse: collapse; margin: 15px 0;">
            <tr><th>Item</th><th>Size</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr>
            ${order.items.map(item => `
                <tr>
                    <td>${item.name} (${item.brand})</td>
                    <td>${item.variantSize}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>$${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('')}
        </table>
        <p>Subtotal: $${order.subtotal.toFixed(2)}</p>
        <p>Delivery Fee: $${order.deliveryFee.toFixed(2)}</p>
        <p><strong>Grand Total: $${order.grandTotal.toFixed(2)}</strong></p>
    `;
    
    // Simulate email sending (logging to console)
    console.log(`[Email Sent - Receipt] To: ${order.email}. Receipt for Order ${order.id}. Total: $${order.grandTotal.toFixed(2)}. (Formatted receipt details below)\n`, receiptHtml);
    // In a real application, you would use an Email Service API here.
}


/* -------------------------
  FEEDBACK POPUP
--------------------------*/

function showFeedbackPopup() {
    const popup = document.getElementById('feedbackPopup');
    const starContainer = document.getElementById('starContainer');
    starContainer.innerHTML = '';
    currentRating = 0;

    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('button');
        star.className = 'star-btn';
        star.textContent = '★';
        star.dataset.rating = i;
        star.onclick = () => setRating(i);
        starContainer.appendChild(star);
    }
    popup.style.display = 'block';
    updateFeedbackReasons(0);
}

function setRating(rating) {
    currentRating = rating;
    document.querySelectorAll('.star-btn').forEach(btn => {
        const btnRating = parseInt(btn.dataset.rating);
        btn.classList.toggle('shining', btnRating <= rating);
    });
    updateFeedbackReasons(rating);
}

function updateFeedbackReasons(rating) {
    const reasonSelect = document.getElementById('feedbackReason');
    reasonSelect.innerHTML = '<option value="0">Select Reason (optional)</option>';
    
    const reasons = feedbackReasons[rating] || [];
    reasons.forEach(reason => {
        reasonSelect.innerHTML += `<option value="${reason}">${reason}</option>`;
    });
}

function submitFeedback() {
    if (currentRating === 0) {
        showCenterToast("Please select a star rating.", true);
        return;
    }

    const reason = document.getElementById('feedbackReason').value;
    const custom = document.getElementById('feedbackCustom').value;

    console.log(`Feedback: Rating=${currentRating}, Reason=${reason}, Custom=${custom}`);
    document.getElementById('feedbackPopup').style.display = 'none';
    showCenterToast(`Feedback received! Thank you for rating us ${currentRating} stars.`);
}

/* -------------------------
  INITIALIZATION
--------------------------*/

document.addEventListener('DOMContentLoaded', () => {
    updateTrolleyCount(); 
    renderHomepageFeatures();
    renderHomepagePromos();
    renderHorizontalCategories(); // Initial load of category buttons
    
    // Start dynamic banner updates
    updateDynamicBanner();
    setInterval(updateDynamicBanner, 5000); // Swaps every 5 seconds
    
    // Check if there is an active order on load
    if (currentOrder) {
        document.getElementById('navOrderStatus').classList.remove('hidden-section');
    }

    // Initialize state to show 'All Products' when store is clicked
    if (!currentSearchQuery) {
        currentCategoryFilter = ''; 
    }

    showPage('home'); 
    
    // Manually trigger postcode check on load if it's pre-filled
    const initialPostcode = document.getElementById('postcode').value;
    if (initialPostcode.length === 4) {
        generateDeliverySlots(initialPostcode);
        updateCheckoutTotals();
    }
});
</script>

</body>

</html>
