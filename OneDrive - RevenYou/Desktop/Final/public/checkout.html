<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-commerce Checkout</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght=400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .StripeElement {
            box-sizing: border-box; height: 44px; padding: 12px;
            border: 1px solid #d1d5db; border-radius: 0.5rem;
            background-color: white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 150ms ease;
        }
        .StripeElement--focus { box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5); border-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-6">

    <div class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-8 space-y-8 border border-gray-100 mt-10">
        <h1 class="text-3xl font-bold text-gray-900 text-center border-b pb-4">
            Order Payment
        </h1>
        
        <!-- Payment Form -->
        <form id="payment-form" class="space-y-6">
            
            <div id="auth-status" class="text-center text-sm p-2 rounded-lg">Authenticating...</div>
            
            <h2 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Shipping & Contact Details (QLD Example)</h2>

            <!-- Name and Email -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Billing Name</label>
                    <input id="name" type="text" value="Jane Doe" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input id="email" type="email" value="jane.doe@example.com" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
            </div>

            <!-- Phone -->
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number (Australian Mobile)</label>
                <input id="phone" type="tel" value="0412 345 678" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            </div>

            <!-- Address -->
            <div>
                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Shipping Address</label>
                <input id="address" type="text" value="1 King George Square" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            </div>

            <!-- City and Zip -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                    <input id="city" type="text" value="Brisbane" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                <div>
                    <label for="zip" class="block text-sm font-medium text-gray-700 mb-1">Zip / Postal Code</label>
                    <!-- Delivery calculation is tied to input change on this field -->
                    <input id="zip" type="text" value="4000" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
            </div>

            <!-- Order Summary (Moved Below Shipping Details) -->
            <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-200 mt-6">
                <h2 class="text-xl font-semibold text-indigo-800 mb-2">Final Order Summary</h2>
                <p id="delivery-info" class="text-sm text-indigo-600 mb-3 font-medium">Delivery calculated based on postcode.</p>
                <div id="order-details" class="space-y-1">
                    <!-- Dynamic items will be populated here by JavaScript -->
                </div>
                <div class="border-t border-indigo-300 my-3"></div>
                <div class="flex justify-between font-extrabold text-2xl text-indigo-700">
                    <span>TOTAL</span>
                    <span id="final-total-display">$0.00 AUD</span>
                </div>
            </div>

            <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-4 border-t pt-4">Payment Information</h2>

            <!-- Stripe Payment Element Container -->
            <div>
                <label for="card-element" class="block text-sm font-medium text-gray-700 mb-2">
                    Card Details
                </label>
                <div id="card-element"></div>
            </div>

            <!-- Message Box -->
            <div id="message-box" class="hidden p-4 rounded-lg text-sm" role="alert">
                <p id="message-text" class="font-medium"></p>
            </div>
            
            <button id="submit-button" type="submit" 
                    class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50"
                    disabled>
                <span id="button-text">Pay $0.00</span>
                <div id="spinner" class="hidden inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white align-middle mr-2"></div>
            </button>
        </form>
    </div>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, doc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Load Stripe.js library
        const stripeScript = document.createElement('script');
        stripeScript.src = "https://js.stripe.com/v3/";
        document.head.appendChild(stripeScript);
        
        // --- Globals ---
        // Simulating the subtotal carried over from trolley.html
        window.PRODUCT_SUBTOTAL_CENTS = 1000; // $10.00 base product cost
        window.DELIVERY_CHARGE_CENTS = 0; // Starts at $0
        window.ORDER_TOTAL_CENTS = 0; // Calculated dynamically
        window.serverUrl = 'http://localhost:3000/create-payment-intent';
        
        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const authStatusElement = document.getElementById('auth-status');

        // This path acts as the centralized "orders" table, accessible by "admin.html"
        const publicOrdersPath = `/artifacts/${appId}/public/data/orders`;

        // --- Core Functions ---

        /**
         * Calculates the total, updates the global total variable, and refreshes the UI summary.
         * @param {number} deliveryCents - The determined delivery charge in cents.
         */
        function updateOrderSummary(deliveryCents) {
            window.DELIVERY_CHARGE_CENTS = deliveryCents;
            window.ORDER_TOTAL_CENTS = window.PRODUCT_SUBTOTAL_CENTS + window.DELIVERY_CHARGE_CENTS;
            
            const totalDollars = (window.ORDER_TOTAL_CENTS / 100).toFixed(2);
            const subtotalDollars = (window.PRODUCT_SUBTOTAL_CENTS / 100).toFixed(2);
            
            // 1. Update Order Details List
            const summaryEl = document.getElementById('order-details');
            summaryEl.innerHTML = `
                <div class="flex justify-between">
                    <span>Product Subtotal</span>
                    <span>$${subtotalDollars}</span>
                </div>`;
            
            // Delivery Charge Display
            let deliveryDisplay = 'TBD';
            if (deliveryCents > 0) {
                deliveryDisplay = `$${(deliveryCents / 100).toFixed(2)}`;
            } else if (document.getElementById('zip').value.length === 4) {
                 // If a 4-digit zip was entered but charge is 0, show $0.00
                deliveryDisplay = `$0.00`;
            }

            summaryEl.innerHTML += `
                <div class="flex justify-between">
                    <span>Delivery Charge</span>
                    <span>${deliveryDisplay}</span>
                </div>`;
            
            // 2. Update Total and Button Text
            document.getElementById('final-total-display').textContent = `$${totalDollars} AUD`;
            
            const buttonTextEl = document.getElementById('button-text');
            if (buttonTextEl) {
                buttonTextEl.textContent = `Pay $${totalDollars}`;
            }
        }

        /**
         * Handles the dynamic calculation of delivery charge based on Australian postcode.
         */
        function calculateDelivery() {
            const zipInput = document.getElementById('zip');
            const infoEl = document.getElementById('delivery-info');
            const submitButton = document.getElementById('submit-button');
            const zip = zipInput.value.trim();
            let deliveryCents = 0;
            let isValidZip = false;
            
            // Reset delivery status info
            infoEl.textContent = 'Enter a valid 4-digit Australian Postcode';
            infoEl.className = 'text-sm text-indigo-600 mb-3 font-medium';
            
            if (zip.length === 4 && /^\d{4}$/.test(zip)) {
                isValidZip = true;
                // Example logic: QLD postcodes start with '4'
                if (zip.startsWith('4')) {
                    deliveryCents = 999; // $9.99 for QLD
                    infoEl.textContent = 'QLD Flat Rate Shipping ($9.99)';
                } else if (zip.startsWith('2') || zip.startsWith('3') || zip.startsWith('5') || zip.startsWith('6') || zip.startsWith('7') || zip.startsWith('8')) {
                    deliveryCents = 1500; // $15.00 for other major states (NSW, VIC, SA, WA, TAS, ACT)
                    infoEl.textContent = 'Interstate Shipping ($15.00)';
                } else {
                    // Unknown or remote/NT postcodes
                     deliveryCents = 2000; // $20.00 for unknown/remote/NT
                     infoEl.textContent = 'Remote Area Shipping ($20.00)';
                }
                
                updateOrderSummary(deliveryCents);
            } else {
                // If zip is invalid or incomplete, delivery is $0 and total reflects subtotal only.
                updateOrderSummary(0);
                document.getElementById('final-total-display').textContent = `$${(window.PRODUCT_SUBTOTAL_CENTS / 100).toFixed(2)} AUD`;
            }
            
            // Re-check submit button enablement state based on postcode validity
            // This relies on the card element 'change' listener logic being able to access the zip value
            const cardElement = document.getElementById('card-element');
            if (cardElement && cardElement.children.length > 0) {
                // We assume the card element state is handled by Stripe.js events
                // For now, we only ensure the zip is valid here.
                // The Stripe 'change' event will re-enable based on card completion.
                // We keep it disabled if zip is invalid.
                submitButton.disabled = !isValidZip;
            }
        }
        
        // 1. Initialize Firebase and Authenticate
        async function initializeFirebase() {
            try {
                console.log("Attempting Firebase initialization...");
                
                if (!firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration is missing or invalid. Check the apiKey field.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `User ID: ${userId.substring(0, 8)}... (Authenticated)`;
                        authStatusElement.className = 'text-center text-sm p-2 rounded-lg bg-green-100 text-green-700';
                        
                        // Initial calculation and listeners setup
                        calculateDelivery(); 
                        document.getElementById('zip').addEventListener('input', calculateDelivery);

                        initializeStripe(); // Initialize Stripe only after Firebase is ready
                        
                    } else {
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                             await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusElement.textContent = `Error: Cannot connect to database.`;
                authStatusElement.className = 'text-center text-sm p-2 rounded-lg bg-red-100 text-red-700';
            }
        }

        // 2. Stripe Setup
        function initializeStripe() {
            // IMPORTANT: Replace this with your actual Stripe Publishable Key
            const stripePublishableKey = 'pk_test_51O7c7wJ1Gz7cR3z3sW2yT8oV6nG3kB0xV0iT7vW1tZ2mX6qT9b4k3pYlX2fG0wW8lR6pYt0tZ4uP0yF3'; 
            
            const stripe = Stripe(stripePublishableKey);
            const elements = stripe.elements();
            const card = elements.create('card');
            card.mount('#card-element');

            const form = document.getElementById('payment-form');
            const submitButton = document.getElementById('submit-button');
            
            // Button is disabled initially (waiting for card details AND valid zip)
            submitButton.disabled = true; 

            card.on('change', function(event) {
                const isValidZip = document.getElementById('zip').value.trim().length === 4;
                // Only enable submit if card is complete AND zip is valid
                submitButton.disabled = !event.complete || !isValidZip; 
                
                if (event.error) {
                    displayMessage(event.error.message, true);
                } else {
                    document.getElementById('message-box').classList.add('hidden');
                }
            });

            form.addEventListener('submit', (e) => handlePayment(e, stripe, card));
        }
        
        // 3. Payment Handling
        async function handlePayment(event, stripe, card) {
            event.preventDefault();
            if (!userId) return displayMessage("Authentication not complete. Please wait.", true);
            
            const zipInput = document.getElementById('zip');
            if (zipInput.value.length !== 4) {
                 return displayMessage("Please enter a valid 4-digit Australian Postcode to calculate delivery.", true);
            }
            
            showProcessing(true);
            
            let orderDocRef;

            try {
                // A. Prepare all order details
                const customerName = document.getElementById('name').value;
                const customerEmail = document.getElementById('email').value;
                const customerPhone = document.getElementById('phone').value;
                const shippingAddress = {
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    zip: document.getElementById('zip').value
                };
                
                // Construct the final items array for database
                const finalItems = [
                    { name: "Product Subtotal (from trolley.html)", price: window.PRODUCT_SUBTOTAL_CENTS },
                    { name: "Delivery Charge", price: window.DELIVERY_CHARGE_CENTS }
                ];


                // B. Create the Order in Firestore (Simulating Supabase 'orders' table - Status: PENDING)
                const newOrder = {
                    customerId: userId,
                    customerName: customerName,
                    customerEmail: customerEmail,
                    customerPhone: customerPhone,
                    shippingAddress: shippingAddress,
                    items: finalItems, 
                    amount: window.ORDER_TOTAL_CENTS, 
                    status: 'PENDING',
                    createdAt: new Date(),
                    lastUpdated: new Date()
                };

                orderDocRef = await addDoc(collection(db, publicOrdersPath), newOrder);
                const orderId = orderDocRef.id;

                displayMessage(`Order created: ${orderId}. Requesting payment intent...`, false, 'bg-blue-100 text-blue-700');
                
                // C. Fetch the Client Secret from Node.js Server
                const response = await fetch(window.serverUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amountInCents: window.ORDER_TOTAL_CENTS, orderId: orderId })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const clientSecret = data.clientSecret;

                // D. Confirm Payment with Stripe
                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: card,
                        billing_details: { 
                            name: customerName,
                            email: customerEmail,
                        },
                    }
                });

                if (result.error) {
                    // Payment failed, update status to FAILED
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'FAILED',
                        lastUpdated: new Date(),
                        paymentError: result.error.message
                    });
                    displayMessage(`Payment Failed: ${result.error.message}. Status set to FAILED in Firestore.`, true);
                } else if (result.paymentIntent.status === 'succeeded') {
                    // Payment succeeded, update status to PAID
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'PAID',
                        stripePaymentIntentId: result.paymentIntent.id,
                        lastUpdated: new Date()
                    });
                    
                    // Successful payment: Redirect to success.html with order ID
                    window.location.href = `success.html?orderId=${orderId}`; 

                } else {
                    // Handle other statuses (e.g., requires_action)
                    displayMessage(`Payment status: ${result.paymentIntent.status}. Please check Stripe dashboard.`, true);
                }

            } catch (error) {
                console.error('[Checkout Error]', error);
                
                // If an error occurred before or during payment (e.g., server down), mark the order as failed if it exists
                if (orderDocRef) {
                     await updateDoc(doc(db, publicOrdersPath, orderDocRef.id), {
                        status: 'FAILED_API_ERROR',
                        lastUpdated: new Date(),
                        serverError: error.message
                    });
                }
                displayMessage(`System Error: ${error.message}. Ensure 'server.js' is running.`, true);
            } finally {
                showProcessing(false);
            }
        }
        
        // --- UI Helpers ---
        function showProcessing(isProcessing) {
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            submitButton.disabled = isProcessing;
            spinner.classList.toggle('hidden', !isProcessing);
            
            // Only update button text if not processing, to avoid visual jump
            if (!isProcessing) {
                const totalDollars = (window.ORDER_TOTAL_CENTS / 100).toFixed(2);
                buttonText.textContent = `Pay $${totalDollars}`;
            } else {
                buttonText.textContent = 'Processing...';
            }
        }

        function displayMessage(text, isError = false, bgColorClass = null) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageBox.className = `p-4 rounded-lg text-sm`;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-700', 'text-green-700', 'text-blue-700');

            if (bgColorClass) {
                messageBox.classList.add(bgColorClass);
            } else {
                messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
                messageText.classList.add(isError ? 'text-red-700' : 'text-green-700');
            }
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        // Start the application
        initializeFirebase();
    </script>
</body>
</html>
