<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-commerce Checkout</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .StripeElement {
            box-sizing: border-box; height: 44px; padding: 12px;
            border: 1px solid #d1d5db; border-radius: 0.5rem;
            background-color: white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 150ms ease;
        }
        .StripeElement--focus { box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5); border-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-6">

    <div class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-8 space-y-8 border border-gray-100 mt-10">
        <h1 class="text-3xl font-bold text-gray-900 text-center border-b pb-4">
            Order Payment
        </h1>
        
        <!-- Payment Form -->
        <form id="payment-form" class="space-y-6">
            
            <div id="auth-status" class="text-center text-sm p-2 rounded-lg">Authenticating...</div>
            
            <h2 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Shipping & Contact Details (QLD Example)</h2>

            <!-- Name and Email -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Billing Name</label>
                    <input id="name" type="text" value="Jane Doe" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input id="email" type="email" value="jane.doe@example.com" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
            </div>

            <!-- Phone -->
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number (Australian Mobile)</label>
                <input id="phone" type="tel" value="0412 345 678" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            </div>

            <!-- Address -->
            <div>
                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Shipping Address</label>
                <input id="address" type="text" value="1 King George Square" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            </div>

            <!-- City and Zip -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City/Suburb</label>
                    <input id="city" type="text" value="Brisbane" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                <div>
                    <label for="zip" class="block text-sm font-medium text-gray-700 mb-1">Zip / Postal Code</label>
                    <!-- Delivery calculation is tied to input change on this field -->
                    <input id="zip" type="text" value="4000" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
            </div>
            
             <!-- State and Delivery Slot (Added State to match server's customer object) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State (e.g., QLD)</label>
                    <input id="state" type="text" value="QLD" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                <div>
                    <label for="deliverySlot" class="block text-sm font-medium text-gray-700 mb-1">Delivery Slot (Date|Time)</label>
                    <input id="deliverySlot" type="text" value="2025-12-01|Anytime" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
            </div>

            <!-- Order Summary (Moved Below Shipping Details) -->
            <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-200 mt-6">
                <h2 class="text-xl font-semibold text-indigo-800 mb-2">Final Order Summary</h2>
                <p id="delivery-info" class="text-sm text-indigo-600 mb-3 font-medium">Delivery fee calculated by server based on postcode.</p>
                <div id="order-details" class="space-y-1">
                    <!-- Dynamic items will be populated here by JavaScript -->
                </div>
                <div class="border-t border-indigo-300 my-3"></div>
                <div class="flex justify-between font-extrabold text-2xl text-indigo-700">
                    <span>TOTAL (Server Calculated)</span>
                    <span id="final-total-display">$0.00 AUD</span>
                </div>
            </div>

            <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-4 border-t pt-4">Payment Information</h2>

            <!-- Stripe Payment Element Container -->
            <div>
                <label for="card-element" class="block text-sm font-medium text-gray-700 mb-2">
                    Card Details
                </label>
                <div id="card-element"></div>
            </div>

            <!-- Message Box -->
            <div id="message-box" class="hidden p-4 rounded-lg text-sm" role="alert">
                <p id="message-text" class="font-medium"></p>
            </div>
            
            <button id="submit-button" type="submit" 
                    class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50"
                    disabled>
                <span id="button-text">Pay $0.00</span>
                <div id="spinner" class="hidden inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white align-middle mr-2"></div>
            </button>
        </form>
    </div>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, doc, updateDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Load Stripe.js library
        const stripeScript = document.createElement('script');
        stripeScript.src = "https://js.stripe.com/v3/";
        document.head.appendChild(stripeScript);
        
        // --- Globals ---
        // CRITICAL FIX: The server expects product prices in AUD (dollars, not cents)
        const PRODUCT_SUBTOTAL_AUD = 10.00; 
        
        // UPDATED ENDPOINT PATH TO MATCH SERVER ROUTE
        window.serverUrl = 'http://localhost:3000/api/create-payment-intent';
        
        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const authStatusElement = document.getElementById('auth-status');

        // This path acts as the centralized "orders" table, accessible by "admin.html"
        const publicOrdersPath = `/artifacts/${appId}/public/data/orders`;

        // --- Core Functions ---

        /**
         * Simulates the trolley data structure expected by the Node.js server.
         * Note: Prices here are in dollars (AUD), as the server expects.
         * @returns {Array} A mock trolley array.
         */
        function getTrolleyData() {
            // Your server side code expects 'price' to be the unit price in AUD.
            return [
                { name: "Premium Widget", price: PRODUCT_SUBTOTAL_AUD, quantity: 1 }
            ];
        }

        /**
         * Collects customer data from the form, aligned with the server's expected `customer` object structure.
         */
        function getCustomerData() {
             return {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                mobile: document.getElementById('phone').value, // Server expects 'mobile'
                address: document.getElementById('address').value, // Server expects 'address' (line1)
                suburb: document.getElementById('city').value, // Server expects 'suburb'
                state: document.getElementById('state').value, // Server expects 'state'
                postcode: document.getElementById('zip').value, // Server expects 'postcode'
                deliverySlot: document.getElementById('deliverySlot').value // Server expects 'deliverySlot'
            };
        }


        /**
         * Calculates the total, updates the global total variable, and refreshes the UI summary.
         * NOTE: Delivery fee is only estimated here; the final amount is calculated by the server.
         */
        function updateOrderSummary(deliveryFeeAud) {
            // This is just for display/estimation, the server holds the source of truth
            const totalDollars = (PRODUCT_SUBTOTAL_AUD + deliveryFeeAud).toFixed(2);
            const subtotalDollars = PRODUCT_SUBTOTAL_AUD.toFixed(2);
            
            // 1. Update Order Details List
            const summaryEl = document.getElementById('order-details');
            
            let deliveryDisplay = 'Calculating...';
            if (deliveryFeeAud > 0) {
                deliveryDisplay = `$${deliveryFeeAud.toFixed(2)}`;
            } else if (document.getElementById('zip').value.length === 4) {
                // Use a standard estimate for the UI
                deliveryDisplay = `$9.99 (Est.)`;
            }

            summaryEl.innerHTML = `
                <div class="flex justify-between">
                    <span>Product Subtotal</span>
                    <span>$${subtotalDollars}</span>
                </div>
                 <div class="flex justify-between text-yellow-700">
                    <span>Delivery Charge (Server Estimate)</span>
                    <span>${deliveryDisplay}</span>
                </div>`;
            
            // 2. Update Total and Button Text (Use the server's last known total if available, otherwise just subtotal)
            document.getElementById('final-total-display').textContent = `$${totalDollars} AUD`;
            
            const buttonTextEl = document.getElementById('button-text');
            if (buttonTextEl) {
                buttonTextEl.textContent = `Pay $${totalDollars}`;
            }
        }

        /**
         * Handles the dynamic calculation of delivery charge based on Australian postcode.
         */
        function calculateDeliveryEstimate() {
            const zipInput = document.getElementById('zip');
            const submitButton = document.getElementById('submit-button');
            const zip = zipInput.value.trim();
            let deliveryFeeAud = 0; // Default estimate
            let isValidZip = false;
            
            if (zip.length === 4 && /^\d{4}$/.test(zip)) {
                isValidZip = true;
                // Simple client-side estimation based on your old logic
                if (zip.startsWith('4')) {
                    deliveryFeeAud = 9.99; 
                } else if (['2', '3', '5', '6', '7', '8'].includes(zip.charAt(0))) {
                    deliveryFeeAud = 15.00; 
                } else {
                    deliveryFeeAud = 20.00; 
                }
                
            } else {
                deliveryFeeAud = 0;
            }
            
            updateOrderSummary(deliveryFeeAud);
            
            const cardElement = document.getElementById('card-element');
            if (cardElement && cardElement.children.length > 0) {
                // Ensure form can only be submitted if zip is valid
                submitButton.disabled = !isValidZip;
            }
        }
        
        // 1. Initialize Firebase and Authenticate
        async function initializeFirebase() {
            try {
                setLogLevel('debug'); 
                console.log("Attempting Firebase initialization...");

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    const errorMsg = "Firebase configuration is missing or invalid.";
                    console.error("Configuration Error:", errorMsg, { config: firebaseConfig });
                    throw new Error(errorMsg);
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `User ID: ${userId.substring(0, 8)}... (Authenticated)`;
                        authStatusElement.className = 'text-center text-sm p-2 rounded-lg bg-green-100 text-green-700';
                        
                        // Initial calculation and listeners setup
                        calculateDeliveryEstimate(); 
                        document.getElementById('zip').addEventListener('input', calculateDeliveryEstimate);

                        initializeStripe(); // Initialize Stripe only after Firebase is ready
                        
                    } else {
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                             await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusElement.textContent = `Error: Cannot connect to database.`;
                authStatusElement.className = 'text-center text-sm p-2 rounded-lg bg-red-100 text-red-700';
            }
        }

        // 2. Stripe Setup
        function initializeStripe() {
            const stripePublishableKey = 'pk_test_51O7c7wJ1Gz7cR3z3sW2yT8oV6nG3kB0xV0iT7vW1tZ2mX6qT9b4k3pYlX2fG0wW8lR6pYt0tZ4uP0yF3'; 
            
            const stripe = Stripe(stripePublishableKey);
            const elements = stripe.elements();
            const card = elements.create('card');
            card.mount('#card-element');

            const form = document.getElementById('payment-form');
            const submitButton = document.getElementById('submit-button');
            
            // Button is disabled initially (waiting for card details AND valid zip)
            submitButton.disabled = true; 

            card.on('change', function(event) {
                const isValidZip = document.getElementById('zip').value.trim().length === 4;
                // Only enable submit if card is complete AND zip is valid
                submitButton.disabled = !event.complete || !isValidZip; 
                
                if (event.error) {
                    displayMessage(event.error.message, true);
                } else {
                    document.getElementById('message-box').classList.add('hidden');
                }
            });

            form.addEventListener('submit', (e) => handlePayment(e, stripe, card));
        }
        
        // 3. Payment Handling
        async function handlePayment(event, stripe, card) {
            event.preventDefault();
            if (!userId) return displayMessage("Authentication not complete. Please wait.", true);
            
            const customer = getCustomerData();
            if (customer.postcode.length !== 4) {
                 return displayMessage("Please enter a valid 4-digit Australian Postcode.", true);
            }
            
            showProcessing(true);
            
            let orderDocRef;
            let grandTotalAud = 0;

            try {
                // A. Prepare Data for Server
                const trolley = getTrolleyData();
                
                // B. Create the Order in Firestore (Status: PENDING)
                // NOTE: We only have estimated prices here. The definitive price is returned by the server.
                const newOrder = {
                    customerId: userId,
                    customerName: customer.name,
                    customerEmail: customer.email,
                    shippingAddress: customer, // Save the full customer object
                    items: trolley, 
                    amountEstimate: PRODUCT_SUBTOTAL_AUD, 
                    status: 'PENDING',
                    createdAt: new Date(),
                    lastUpdated: new Date()
                };

                orderDocRef = await addDoc(collection(db, publicOrdersPath), newOrder);
                const orderId = orderDocRef.id;

                displayMessage(`Order created in Firestore: ${orderId}. Requesting final total and payment intent...`, false, 'bg-blue-100 text-blue-700');
                
                // C. Fetch the Client Secret and definitive Total from Node.js Server
                // CRITICAL FIX: Sending the required {trolley, customer} payload
                const response = await fetch(window.serverUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        trolley: trolley, 
                        customer: customer // Send all customer details
                    })
                });

                const data = await response.json();

                if (data.error) {
                     // If server returns error (e.g., postcode out of zone), update Firestore order to FAILED
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'FAILED_SERVER_REJECT',
                        serverError: data.error,
                        lastUpdated: new Date()
                    });
                    throw new Error(data.error);
                }

                const clientSecret = data.clientSecret;
                // Use the grandTotal returned by the server (security source of truth)
                grandTotalAud = data.grandTotal; 
                const amountInCents = Math.round(grandTotalAud * 100);
                
                // Update the Firestore order with the final price and PI details before confirmation
                 await updateDoc(doc(db, publicOrdersPath, orderId), {
                        amountFinal: amountInCents,
                        orderNumber: data.orderNumber, // Use the generated order number from server
                        stripePaymentIntentId: clientSecret.split('_secret')[0], // Extract PI ID from secret
                        lastUpdated: new Date()
                    });
                
                // D. Confirm Payment with Stripe
                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: card,
                        billing_details: { 
                            name: customer.name,
                            email: customer.email,
                        },
                    }
                });

                if (result.error) {
                    // Payment failed, update status to FAILED
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'FAILED',
                        lastUpdated: new Date(),
                        paymentError: result.error.message
                    });
                    displayMessage(`Payment Failed: ${result.error.message}. Status set to FAILED in Firestore.`, true);
                } else if (result.paymentIntent.status === 'succeeded') {
                    // Payment succeeded, update status to PAID
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'PAID',
                        lastUpdated: new Date()
                    });
                    
                    // Successful payment: Redirect to success.html with order ID
                    window.location.href = `success.html?orderId=${orderId}`; 

                } else {
                    // Handle other statuses (e.g., requires_action)
                    displayMessage(`Payment status: ${result.paymentIntent.status}. Please check Stripe dashboard.`, true);
                }

            } catch (error) {
                console.error('[Checkout Error]', error);
                displayMessage(`System Error: ${error.message}. Ensure 'server.js' is running.`, true);
            } finally {
                // Update UI display using the server-calculated total before hiding spinner
                const totalDollarsDisplay = grandTotalAud > 0 ? grandTotalAud.toFixed(2) : PRODUCT_SUBTOTAL_AUD.toFixed(2);
                document.getElementById('final-total-display').textContent = `$${totalDollarsDisplay} AUD`;
                showProcessing(false);
            }
        }
        
        // --- UI Helpers ---
        function showProcessing(isProcessing) {
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            submitButton.disabled = isProcessing;
            spinner.classList.toggle('hidden', !isProcessing);
            
            if (!isProcessing) {
                // Use the displayed total for button text
                const totalDollars = document.getElementById('final-total-display').textContent.replace('$', '').replace(' AUD', '');
                buttonText.textContent = `Pay ${totalDollars}`;
            } else {
                buttonText.textContent = 'Processing...';
            }
        }

        function displayMessage(text, isError = false, bgColorClass = null) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageBox.className = `p-4 rounded-lg text-sm`;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-700', 'text-green-700', 'text-blue-700');

            if (bgColorClass) {
                messageBox.classList.add(bgColorClass);
            } else {
                messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
                messageText.classList.add(isError ? 'text-red-700' : 'text-green-700');
            }
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        // Start the application
        initializeFirebase();
    </script>
</body>
</html>
