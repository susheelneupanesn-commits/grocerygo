<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ------------------------------------- */
/* 1. Base & Reset */
/* ------------------------------------- */
:root {
    --color-primary: #4CAF50; /* Green */
    --color-secondary: #ff9800; /* Orange */
    --color-text: #333;
    --color-light-gray: #f9f9f9;
    --color-border: #ccc;
    --color-error: #f44336;
    --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
}
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}
body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--color-light-gray);
    color: var(--color-text);
}
.container {
    max-width: 650px;
    margin: 0 auto;
    padding: 15px;
}
h1 {
    font-size: 1.8em;
    color: var(--color-primary);
    margin-bottom: 20px;
}

/* ------------------------------------- */
/* 2. Form Elements & Layout */
/* ------------------------------------- */
.form-group {
    margin-bottom: 20px;
}
label {
    display: block;
    margin-bottom: 5px;
    font-weight: 700;
    font-size: 0.95em;
}
input, select {
    display: block;
    width: 100%;
    padding: 12px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 1em;
    transition: border-color 0.3s;
}
input:focus, select:focus {
    border-color: var(--color-primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}
.input-row {
    display: flex;
    gap: 15px;
}
.input-row > .form-group {
    flex: 1;
    margin-bottom: 0;
}

/* ------------------------------------- */
/* 3. Summary & Payment */
/* ------------------------------------- */
.section-title {
    font-size: 1.4em;
    margin: 25px 0 15px 0;
    color: var(--color-primary);
}
#priceSummary {
    padding: 15px;
    background-color: #fff;
    border-radius: 8px;
    border: 1px solid #ddd;
}
#priceSummary div {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 1.05em;
}
#priceSummary strong {
    font-size: 1.2em;
    color: var(--color-primary);
}

#payment-element-container {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #fff;
    box-shadow: var(--shadow-light);
}

/* ------------------------------------- */
/* 4. Buttons & Messages */
/* ------------------------------------- */
button {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    font-weight: 700;
    cursor: pointer;
    margin-top: 15px;
    transition: background-color 0.3s, opacity 0.3s;
}
#getPaymentOptions {
    background-color: var(--color-primary);
    color: white;
}
#getPaymentOptions:hover:not(:disabled) {
    background-color: #43a047;
}
#placeOrder {
    background-color: var(--color-secondary);
    color: white;
}
#placeOrder:hover:not(:disabled) {
    background-color: #fb8c00;
}
button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
.error-message { 
    color: var(--color-error); 
    font-weight: 700;
    padding: 10px;
    border: 1px dashed var(--color-error);
    border-radius: 8px;
    margin-bottom: 15px;
}

/* ------------------------------------- */
/* 5. Service Area Message */
/* ------------------------------------- */
#serviceAreaMessage {
    padding: 10px;
    border-radius: 5px;
    margin-top: -10px; 
    margin-bottom: 10px;
    font-size: 0.9em;
    font-weight: bold;
}
.service-ok {
    background-color: #e8f5e9; /* Light green */
    color: #388e3c; /* Dark green */
}
.service-warn {
    background-color: #fff3e0; /* Light orange */
    color: #e65100; /* Dark orange */
}
</style>
</head>
<body>

<div class="container">
    <h1>ğŸ›’ Your Order Checkout</h1>

    <div id="statusMessage" class="error-message" style="display:none;"></div>

    <form id="checkoutForm">
        <h2 class="section-title">Customer Details</h2>

        <div class="form-group">
            <label for="customerName">Full Name</label>
            <input id="customerName" placeholder="John Doe" value="Test Customer" required>
        </div>
        <div class="input-row">
            <div class="form-group">
                <label for="customerEmail">Email</label>
                <input id="customerEmail" type="email" placeholder="john@example.com" value="test@example.com" required>
            </div>
            <div class="form-group">
                <label for="customerMobile">Mobile</label>
                <input id="customerMobile" placeholder="0412345678" value="0412345678" required>
            </div>
        </div>

        <h2 class="section-title">Delivery Address</h2>
        <div class="form-group">
            <label for="customerAddress">Address Line 1</label>
            <input id="customerAddress" placeholder="123 Queen St" value="123 Queen St" required>
        </div>
        <div class="input-row">
            <div class="form-group">
                <label for="customerSuburb">Suburb</label>
                <input id="customerSuburb" placeholder="Brisbane" value="Brisbane" required>
            </div>
            <div class="form-group">
                <label for="customerState">State</label>
                <select id="customerState" required>
                    <option value="QLD" selected>QLD</option>
                    <option value="NSW">NSW</option>
                    <option value="VIC">VIC</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="customerPostcode">Postcode</label>
            <input id="customerPostcode" placeholder="4000" value="4000" required>
            <div id="serviceAreaMessage" style="display:none;"></div>
        </div>
        
        <div class="form-group">
            <label for="deliverySlot">Delivery Time Slot</label>
            <select id="deliverySlot" required></select>
        </div>
    </form>


    <hr>

    <h2 class="section-title">ğŸ§¾ Order Summary</h2>
    <div id="priceSummary">
        <div>Subtotal: <span id="subtotalAmount"></span></div>
        <div>Delivery Fee: <span id="deliveryFee"></span></div>
        <div style="margin-top: 10px;"><strong>Grand Total:</strong> <span id="grandTotalAmount"></span></div>
    </div>

    <hr>

    <h2 class="section-title">ğŸ’³ Payment</h2>

    <button id="getPaymentOptions">Proceed to Payment</button>

    <div id="payment-element-container" style="display:none;">
        <div id="payment-element"></div>
    </div>

    <button id="placeOrder" style="display:none;">Place Order & Pay</button>
    
    <hr>

    <h2 class="section-title">ğŸ” OTP Verification (Testing Only)</h2>
    <button id="generateOTP">Generate OTP</button>
    <div id="otpDisplay" style="color:var(--color-error);font-weight:bold;margin-top:10px;"></div>
    <div class="form-group">
        <input id="otpInput" placeholder="Enter OTP">
    </div>

</div>

<script type="module">
// Stripe Publishable Key
const STRIPE_PUBLISHABLE_KEY = "pk_test_51SUX2cAtxwsqQt5Tf4eFuJC4uXKoauXjBAU5TiHC7MZnlR7rI6HIyHCMYJFeaCU7rSkQ4FBJD5q53QOw3DPKcOlg00VHp43m4l"; 
const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

// --- DOM ELEMENTS ---
// (All previous DOM element definitions remain here)
const nameElement = document.getElementById("customerName");
const emailElement = document.getElementById("customerEmail");
const mobileElement = document.getElementById("customerMobile");
const addressElement = document.getElementById("customerAddress");
const suburbElement = document.getElementById("customerSuburb");
const stateElement = document.getElementById("customerState");
const postcodeElement = document.getElementById("customerPostcode");
const deliverySlotElement = document.getElementById("deliverySlot");
const subtotalSpan = document.getElementById("subtotalAmount");
const feeSpan = document.getElementById("deliveryFee");
const totalSpan = document.getElementById("grandTotalAmount");
const getPaymentOptionsButton = document.getElementById("getPaymentOptions");
const placeOrderButton = document.getElementById("placeOrder");
const paymentElementContainer = document.getElementById("payment-element-container");
const otpDisplay = document.getElementById("otpDisplay");
const otpInput = document.getElementById("otpInput");
const statusMessage = document.getElementById("statusMessage");
const serviceAreaMessage = document.getElementById("serviceAreaMessage");

let elements; 
let clientSecret;
window.orderNumber; 
let currentOTP = null;

// --- LOGISTICS CONSTANTS (UPDATED FOR FULL SERVICE AREA) ---

// NOTE: These groups now represent the *full* set of postcodes you provided.
// Adjust the grouping based on distance/fee tiers (e.g., A=closest, C=furthest).
const GROUP_A = [4000, 4005, 4006, 4007, 4008, 4101, 4102, 4103, 4120, 4121, 4122, 4151, 4152, 4153, 4154, 4169, 4170, 4171, 4172, 4173, 4174, 4178, 4179]; // Brisbane Inner/East/South (High Density)

const GROUP_B = [4009, 4010, 4011, 4012, 4013, 4014, 4017, 4018, 4025, 4029, 4030, 4031, 4032, 4034, 4035, 4036, 4051, 4053, 4054, 4055, 4059, 4060, 4061, 4064, 4065, 4066, 4067, 4068, 4069, 4070, 4072, 4073, 4074, 4075, 4076, 4077, 4078, 4104, 4105, 4106, 4107, 4108, 4109, 4110, 4111, 4112, 4113, 4114, 4115, 4116, 4117, 4118, 4119, 4123, 4124, 4125, 4127, 4128, 4129, 4130, 4132, 4133, 4155, 4156, 4157, 4158, 4159, 4160, 4161, 4163, 4164, 4165, 4300, 4301]; // Brisbane Outer/Logan/Redlands (Mid Distance)

const GROUP_C = [4303, 4304, 4305, 4306, 4307, 4308, 4311, 4500, 4501, 4502, 4503, 4504, 4505, 4506, 4507, 4508, 4509, 4510, 4511, 4400, 4401]; // Ipswich/Moreton Bay (Long Distance/Lower Density)

const SLOTS = ["8:00-11:00","11:00-15:00","15:00-18:00"];

// IMPORTANT: This list must be comprehensive, defining a distance for every serviceable postcode.
// Using realistic distances for the sample set provided:
const POSTCODE_DISTANCES = {
    // Brisbane Inner/East (GROUP A)
Â  Â  4000: 0, 4005: 3, 4006: 5, 4007: 7, 4101: 2, 4102: 4, 4121: 8, 4151: 10, 4171: 12,
    // Brisbane Outer (GROUP B)
Â  Â  4011: 15, 4017: 20, 4034: 18, 4110: 16, 4127: 22, 4132: 25, 4157: 28, 4300: 30,
    // Ipswich/Moreton Bay (GROUP C)
Â  Â  4305: 40, 4306: 45, 4503: 50, 4509: 55, 4510: 60,
    // ... ADD ALL POSTCODES YOU PROVIDED HERE with their respective distances in km ...
};

const DISTANCE_FEES = [
Â  { maxKm: 10, fee: 10 },
Â  { maxKm: 25, fee: 15 }, // Adjusted threshold for Mid Distance
Â  { maxKm: 40, fee: 20 },
Â  { maxKm: Infinity, fee: 25 } // Max fee for > 40km
];

// --- LOGISTICS FUNCTIONS ---
// (The logic for getPostcodeGroup, getDayIndex, getAvailableSlots, and calculateDeliveryFee remains the same, 
// but now uses the updated constants above)

function getPostcodeGroup(postcode){
Â  const pc = Number(postcode);
Â  if(GROUP_A.includes(pc)) return 'A';
Â  if(GROUP_B.includes(pc)) return 'B';
Â  if(GROUP_C.includes(pc)) return 'C';
Â  return null;
}
function getDayIndex(){ return new Date().getDay(); }

function getAvailableSlots(postcode){
Â  const group = getPostcodeGroup(postcode);
Â  if(!group) return [];
Â  const day = getDayIndex();
Â  // Delivery Rotation Logic:
Â  const rotation = {
Â  Â  'A': {1: [SLOTS[1],SLOTS[2]], 2: [SLOTS[0], SLOTS[1]], 3: [SLOTS[1], SLOTS[2]], 4: [SLOTS[0], SLOTS[1]], 5: [SLOTS[0], SLOTS[1], SLOTS[2]], 6: [SLOTS[0], SLOTS[2]]},
Â  Â  'B': {1: [SLOTS[0]], 3: [SLOTS[1]], 5: [SLOTS[2]], 6: [SLOTS[1]]},
Â  Â  'C': {2: [SLOTS[0]], 4: [SLOTS[2]]} // Longest distance, minimal slot days
Â  };
Â  return rotation[group] ? (rotation[group][day] || []) : [];
}

function calculateDeliveryFee(postcode){
Â  const dist = POSTCODE_DISTANCES[Number(postcode)];
Â  if(dist===undefined) return -1; // -1 means non-serviceable
Â  for(const df of DISTANCE_FEES){
Â  Â  if(dist<=df.maxKm) return df.fee;
Â  }
Â  return 25;
}

// --- UTILITY & TROLLEY ---
function formatCurrency(amount) {
Â  return new Intl.NumberFormat('en-AU', { style:'currency', currency:'AUD' }).format(amount);
}
function displayError(message) { statusMessage.innerText = message; statusMessage.style.display = 'block'; }
function clearError() { statusMessage.style.display = 'none'; statusMessage.innerText = ''; }

const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley") || "[]");
let subtotal = trolley.reduce((s,i)=>s+(i.price || 0)*(i.quantity || 1),0);

// --- MAIN UI UPDATE FUNCTION ---
const updateSummary = (postcode) => {
Â  const fee = calculateDeliveryFee(postcode);
Â  let total = subtotal + (fee > 0 ? fee : 0);
  
Â  // 1. Handle Service Area Message
  serviceAreaMessage.style.display = 'block';
  if (fee === -1) {
      serviceAreaMessage.className = 'service-area-message service-warn';
      serviceAreaMessage.textContent = `âš ï¸ Postcode ${postcode} is outside our current delivery range.`;
      getPaymentOptionsButton.disabled = true;
      feeSpan.innerText = 'N/A';
      totalSpan.innerText = 'N/A';
      total = 0;
  } else {
      serviceAreaMessage.className = 'service-area-message service-ok';
      serviceAreaMessage.textContent = `âœ… Delivery service available! Estimated Fee: ${formatCurrency(fee)}`;
      getPaymentOptionsButton.disabled = false;
      feeSpan.innerText = formatCurrency(fee);
      totalSpan.innerText = formatCurrency(total);
  }

Â  // 2. Update summary display
  subtotalSpan.innerText = formatCurrency(subtotal);
  
Â  // 3. Update Delivery Slots
Â  const slots = getAvailableSlots(postcode);
Â  deliverySlotElement.innerHTML = '';
Â  const defaultOption = document.createElement("option");
Â  defaultOption.value = "";
Â  defaultOption.disabled = true;
Â  defaultOption.selected = true;
Â  deliverySlotElement.appendChild(defaultOption);

  if (fee === -1) {
      defaultOption.textContent = "Cannot select slot (Out of area)";
      deliverySlotElement.disabled = true;
  } else if (slots.length === 0) {
      defaultOption.textContent = "No slots available today";
      deliverySlotElement.disabled = true;
      getPaymentOptionsButton.disabled = true; // Cannot proceed without a slot
      displayError("No delivery slots are available for your postcode today. Please check back tomorrow.");
  } else {
      defaultOption.textContent = "Select a time slot";
      deliverySlotElement.disabled = false;
      clearError(); // Clear error if slots are found
  }

Â  slots.forEach(slot => {
Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  option.value = slot;
Â  Â  Â  option.textContent = slot;
Â  Â  Â  deliverySlotElement.appendChild(option);
Â  });
};


// --- STRIPE & OTP LOGIC ---
// (All previous event listeners and payment processing logic remains here, ensuring 
// that `getPaymentOptionsButton` remains disabled if the fee is -1 or slots.length is 0)

document.getElementById("generateOTP").onclick = () => {
Â  currentOTP = Math.floor(1000 + Math.random() * 9000); 
Â  otpDisplay.innerText = `Generated OTP: ${currentOTP}`;
};
postcodeElement.oninput = (e) => updateSummary(e.target.value.trim());
updateSummary(postcodeElement.value.trim()); 

getPaymentOptionsButton.onclick = async (e) => {
Â  Â  e.preventDefault();
Â  Â  clearError();
    
    // ... (Validation and Fetch logic as provided in the previous response) ...
    const customer = {
Â  Â  Â  Â  name: nameElement.value.trim(), email: emailElement.value.trim(), mobile: mobileElement.value.trim(),
Â  Â  Â  Â  address: addressElement.value.trim(), suburb: suburbElement.value.trim(), state: stateElement.value,
Â  Â  Â  Â  postcode: postcodeElement.value.trim(), deliverySlot: deliverySlotElement.value, 
Â  Â  };
    if (Object.values(customer).some(val => !val)) {
Â  Â  Â  Â  displayError("Please ensure all customer fields and a delivery slot are selected.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  getPaymentOptionsButton.disabled = true;
Â  Â  getPaymentOptionsButton.innerText = "Processing...";

Â  Â  try {
        const res = await fetch("/api/create-payment-intent", {
Â  Â  Â  Â  Â  Â  method: "POST", headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ trolley, customer })
Â  Â  Â  Â  });
    
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  if (data.error) {
Â  Â  Â  Â  Â  Â  displayError(`Server error: ${data.error}`);
Â  Â  Â  Â  Â  Â  getPaymentOptionsButton.innerText = "Proceed to Payment";
Â  Â  Â  Â  Â  Â  getPaymentOptionsButton.disabled = false;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  clientSecret = data.clientSecret;
Â  Â  Â  Â  window.orderNumber = data.orderNumber;
    
Â  Â  Â  Â  elements = stripe.elements({ clientSecret, appearance: { theme: 'stripe' } });
Â  Â  Â  Â  elements.create("payment").mount("#payment-element");

Â  Â  Â  Â  paymentElementContainer.style.display = 'block';
Â  Â  Â  Â  placeOrderButton.style.display = 'block';
Â  Â  Â  Â  getPaymentOptionsButton.style.display = 'none';
        
        document.querySelectorAll('form input, form select').forEach(el => el.disabled = true);
        
Â  Â  } catch (err) {
Â  Â  Â  Â  displayError("An unknown network error occurred. Check server connection.");
Â  Â  Â  Â  getPaymentOptionsButton.innerText = "Proceed to Payment";
Â  Â  Â  Â  getPaymentOptionsButton.disabled = false;
Â  Â  }
};

placeOrderButton.onclick = async (e)=>{
Â  e.preventDefault();
Â  clearError();

Â  if(!currentOTP || Number(otpInput.value) !== currentOTP){
Â  Â  displayError("Invalid OTP. Generate and enter the correct OTP.");
Â  Â  return;
Â  }
Â Â 
Â  placeOrderButton.innerText = "Processing Payment...";
Â  placeOrderButton.disabled = true;

Â  const { error: stripeError } = await stripe.confirmPayment({
Â  Â  elements: elements,
Â  Â  confirmParams: {
Â  Â  Â  return_url: `${window.location.origin}/success.html?order=${window.orderNumber}`,Â 
Â  Â  },
Â  });

Â  if(stripeError){
Â  Â  displayError(`Payment failed: ${stripeError.message}`);
Â  Â  placeOrderButton.innerText = "Place Order & Pay";
Â  Â  placeOrderButton.disabled = false;
Â  }
};
</script>
</body>
</html>
