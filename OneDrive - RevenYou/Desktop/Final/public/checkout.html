<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Checkout | GroceryGo</title>

<script src="https://js.stripe.com/v3/"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #fafafa;
        margin: 0;
        padding: 0;
    }
    header {
        padding: 15px;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .container {
        padding: 20px;
        max-width: 600px;
        margin: auto;
    }
    .card {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .flex {
        display: flex;
        gap: 10px;
    }
    .input {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 6px;
    }
    button {
        width: 100%;
        padding: 14px;
        border: none;
        background: #2a7aee;
        color: white;
        font-size: 16px;
        border-radius: 10px;
        margin-top: 15px;
    }
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
    }
    #card-element {
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-top: 8px;
    }
    #confirmationBox {
        margin-top: 20px;
        padding: 20px;
        background: #e8ffe9;
        border-radius: 10px;
        display: none;
        text-align: center;
    }
    .back-link {
        display: inline-block;
        margin-top: 10px;
        text-align: center;
        width: 100%;
        color: #2a7aee;
        text-decoration: underline;
    }
</style>
</head>
<body>

<header>
    <h3>Checkout</h3>
    <a href="trolley.html" class="back-link">Back to Trolley</a>
</header>

<div class="container">

    <!-- CUSTOMER DETAILS -->
    <div class="card">
        <h3>Your Details</h3>
        <input id="name" class="input" placeholder="Full Name" />
        <input id="email" class="input" placeholder="Email" />
        <input id="phone" class="input" placeholder="Phone" />
        <input id="address" class="input" placeholder="Street Address" />
        <input id="suburb" class="input" placeholder="Suburb" />
        <input id="postcode" class="input" placeholder="Postcode" />
    </div>

    <!-- DELIVERY SLOT -->
    <div class="card">
        <h3>Delivery Time</h3>
        <select id="deliverySlot" class="input">
            <option value="">Select delivery slot</option>
        </select>
    </div>

    <!-- ORDER SUMMARY -->
    <div class="card">
        <h3>Order Summary</h3>

        <div id="summaryItems"></div>

        <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotalDisplay">$0.00</span>
        </div>

        <div class="summary-row">
            <span>Delivery Fee</span>
            <span id="deliveryFeeDisplay">$0.00</span>
        </div>

        <hr>

        <div class="summary-row" style="font-size:18px;font-weight:bold;">
            <span>Total</span>
            <span id="grandTotalDisplay">$0.00</span>
        </div>
    </div>

    <!-- STRIPE -->
    <div class="card">
        <h3>Payment</h3>
        <div id="card-element"></div>
        <div id="card-errors" style="color:red;margin-top:10px;"></div>
    </div>

    <button id="payBtn">Pay Now</button>

    <!-- CONFIRMATION -->
    <div id="confirmationBox">
        <h2>Order Confirmed!</h2>
        <p id="orderMessage"></p>
    </div>

</div>

<script>
/* -------------------------------
   1. LOAD TROLLEY DATA
---------------------------------*/
const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley")) || [];
const subtotal = parseFloat(localStorage.getItem("grocerygo_subtotal") || "0");

/* Render summary items */
function renderSummary() {
    const box = document.getElementById("summaryItems");
    box.innerHTML = "";

    trolley.forEach(item => {
        box.innerHTML += `
            <div class="summary-row">
                <span>${item.name} (${item.quantity}×)</span>
                <span>$${(item.price * item.quantity).toFixed(2)}</span>
            </div>
        `;
    });

    document.getElementById("subtotalDisplay").textContent = `$${subtotal.toFixed(2)}`;
}

renderSummary();

/* -------------------------------
   2. APPROVED POSTCODES GROUPING
---------------------------------*/

// Your approved list from memory
const approvedPostcodes = [
    4000,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4017,4018,4025,4029,
    4030,4031,4032,4034,4035,4036,4051,4053,4054,4055,4059,4060,4061,4064,4065,
    4066,4067,4068,4069,4070,4072,4073,4074,4075,4076,4077,4078,4101,4102,4103,
    4104,4105,4106,4107,4108,4109,4110,4111,4112,4113,4114,4115,4116,4117,4118,
    4119,4120,4121,4122,4123,4124,4125,4127,4128,4129,4130,4132,4133,4151,4152,
    4153,4154,4155,4156,4157,4158,4159,4160,4161,4163,4164,4165,4169,4170,4171,
    4172,4173,4174,4178,4179,4183,4184,4205,4207,4280,4285,4300,4301,4303,4304,
    4305,4306,4307,4308,4311,4340,4346,4500,4501,4502,4503,4504,4505,4506,4507,
    4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,4518,4519,4520,4521
];

/* Postcode group logic */
function getGroup(postcode) {
    postcode = Number(postcode);

    const groupA = [4300,4301,4303,4304,4305,4306,4307,4308,4311,4340,4346,4114,4117,4118,4124,4125,4127];
    const groupB = [4151,4152,4153,4154,4155,4156,4157,4158,4159,4160,4161,4163,4164,4165];
    const groupC = approvedPostcodes.filter(p => !groupA.includes(p) && !groupB.includes(p));

    if (groupA.includes(postcode)) return "A";
    if (groupB.includes(postcode)) return "B";
    if (groupC.includes(postcode)) return "C";
    return null;
}

/* -------------------------------
   3. DELIVERY FEE BASED ON DISTANCE
---------------------------------*/
function getDeliveryFee(pc) {
    pc = Number(pc);

    const km0_10 = [4000,4005,4006,4007,4008];
    const km10_20 = [4009,4010,4011,4012,4013];
    const km20_30 = [4014,4017,4018,4029];
    const km30_40 = [4030,4031,4032,4034];
    const km40plus = approvedPostcodes.filter(p => ![...km0_10,...km10_20,...km20_30,...km30_40].includes(p));

    if (km0_10.includes(pc)) return 10;
    if (km10_20.includes(pc)) return 15;
    if (km20_30.includes(pc)) return 20;
    if (km30_40.includes(pc)) return 25;
    return 25;
}

/* -------------------------------
   4. DELIVERY SLOT ROTATION
---------------------------------*/
function loadSlots() {
    const pc = document.getElementById("postcode").value;
    const slotSel = document.getElementById("deliverySlot");

    slotSel.innerHTML = `<option value="">Select delivery slot</option>`;

    if (!approvedPostcodes.includes(Number(pc))) {
        slotSel.innerHTML += `<option>Postcode not serviceable</option>`;
        return;
    }

    const group = getGroup(pc);
    const day = new Date().getDay(); // 1=Mon

    let slots = [];

    if (group === "A") {
        slots = ["Monday 8–11", "Wednesday 11–3", "Friday 3–6"];
    }
    if (group === "B") {
        slots = ["Tuesday 8–11", "Thursday 11–3", "Saturday 3–6"];
    }
    if (group === "C") {
        slots = ["Monday 11–3", "Wednesday 3–6", "Friday 8–11"];
    }

    slots.forEach(s => {
        slotSel.innerHTML += `<option value="${s}">${s}</option>`;
    });
}

document.getElementById("postcode").addEventListener("input", () => {
    loadSlots();
    calculateTotals();
});

/* -------------------------------
   5. TOTALS
---------------------------------*/
function calculateTotals() {
    const pc = document.getElementById("postcode").value;
    const fee = getDeliveryFee(pc);

    document.getElementById("deliveryFeeDisplay").textContent = `$${fee.toFixed(2)}`;
    document.getElementById("grandTotalDisplay").textContent = `$${(subtotal + fee).toFixed(2)}`;
}

calculateTotals();

/* -------------------------------
   6. STRIPE SETUP
---------------------------------*/
const stripe = Stripe("YOUR_PUBLISHABLE_KEY_HERE"); 
const elements = stripe.elements();

const card = elements.create("card", { hidePostalCode: true });
card.mount("#card-element");

card.on("change", function(event) {
    const displayError = document.getElementById("card-errors");
    displayError.textContent = event.error ? event.error.message : "";
});

/* -------------------------------
   7. PAY NOW
---------------------------------*/
document.getElementById("payBtn").onclick = async () => {

    const customer = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        suburb: document.getElementById("suburb").value,
        postcode: document.getElementById("postcode").value,
        deliverySlot: document.getElementById("deliverySlot").value
    };

    const res = await fetch("/api/create-payment-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ trolley, customer })
    });

    const data = await res.json();

    const { clientSecret, orderNumber } = data;

    const result = await stripe.confirmCardPayment(clientSecret, {
        payment_method: { card: card }
    });

    if (result.error) {
        alert(result.error.message);
        return;
    }

    // PAYMENT SUCCESS
    document.getElementById("confirmationBox").style.display = "block";
    document.getElementById("orderMessage").textContent =
        `Your order number is ${orderNumber}. A confirmation email has been sent.`;

    localStorage.removeItem("grocerygo_trolley");
    localStorage.removeItem("grocerygo_subtotal");
};
</script>
</body>
</html>
