<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-commerce Checkout</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .StripeElement {
            box-sizing: border-box; height: 48px; padding: 14px;
            border: 1px solid #e5e7eb; border-radius: 0.5rem;
            background-color: white; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 150ms ease;
        }
        .StripeElement--focus { box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.5); border-color: #4f46e5; }
        
        /* Custom styles for the sticky summary on desktop */
        @media (min-width: 1024px) {
            .summary-card { position: sticky; top: 2rem; }
        }
        /* Custom radio button styles */
        .time-slot-radio:checked + label {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .time-slot-radio + label {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 lg:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-4">
            Secure Checkout
        </h1>
        
        <form id="payment-form" class="lg:grid lg:grid-cols-3 lg:gap-12">
            
            <!-- Left Column: Shipping & Payment Details -->
            <div class="lg:col-span-2 space-y-10">

                <!-- Auth Status -->
                <div id="auth-status" class="text-center text-sm p-3 rounded-lg bg-gray-100 text-gray-700">Authenticating...</div>
                
                <!-- Section 1: Contact and Shipping -->
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">1. Shipping Information</h2>
                    
                    <!-- Name and Email -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Billing Name</span>
                            <input id="name" type="text" value="Jane Doe" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Email Address</span>
                            <input id="email" type="email" value="jane.doe@example.com" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </label>
                    </div>

                    <!-- Phone and Address Line 1 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Phone Number</span>
                            <input id="phone" type="tel" value="0412 345 678" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Address Line 1</span>
                            <input id="address" type="text" value="1 King George Square" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </label>
                    </div>

                    <!-- Suburb, State, and Zip -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Suburb (City)</span>
                            <input id="suburb" type="text" value="Brisbane" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">State (e.g., QLD)</span>
                            <input id="state" type="text" value="QLD" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-700">Postcode</span>
                            <input id="zip" type="text" value="4000" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </label>
                    </div>
                </section>
                
                <!-- Section 2: Delivery Slot Picker (New Feature) -->
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">2. Choose Delivery Slot</h2>

                    <!-- Date Picker -->
                    <label class="block">
                        <span class="text-sm font-medium text-gray-700">Select Date</span>
                        <input type="date" id="delivery-date" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </label>

                    <!-- Time Slots -->
                    <div class="space-y-3">
                        <span class="text-sm font-medium text-gray-700 block">Available Time Slots (<span id="selected-day-display">Select a Date</span>)</span>
                        <div id="time-slot-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <!-- Time slots will be dynamically generated here -->
                            <p id="slot-placeholder" class="text-gray-500 col-span-full">Please select a delivery date first.</p>
                        </div>
                        <input type="hidden" id="deliverySlot" value="">
                    </div>
                </section>

                <!-- Section 3: Payment Details -->
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">3. Payment Details</h2>

                    <!-- Stripe Payment Element Container -->
                    <div>
                        <label for="card-element" class="block text-sm font-medium text-gray-700 mb-2">
                            Card Details
                        </label>
                        <div id="card-element"></div>
                    </div>

                    <!-- Message Box -->
                    <div id="message-box" class="hidden p-4 rounded-lg text-sm" role="alert">
                        <p id="message-text" class="font-medium"></p>
                    </div>
                </section>

                <!-- Submit Button for Mobile -->
                <div class="lg:hidden pb-10">
                    <button id="submit-button-mobile" type="submit" 
                            class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-xl transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50 text-lg"
                            disabled>
                        <span id="button-text-mobile">Pay $0.00</span>
                        <div id="spinner-mobile" class="hidden inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white align-middle ml-2"></div>
                    </button>
                </div>
            </div>

            <!-- Right Column: Order Summary (Sticky on Desktop) -->
            <div class="lg:col-span-1 mt-8 lg:mt-0">
                <div class="summary-card bg-indigo-50 p-6 rounded-xl shadow-xl border border-indigo-200 space-y-4">
                    <h2 class="text-2xl font-bold text-indigo-800 pb-3 border-b border-indigo-200">Order Summary</h2>
                    
                    <!-- Dynamic Order Items -->
                    <div id="order-details" class="space-y-2 text-gray-700">
                        <!-- Items will be populated here -->
                    </div>
                    
                    <div class="border-t border-indigo-300 pt-4">
                        <div class="flex justify-between items-center text-lg font-medium text-indigo-700">
                            <span>Delivery Fee Est.</span>
                            <span id="delivery-fee-display" class="font-semibold text-yellow-700">$0.00</span>
                        </div>
                    </div>

                    <div class="border-t border-indigo-300 my-4 pt-4">
                        <div class="flex justify-between items-center font-extrabold text-3xl text-indigo-800">
                            <span>Total</span>
                            <span id="final-total-display">$0.00 AUD</span>
                        </div>
                    </div>
                    
                    <p id="delivery-info" class="text-xs text-indigo-600 font-medium text-center">Enter a valid 4-digit Australian Postcode to calculate delivery.</p>

                    <!-- Submit Button for Desktop -->
                    <button id="submit-button-desktop" type="submit" 
                            class="hidden lg:block w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50 text-lg"
                            disabled>
                        <span id="button-text-desktop">Pay $0.00</span>
                        <div id="spinner-desktop" class="hidden inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white align-middle ml-2"></div>
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, doc, updateDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Load Stripe.js library
        const stripeScript = document.createElement('script');
        stripeScript.src = "https://js.stripe.com/v3/";
        document.head.appendChild(stripeScript);
        
        // --- Globals ---
        const PRODUCT_SUBTOTAL_AUD = 10.00; // Product price in AUD (Dollars)
        window.serverUrl = 'http://localhost:3000/api/create-payment-intent';
        
        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Note: We check if __firebase_config is defined and parse it. If not, it becomes an empty object {}.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let cardElement = null; // Stripe Card Element Instance
        const authStatusElement = document.getElementById('auth-status');
        const publicOrdersPath = `/artifacts/${appId}/public/data/orders`;

        // Mock Available Slots (for dynamic generation)
        const MOCK_SLOTS = {
            'Any Day': ["8:00 AM - 10:00 AM", "10:00 AM - 12:00 PM", "1:00 PM - 3:00 PM", "3:00 PM - 5:00 PM"],
            'Saturday': ["9:00 AM - 1:00 PM", "1:00 PM - 5:00 PM"],
            'Sunday': ["Unavailable (Closed)"]
        };


        // --- Slot Picker Logic ---
        const dateInput = document.getElementById('delivery-date');
        const slotContainer = document.getElementById('time-slot-container');
        const selectedDayDisplay = document.getElementById('selected-day-display');
        const deliverySlotInput = document.getElementById('deliverySlot');
        const slotPlaceholder = document.getElementById('slot-placeholder');

        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-AU', options);
        }

        /**
         * Generates the time slot radio buttons based on the selected date.
         */
        function updateTimeSlots() {
            const selectedDateStr = dateInput.value;
            slotContainer.innerHTML = '';
            deliverySlotInput.value = ''; // Reset slot value
            
            if (!selectedDateStr) {
                selectedDayDisplay.textContent = 'Select a Date';
                slotContainer.innerHTML = `<p id="slot-placeholder" class="text-gray-500 col-span-full">Please select a delivery date first.</p>`;
                checkFormValidity();
                return;
            }

            const selectedDate = new Date(selectedDateStr + 'T00:00:00'); // Use 'T00:00:00' to avoid timezone issues
            const dayOfWeek = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
            selectedDayDisplay.textContent = `${dayOfWeek}, ${selectedDateStr}`;

            let availableSlots = MOCK_SLOTS[dayOfWeek] || MOCK_SLOTS['Any Day'];
            
            if (availableSlots[0] === "Unavailable (Closed)") {
                 slotContainer.innerHTML = `<p class="text-red-600 font-semibold col-span-full">${dayOfWeek} is unavailable for delivery.</p>`;
                 checkFormValidity();
                 return;
            }

            // Generate radio buttons
            availableSlots.forEach((slot, index) => {
                const fullValue = `${selectedDateStr}|${slot}`; // Format: 2025-12-01|8:00 AM - 10:00 AM
                
                slotContainer.innerHTML += `
                    <div>
                        <input type="radio" id="slot-${index}" name="time-slot" value="${fullValue}" class="hidden time-slot-radio" required>
                        <label for="slot-${index}" class="block cursor-pointer p-3 text-center border-2 border-indigo-300 rounded-lg text-sm font-medium hover:bg-indigo-100 transition duration-150 ease-in-out">
                            ${slot}
                        </label>
                    </div>
                `;
            });
            
            // Add listener to update the hidden input and re-check form validity
            slotContainer.querySelectorAll('input[name="time-slot"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    deliverySlotInput.value = e.target.value;
                    checkFormValidity();
                });
            });
            
            // Check validity after slots are generated
            checkFormValidity();
        }

        dateInput.addEventListener('change', updateTimeSlots);
        dateInput.min = new Date().toISOString().split('T')[0]; // Prevent selecting past dates


        // --- Core Functions ---

        function getTrolleyData() {
            return [
                { name: "Premium Widget (Subtotal)", price: PRODUCT_SUBTOTAL_AUD, quantity: 1 }
            ];
        }

        function getCustomerData() {
             return {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                mobile: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                suburb: document.getElementById('suburb').value, // Renamed from city
                state: document.getElementById('state').value,
                postcode: document.getElementById('zip').value,
                deliverySlot: document.getElementById('deliverySlot').value 
            };
        }


        /**
         * Updates the UI summary with estimated delivery fee and total.
         */
        function updateOrderSummary(deliveryFeeAud) {
            const totalDollars = (PRODUCT_SUBTOTAL_AUD + deliveryFeeAud).toFixed(2);
            const subtotalDollars = PRODUCT_SUBTOTAL_AUD.toFixed(2);
            
            // 1. Update Order Details List
            const summaryEl = document.getElementById('order-details');
            
            let deliveryDisplay = 'TBD';
            if (document.getElementById('zip').value.length !== 4) {
                 deliveryDisplay = '---';
            } else if (deliveryFeeAud === -1) {
                deliveryDisplay = 'Unavailable';
            } else {
                 deliveryDisplay = `$${deliveryFeeAud.toFixed(2)}`;
            }
            
            summaryEl.innerHTML = `
                <div class="flex justify-between font-semibold">
                    <span>Product Subtotal</span>
                    <span>$${subtotalDollars}</span>
                </div>`;
            
            document.getElementById('delivery-fee-display').textContent = deliveryDisplay;
            
            // 2. Update Total and Button Text (Use the estimated total)
            document.getElementById('final-total-display').textContent = `$${totalDollars} AUD`;
            
            document.getElementById('button-text-desktop').textContent = `Pay $${totalDollars}`;
            document.getElementById('button-text-mobile').textContent = `Pay $${totalDollars}`;
        }

        /**
         * Simulates delivery calculation for UI estimation and checks zip validity.
         */
        function calculateDeliveryEstimate() {
            const zipInput = document.getElementById('zip');
            const infoEl = document.getElementById('delivery-info');
            const zip = zipInput.value.trim();
            let deliveryFeeAud = 0; // Default estimate
            let postcodeMessage = 'Enter a valid 4-digit Australian Postcode.';
            
            if (zip.length === 4 && /^\d{4}$/.test(zip)) {
                // Simple client-side estimation based on your old logic
                if (zip.startsWith('4')) {
                    deliveryFeeAud = 9.99; 
                    postcodeMessage = 'QLD shipping estimate: $9.99.';
                } else if (['2', '3', '5', '6', '7', '8'].includes(zip.charAt(0))) {
                    deliveryFeeAud = 15.00; 
                    postcodeMessage = 'Interstate shipping estimate: $15.00.';
                } else {
                    deliveryFeeAud = 20.00; 
                    postcodeMessage = 'Remote/Other shipping estimate: $20.00.';
                }
            } else {
                deliveryFeeAud = 0;
            }
            
            infoEl.textContent = postcodeMessage;
            updateOrderSummary(deliveryFeeAud);
            checkFormValidity();
        }

        document.getElementById('zip').addEventListener('input', calculateDeliveryEstimate);
        
        /**
         * Checks if the entire form is ready for submission (valid zip, complete card, selected slot).
         */
        function checkFormValidity() {
            const isValidZip = document.getElementById('zip').value.trim().length === 4;
            const isCardComplete = cardElement && cardElement._complete;
            const isSlotSelected = deliverySlotInput.value.length > 0;
            const isFormValid = isValidZip && isCardComplete && isSlotSelected;
            
            document.getElementById('submit-button-desktop').disabled = !isFormValid;
            document.getElementById('submit-button-mobile').disabled = !isFormValid;
        }


        // 1. Initialize Firebase and Authenticate
        async function initializeFirebase() {
            try {
                setLogLevel('debug'); 
                console.log("Attempting Firebase initialization...");
                console.log("App ID:", appId);
                console.log("Firebase Config Object (should contain API Key):", firebaseConfig);

                const errorMsg = "Firebase configuration is missing or invalid. Check the apiKey field.";
                
                // This check throws the error you are seeing if firebaseConfig is {}
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Configuration Error:", errorMsg, { config: firebaseConfig });
                    throw new Error(errorMsg);
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `User ID: ${userId.substring(0, 8)}... (Authenticated)`;
                        authStatusElement.className = 'text-center text-sm p-3 rounded-lg bg-green-100 text-green-700';
                        
                        // Initial setup
                        calculateDeliveryEstimate(); 
                        updateTimeSlots(); // Initialize slot picker
                        initializeStripe(); // Initialize Stripe only after Firebase is ready
                        
                    } else {
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                             await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                
                // Enhanced message to hint at configuration issue
                const displayMsg = error.message.includes("Firebase configuration is missing") 
                    ? `Config Error: Missing API Key. Ensure Firebase config is supplied.` 
                    : `Error: Cannot connect to database. (Details: ${error.message})`;

                authStatusElement.textContent = displayMsg;
                authStatusElement.className = 'text-center text-sm p-3 rounded-lg bg-red-100 text-red-700';
            }
        }

        // 2. Stripe Setup
        function initializeStripe() {
            const stripePublishableKey = 'pk_test_51O7c7wJ1Gz7cR3z3sW2yT8oV6nG3kB0xV0iT7vW1tZ2mX6qT9b4k3pYlX2fG0wW8lR6pYt0tZ4uP0yF3'; 
            
            const stripe = Stripe(stripePublishableKey);
            const elements = stripe.elements();
            
            // Initialize card element and store it globally
            cardElement = elements.create('card');
            cardElement.mount('#card-element');

            const form = document.getElementById('payment-form');
            
            cardElement.on('change', function(event) {
                // Check all validity conditions
                checkFormValidity();
                
                if (event.error) {
                    displayMessage(event.error.message, true);
                } else {
                    document.getElementById('message-box').classList.add('hidden');
                }
            });

            form.addEventListener('submit', (e) => handlePayment(e, stripe, cardElement));
        }
        
        // 3. Payment Handling
        async function handlePayment(event, stripe, card) {
            event.preventDefault();
            if (!userId) return displayMessage("Authentication not complete. Please wait.", true);
            
            const customer = getCustomerData();
            if (!customer.postcode || customer.postcode.length !== 4) {
                 return displayMessage("Please enter a valid 4-digit Australian Postcode.", true);
            }
            if (!customer.deliverySlot) {
                 return displayMessage("Please select a delivery date and time slot.", true);
            }
            
            showProcessing(true);
            
            let orderDocRef;
            let grandTotalAud = 0;

            try {
                const trolley = getTrolleyData();
                
                // A. Create the Order in Firestore (Status: PENDING)
                const newOrder = {
                    customerId: userId,
                    customerName: customer.name,
                    customerEmail: customer.email,
                    shippingAddress: customer,
                    items: trolley, 
                    amountEstimate: PRODUCT_SUBTOTAL_AUD, 
                    status: 'PENDING',
                    createdAt: new Date(),
                    lastUpdated: new Date()
                };

                orderDocRef = await addDoc(collection(db, publicOrdersPath), newOrder);
                const orderId = orderDocRef.id;

                displayMessage(`Order created in Firestore: ${orderId}. Requesting final total and payment intent...`, false, 'bg-blue-100 text-blue-700');
                
                // B. Fetch the Client Secret and definitive Total from Node.js Server
                const response = await fetch(window.serverUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        trolley: trolley, 
                        customer: customer
                    })
                });

                const data = await response.json();

                if (data.error) {
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'FAILED_SERVER_REJECT',
                        serverError: data.error,
                        lastUpdated: new Date()
                    });
                    throw new Error(data.error);
                }

                const clientSecret = data.clientSecret;
                grandTotalAud = data.grandTotal; // Server's source of truth
                const amountInCents = Math.round(grandTotalAud * 100);
                
                // Update Firestore order with final price and PI details
                 await updateDoc(doc(db, publicOrdersPath, orderId), {
                        amountFinal: amountInCents,
                        orderNumber: data.orderNumber, 
                        stripePaymentIntentId: clientSecret.split('_secret')[0],
                        lastUpdated: new Date()
                    });
                
                // C. Confirm Payment with Stripe
                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: card,
                        billing_details: { 
                            name: customer.name,
                            email: customer.email,
                        },
                    }
                });

                if (result.error) {
                    await updateDoc(doc(db, publicOrdersPath, orderId), { status: 'FAILED', lastUpdated: new Date(), paymentError: result.error.message });
                    displayMessage(`Payment Failed: ${result.error.message}. Status set to FAILED in Firestore.`, true);
                } else if (result.paymentIntent.status === 'succeeded') {
                    await updateDoc(doc(db, publicOrdersPath, orderId), { status: 'PAID', lastUpdated: new Date() });
                    
                    window.location.href = `success.html?orderId=${orderId}&orderNumber=${data.orderNumber}`; 
                } else {
                    displayMessage(`Payment status: ${result.paymentIntent.status}. Please check Stripe dashboard.`, true);
                }

            } catch (error) {
                console.error('[Checkout Error]', error);
                displayMessage(`System Error: ${error.message}. Ensure 'server.js' is running.`, true);
            } finally {
                // Final UI update using server-calculated total
                const finalDisplay = grandTotalAud > 0 ? grandTotalAud.toFixed(2) : document.getElementById('final-total-display').textContent.replace('$', '').replace(' AUD', '');
                document.getElementById('final-total-display').textContent = `$${finalDisplay} AUD`;
                showProcessing(false);
            }
        }
        
        // --- UI Helpers ---
        function showProcessing(isProcessing) {
            const buttons = [
                document.getElementById('submit-button-desktop'), 
                document.getElementById('submit-button-mobile')
            ];
            const spinners = [
                document.getElementById('spinner-desktop'), 
                document.getElementById('spinner-mobile')
            ];
            const buttonTexts = [
                document.getElementById('button-text-desktop'),
                document.getElementById('button-text-mobile')
            ];

            buttons.forEach(btn => btn.disabled = isProcessing);
            spinners.forEach(spinner => spinner.classList.toggle('hidden', !isProcessing));
            
            if (!isProcessing) {
                const totalDollars = document.getElementById('final-total-display').textContent.replace('$', '').replace(' AUD', '');
                buttonTexts.forEach(txt => txt.textContent = `Pay ${totalDollars}`);
            } else {
                buttonTexts.forEach(txt => txt.textContent = 'Processing...');
            }
        }

        function displayMessage(text, isError = false, bgColorClass = null) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageBox.className = `p-4 rounded-lg text-sm`;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-700', 'text-green-700', 'text-blue-700');

            if (bgColorClass) {
                messageBox.classList.add(bgColorClass);
            } else {
                messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
                messageText.classList.add(isError ? 'text-red-700' : 'text-green-700');
            }
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        // Start the application
        initializeFirebase();
    </script>
</body>
</html>
