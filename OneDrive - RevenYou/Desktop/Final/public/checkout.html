<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://gikdqaxdqfmzdvolkxbn.supabase.co";
const SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6Ikp..."; // truncated
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

const STRIPE_PUBLISHABLE_KEY = "pk_test_51SUX2KAmiKZAr3Zs..."; // truncated
const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
const elements = stripe.elements();
const card = elements.create("card", { hidePostalCode: true });
card.mount("#card-element");

// DELIVERY FEES
const SERVICE_AREAS = {
  "4000": 10, "4005": 10, "4006": 10, "4007": 10, "4008": 10, "4009": 10,
  "4010": 10, "4011": 10, "4012": 10, "4013": 10, "4014": 10, "4017": 15,
  "4025": 10, "4031": 15, "4034": 15, "4075": 15, "4101": 15, "4120": 15, "4151": 15,
  "4500": 20, "4207": 20, "4300": 20, "4305": 20
};
const MAX_FEE = 20;

function calculateDeliveryFee(postcode) {
  return SERVICE_AREAS[postcode] || 0;
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('en-AU', { style:'currency', currency:'AUD' }).format(amount);
}

// TROLLEY
const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley") || "[]");
if(!trolley.length){
  alert("Your trolley is empty");
  window.location.href = "/index.html";
}
let subtotal = trolley.reduce((s,i)=>s+(i.price*i.quantity),0);
let deliveryFee = 0;

document.getElementById("customerPostcode").oninput = (e)=>{
  const postcode = e.target.value.trim();
  deliveryFee = calculateDeliveryFee(postcode);
  document.getElementById("deliveryFee").innerText = formatCurrency(deliveryFee);
  document.getElementById("grandTotalAmount").innerText = formatCurrency(subtotal + deliveryFee);
}

// OTP generation (for testing, show on screen)
let currentOTP = null;
function generateOTP() {
  currentOTP = Math.floor(100000 + Math.random()*900000);
  document.getElementById("otpDisplay").innerText = `Your OTP for testing: ${currentOTP}`;
}

// PLACE ORDER BUTTON
document.getElementById("placeOrder").onclick = async ()=>{
  const name = document.getElementById("customerName").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const phone = document.getElementById("customerMobile").value.trim();
  const address = document.getElementById("customerAddress").value.trim();
  const suburb = document.getElementById("customerSuburb").value.trim();
  const state = document.getElementById("customerState").value;
  const postcode = document.getElementById("customerPostcode").value.trim();
  const otpInput = document.getElementById("otpInput").value.trim();
  
  if(!name||!email||!phone||!address||!suburb||!state||!postcode){
    alert("Fill all fields");
    return;
  }

  if(!otpInput || otpInput != currentOTP){
    alert("Invalid OTP. Generate and enter the OTP.");
    return;
  }

  const grandTotal = subtotal + deliveryFee;
  const amountInCents = Math.round(grandTotal*100);

  // Create payment intent via API route
  const res = await fetch("/api/create-payment-intent",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      amount: amountInCents,
      trolley,
      customer:{
        name,email,phone,address,suburb,state,postcode,deliveryFee
      }
    })
  });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }

  const result = await stripe.confirmCardPayment(data.clientSecret,{
    payment_method:{ card, billing_details:{ name,email,phone,address:{line1:address,city:suburb,state,postal_code:postcode,country:"AU"} } }
  });

  if(result.error){
    alert("Payment failed: "+result.error.message);
  } else if(result.paymentIntent.status === "succeeded"){
    alert(`Payment successful! Order: ${data.orderNumber}`);
    localStorage.removeItem("grocerygo_trolley");
    window.location.href="/index.html";
  }
};

// GENERATE OTP BUTTON
document.getElementById("generateOTP").onclick = generateOTP;
</script>
</head>
<body>
<div class="container">
<h1>Checkout</h1>
<label>Full Name</label><input id="customerName" placeholder="John Doe">
<label>Email</label><input id="customerEmail" placeholder="john@example.com">
<label>Mobile</label><input id="customerMobile" placeholder="0412345678">
<label>Address</label><input id="customerAddress" placeholder="123 Queen St">
<label>Suburb</label><input id="customerSuburb" placeholder="Brisbane">
<label>State</label>
<select id="customerState">
<option value="QLD" selected>QLD</option>
<option value="NSW">NSW</option>
<option value="VIC">VIC</option>
</select>
<label>Postcode</label><input id="customerPostcode" placeholder="4000">
<div id="priceSummary">
<div>Subtotal: <span id="subtotalAmount">$0.00</span></div>
<div>Delivery Fee: <span id="deliveryFee">$0.00</span></div>
<div>Grand Total: <span id="grandTotalAmount">$0.00</span></div>
</div>
<h2>Payment</h2>
<label>Cardholder Name</label><input id="cardName" placeholder="John Doe">
<div id="card-element" style="padding:12px;border:1px solid #ccc;border-radius:8px;"></div>

<h3>OTP Verification</h3>
<button id="generateOTP">Generate OTP (for testing)</button>
<div id="otpDisplay" style="color:red;font-weight:bold;"></div>
<input id="otpInput" placeholder="Enter OTP">

<button id="placeOrder">Place Order & Pay</button>
</div>
</body>
</html>
