<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>
<style>
/* --- STYLES (UNCHANGED) --- */
body{font-family:Arial,sans-serif;background:#f7f8fa;margin:0;padding:20px;}
.container{background:#fff;padding:20px;max-width:750px;margin:0 auto;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.1);}
h1,h2{color:#0072ce;margin-bottom:12px;}
label{font-weight:bold;margin-bottom:4px;display:block;}
input,select,textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;margin-bottom:12px;font-size:1em;}
textarea{height:80px;resize:none;}
.row{display:flex;gap:12px;flex-wrap:wrap;}
.row div{flex:1;min-width:130px;}
#priceSummary div{font-size:14px;color:#777;margin-bottom:4px;}
#priceSummary .grandTotal{font-size:18px;color:#000;font-weight:bold;margin-top:8px;}
.bottom-bar{display:flex;justify-content:flex-start;margin-top:20px;gap:12px;}
.bottom-bar button{background:#0072ce;border:none;color:white;padding:10px 16px;font-size:1em;border-radius:6px;cursor:pointer;flex:1;}
.bottom-bar button:hover{background:#005fa3;}
#card-element{padding:12px;border:1px solid #ccc;border-radius:6px;background:#fff;margin-bottom:10px;}
#messageOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);justify-content:center;align-items:center;z-index:1000;}
#messageBox{background:#28a745;padding:28px 20px;border-radius:10px;font-size:1.3em;font-weight:bold;color:white;text-align:center;max-width:420px;}
@media(max-width:480px){.row{flex-direction:column;}.bottom-bar{flex-direction:column;gap:10px;}}
</style>
</head>
<body>
<div class="container">
<h1>Checkout</h1>

<label>Full Name</label><input type="text" id="customerName" placeholder="John Doe">
<div class="row">
Â  <div><label>Email</label><input type="email" id="customerEmail" placeholder="john@example.com"></div>
Â  <div><label>Mobile Number</label><input type="text" id="customerMobile" placeholder="0412345678"></div>
</div>
<label>Delivery Address</label><input type="text" id="customerAddress" placeholder="123 Queen St">
<div class="row">
Â  <div><label>Suburb</label><input type="text" id="customerSuburb" placeholder="Brisbane"></div>
Â  <div><label>State</label>
Â  Â  <select id="customerState">
Â  Â  Â  <option value="QLD" selected>Queensland</option>
Â  Â  Â  <option value="NSW">New South Wales</option>
Â  Â  Â  <option value="VIC">Victoria</option>
Â  Â  Â  <option value="WA">Western Australia</option>
Â  Â  Â  <option value="SA">South Australia</option>
Â  Â  Â  <option value="TAS">Tasmania</option>
Â  Â  Â  <option value="NT">Northern Territory</option>
Â  Â  Â  <option value="ACT">ACT</option>
Â  Â  </select>
Â  </div>
Â  <div><label>Postcode</label><input type="text" id="customerPostcode" placeholder="4000"></div>
</div>

<label>Select your preferred delivery time</label>
<select id="deliverySlot"><option value="">Choose your time slot</option></select>

<div id="priceSummary">
Â  <div>Subtotal: $<span id="subtotalAmount">0.00</span></div>
Â  <div>Delivery Fee: $<span id="deliveryFee">0.00</span></div>
Â  <div class="grandTotal">Grand Total: $<span id="grandTotalAmount">0.00</span></div>
</div>

<h2>Payment Details</h2>
<label>Cardholder Name</label><input type="text" id="cardName" placeholder="John Doe">
<div><label>Card Details</label><div id="card-element"></div></div>

<label>Special Instructions</label><textarea id="specialInstructions" placeholder="E.g., Leave at front door"></textarea>

<div class="bottom-bar">
Â  <button id="backTrolley">â—€ï¸ Back to Trolley</button>
Â  <button id="placeOrder">Place Order & Pay</button>
</div>
</div>

<div id="messageOverlay"><div id="messageBox"></div></div>

<script>
// NOTE: Populate this array with your allowed postcodes as NUMBERS
const allowedPostcodes = [/* e.g., 4000, 4001, 4101 */];

const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley")||"[]");
if(!trolley.length){ 
    alert("Your trolley is empty!"); 
    window.location.href="trolley.html"; 
}

let subtotal = trolley.reduce((sum,item)=>sum+(item.price||0)*item.quantity,0);
let deliveryFee = 0; 

function updateTotals(){
    const grandTotal = subtotal + deliveryFee;
    document.getElementById("subtotalAmount").innerText = subtotal.toFixed(2);
    document.getElementById("deliveryFee").innerText = deliveryFee.toFixed(2);
    document.getElementById("grandTotalAmount").innerText = grandTotal.toFixed(2);
}
updateTotals();

// Delivery slots next 7 days
const deliverySlotSelect = document.getElementById("deliverySlot");
for(let i=0;i<7;i++){
Â  const d = new Date();
Â  d.setDate(d.getDate()+i);
Â  const day = d.toLocaleDateString('en-AU',{weekday:'short',day:'numeric',month:'short'});
Â  ["10amâ€“2pm","2pmâ€“6pm"].forEach(slot=>{
Â  Â  const opt = document.createElement("option");
Â  Â  opt.value = `${day} ${slot}`;
Â  Â  opt.textContent = `${day} ${slot}`;
Â  Â  deliverySlotSelect.appendChild(opt);
Â  });
}

// Stripe setup
const stripe = Stripe("pk_test_51SUX2KAmiKZAr3Zsst3DLkjb2baO00udZQmzHBzqTqrZKJHoUM5g2WjUZmQVJdWNYBcq6KdcHIoedSOchASoCuTr00Ivou7q1b");
const elements = stripe.elements();
const card = elements.create("card");
card.mount("#card-element");

document.getElementById("backTrolley").onclick = ()=>window.location.href="trolley.html";

// --- REVISED PLACE ORDER FUNCTION START (Replace the whole block in checkout.html) ---
document.getElementById("placeOrder").onclick = async ()=>{
  // 1. Collect all form data
  const name = document.getElementById("customerName").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const phone = document.getElementById("customerMobile").value.trim();
  const address = document.getElementById("customerAddress").value.trim();
  const suburb = document.getElementById("customerSuburb").value.trim();
  const state = document.getElementById("customerState").value;
  const postcode = document.getElementById("customerPostcode").value.trim();
  const slot = document.getElementById("deliverySlot").value;
  const cardName = document.getElementById("cardName").value.trim();
  const special = document.getElementById("specialInstructions").value.trim();
  const country = 'AU'; // Explicitly set for Stripe billing details

  // 2. Basic client-side validation
  if(!name||!email||!phone||!address||!suburb||!state||!postcode||!slot||!cardName){
    alert("Please fill all fields and select a delivery slot.");
    return;
  }

  // 3. Postcode service area check
  const postcodeNumber = parseInt(postcode, 10);
  if(allowedPostcodes.length > 0 && !allowedPostcodes.includes(postcodeNumber)){
    alert("Sorry, delivery is not available in your area (" + postcode + ").");
    return;
  }

  // --- ğŸ¯ NEW/FIXED CALCULATION ---
  const grandTotal = subtotal + deliveryFee; 
  // Convert the grand total (e.g., 10.50) into cents (1050) as an integer.
  const amountInCents = Math.round(grandTotal * 100); 
  // ---------------------------------

  try{
    // 4. Create Payment Intent on the server
    const response = await fetch("/create-payment-intent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        amount: amountInCents, // <-- CRITICAL FIX: Send the amount in cents
        trolley, 
        customer:{name,email,phone,address,suburb,state,postcode,slot,special}
      })
    });
    
    const data = await response.json();
    if(data.error) throw new Error(data.error);

    // 5. Confirm Payment with Stripe
    const result = await stripe.confirmCardPayment(data.clientSecret,{
      payment_method:{
        card: card,
        billing_details: {
          name: cardName,
          email: email,
          phone: phone,
          address: {
            line1: address,
            city: suburb,
            state: state,
            postal_code: postcode,
            country: country, 
          },
        },
      }
    });

    if(result.error){ 
      alert("Payment failed: "+result.error.message); 
      return; 
    }

    // 6. Payment Success
    document.getElementById("messageBox").innerHTML =
      `âœ… Payment Successful!<br>Your order no: GGO-${Math.floor(100000+Math.random()*900000)}`;
    document.getElementById("messageOverlay").style.display="flex";
    localStorage.removeItem("grocerygo_trolley");
    setTimeout(()=>window.location.href="index.html",5000);
  }catch(err){ 
    alert(err.message); 
  }
};

</script>
</body>
</html>