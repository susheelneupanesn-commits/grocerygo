<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ------------------------------------- */
/* 1. Base & Reset */
/* ------------------------------------- */
:root {
    --primary: #4CAF50;
    --secondary: #ff9800;
    --text: #333;
    --bg-light: #f9f9f9;
    --border: #ddd;
    --error: #f44336;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
}
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Roboto', sans-serif; }
body { background: var(--bg-light); color: var(--text); line-height:1.5; }
.container { max-width: 700px; margin: 20px auto; padding: 15px; }
h1,h2 { color: var(--primary); margin-bottom: 15px; }
h1 { font-size: 1.8em; }
h2 { font-size: 1.4em; margin-top: 30px; }
a.back-link { display:inline-block; margin-bottom:15px; color:var(--primary); font-weight:bold; text-decoration:none; }
.error-message { color: var(--error); background: #ffe6e6; padding:10px; border-radius:8px; margin-bottom:15px; display:none; }

/* ------------------------------------- */
/* 2. Cards & Forms */
/* ------------------------------------- */
.card { background:#fff; padding:20px; border-radius:10px; box-shadow: var(--shadow); margin-bottom:20px; }
.form-group { margin-bottom:15px; }
label { display:block; font-weight:700; margin-bottom:5px; }
input, select { width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:1em; }
input:focus, select:focus { outline:none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(76,175,80,0.2); }
.input-row { display:flex; gap:15px; flex-wrap:wrap; }
.input-row > .form-group { flex:1; min-width:120px; }

/* ------------------------------------- */
/* 3. Summary & Payment */
/* ------------------------------------- */
#priceSummary div { display:flex; justify-content:space-between; padding:5px 0; }
#priceSummary strong { color: var(--primary); font-size:1.1em; }
#payment-element-container { margin-top:20px; }

/* ------------------------------------- */
/* 4. Buttons & Responsive */
/* ------------------------------------- */
button { width:100%; padding:15px; border:none; border-radius:8px; font-weight:700; font-size:1.1em; cursor:pointer; margin-top:15px; transition:0.3s; }
#getPaymentOptions { background: var(--primary); color:#fff; }
#getPaymentOptions:hover:not(:disabled) { background:#43a047; }
#placeOrder { background: var(--secondary); color:#fff; }
#placeOrder:hover:not(:disabled) { background:#fb8c00; }
button:disabled { opacity:0.6; cursor:not-allowed; }

/* ------------------------------------- */
/* 5. Service Message */
/* ------------------------------------- */
#serviceAreaMessage { padding:10px; border-radius:6px; margin-top:5px; font-weight:bold; }
.service-ok { background:#e8f5e9; color:#388e3c; }
.service-warn { background:#fff3e0; color:#e65100; }

/* ------------------------------------- */
/* 6. Mobile adjustments */
/* ------------------------------------- */
@media(max-width:500px){
  .input-row { flex-direction:column; }
  h1,h2 { font-size:1.5em; }
}
</style>
</head>
<body>

<div class="container">
    <a href="./trolley.html" class="back-link">‚Üê Back to Trolley</a>
    <h1>üõí Checkout</h1>

    <div id="statusMessage" class="error-message"></div>

    <!-- Customer Details -->
    <div class="card">
        <h2>Customer Details</h2>
        <div class="form-group">
            <label for="customerName">Full Name</label>
            <input id="customerName" placeholder="John Doe" value="Test Customer" required>
        </div>
        <div class="input-row">
            <div class="form-group">
                <label for="customerEmail">Email</label>
                <input id="customerEmail" type="email" placeholder="john@example.com" value="test@example.com" required>
            </div>
            <div class="form-group">
                <label for="customerMobile">Mobile</label>
                <input id="customerMobile" placeholder="0412345678" value="0412345678" required>
            </div>
        </div>
    </div>

    <!-- Delivery Address -->
    <div class="card">
        <h2>Delivery Address</h2>
        <div class="form-group">
            <label for="customerAddress">Address Line 1</label>
            <input id="customerAddress" placeholder="123 Queen St" value="123 Queen St" required>
        </div>
        <div class="input-row">
            <div class="form-group">
                <label for="customerSuburb">Suburb</label>
                <input id="customerSuburb" placeholder="Brisbane" value="Brisbane" required>
            </div>
            <div class="form-group">
                <label for="customerState">State</label>
                <select id="customerState" required>
                    <option value="QLD" selected>QLD</option>
                    <option value="NSW">NSW</option>
                    <option value="VIC">VIC</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="customerPostcode">Postcode</label>
            <input id="customerPostcode" placeholder="4000" value="4000" required>
            <div id="serviceAreaMessage"></div>
        </div>
        <div class="form-group">
            <label for="deliverySlot">Delivery Time Slot</label>
            <select id="deliverySlot" required></select>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="card">
        <h2>Order Summary</h2>
        <div id="priceSummary">
            <div>Subtotal: <span id="subtotalAmount"></span></div>
            <div>Delivery Fee: <span id="deliveryFee"></span></div>
            <div><strong>Grand Total:</strong> <span id="grandTotalAmount"></span></div>
        </div>
    </div>

    <!-- Payment -->
    <div class="card">
        <h2>Payment</h2>
        <button id="getPaymentOptions">Proceed to Payment</button>
        <div id="payment-element-container" style="display:none;"><div id="payment-element"></div></div>
        <button id="placeOrder" style="display:none;">Place Order & Pay</button>
    </div>

    <!-- OTP Verification -->
    <div class="card">
        <h2>OTP Verification (Testing Only)</h2>
        <button id="generateOTP">Generate OTP</button>
        <div id="otpDisplay" style="color:var(--error);font-weight:bold;margin-top:10px;"></div>
        <div class="form-group">
            <input id="otpInput" placeholder="Enter OTP">
        </div>
    </div>
</div>

<script type="module">
// ----------------------
// Stripe & DOM elements
// ----------------------
const STRIPE_PUBLISHABLE_KEY = "pk_test_51SUX2cAtxwsqQt5Tf4eFuJC4uXKoauXjBAU5TiHC7MZnlR7rI6HIyHCMYJFeaCU7rSkQ4FBJD5q53QOw3DPKcOlg00VHp43m4l";
const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

const nameEl = document.getElementById("customerName");
const emailEl = document.getElementById("customerEmail");
const mobileEl = document.getElementById("customerMobile");
const addressEl = document.getElementById("customerAddress");
const suburbEl = document.getElementById("customerSuburb");
const stateEl = document.getElementById("customerState");
const postcodeEl = document.getElementById("customerPostcode");
const deliverySlotEl = document.getElementById("deliverySlot");
const subtotalSpan = document.getElementById("subtotalAmount");
const feeSpan = document.getElementById("deliveryFee");
const totalSpan = document.getElementById("grandTotalAmount");
const getPaymentBtn = document.getElementById("getPaymentOptions");
const placeOrderBtn = document.getElementById("placeOrder");
const paymentContainer = document.getElementById("payment-element-container");
const otpDisplay = document.getElementById("otpDisplay");
const otpInput = document.getElementById("otpInput");
const statusMessage = document.getElementById("statusMessage");
const serviceAreaMessage = document.getElementById("serviceAreaMessage");

let elements, clientSecret, currentOTP = null;
window.orderNumber = null;

// ----------------------
// Logistics Data
// ----------------------
const GROUP_A = [4300,4301,4303,4304,4305,4306,4307,4308,4311,4114,4118,4124,4125,4127,4128,4129,4131,4132,4133,4207,4280,4285,4290];
const GROUP_B = [4169,4170,4171,4172,4173,4174,4178,4179,4157,4158,4159,4160,4161,4163,4164,4165];
const GROUP_C = [4000,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4017,4018,4025,4029,4030,4031,4032,4034,4035,4036,4051,4053,4054,4055,4059,4060,4061,4064,4065,4066,4067,4068,4069,4070,4072,4073,4074,4075,4076,4077,4078,4101,4102,4103,4104,4105,4106,4107,4108,4109,4110,4111,4112,4113,4114,4115,4116,4117,4118,4119,4120,4121,4122,4123,4124,4125,4127,4128,4129,4130,4132,4133,4151,4152,4153,4154,4155,4156,4157,4158,4159,4160,4161,4163,4164,4165,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4520];

const SLOTS = ["8:00-11:00","11:00-15:00","15:00-18:00"];
const POSTCODE_DISTANCES = Object.fromEntries([...GROUP_A,...GROUP_B,...GROUP_C].map((p,i)=>{
  if(GROUP_A.includes(p)) return [p,30+i%5];
  if(GROUP_B.includes(p)) return [p,15+i%5];
  if(GROUP_C.includes(p)) return [p,1+i%10];
}));

const DISTANCE_FEES = [{maxKm:10,fee:10},{maxKm:20,fee:15},{maxKm:30,fee:20},{maxKm:Infinity,fee:25}];

function getPostcodeGroup(pc){ const p=Number(pc); if(GROUP_A.includes(p)) return'A'; if(GROUP_B.includes(p)) return'B'; if(GROUP_C.includes(p)) return'C'; return null; }
function getDayIndex(){ return new Date().getDay(); }
function getAvailableSlots(pc){ return getAvailableSlotsByDay(pc,getDayIndex()); }
function getAvailableSlotsByDay(pc,day){ 
  const group=getPostcodeGroup(pc); if(!group||day===0)return[];
  const rotation={'A':{1:[SLOTS[0]],2:[],3:[SLOTS[1]],4:[],5:[SLOTS[2]],6:[]},'B':{1:[],2:[SLOTS[0]],3:[],4:[SLOTS[1]],5:[],6:[SLOTS[2]]},'C':{1:[SLOTS[1],SLOTS[2]],2:[SLOTS[1],SLOTS[2]],3:[SLOTS[0],SLOTS[2]],4:[SLOTS[0],SLOTS[2]],5:[SLOTS[0],SLOTS[1]],6:[SLOTS[0],SLOTS[1]]}}; 
  return rotation[group][day]||[];
}
function calculateDeliveryFee(pc){ const d=POSTCODE_DISTANCES[Number(pc)]; if(d===undefined)return-1; for(const f of DISTANCE_FEES){ if(d<=f.maxKm) return f.fee; } return 25; }
function formatCurrency(amount){ return new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'}).format(amount); }
function displayError(msg){ statusMessage.innerText=msg; statusMessage.style.display='block'; }
function clearError(){ statusMessage.style.display='none'; statusMessage.innerText=''; }

const trolley=JSON.parse(localStorage.getItem("grocerygo_trolley")||"[]");
let subtotal=trolley.reduce((s,i)=>s+(i.price||0)*(i.quantity||1),0);

function updateSummary(postcode){
  const fee=calculateDeliveryFee(postcode);
  let total=subtotal+(fee>0?fee:0);
  serviceAreaMessage.style.display='block';
  getPaymentBtn.disabled=true;

  if(fee===-1){ serviceAreaMessage.className='service-warn'; serviceAreaMessage.textContent=`‚ö†Ô∏è Postcode ${postcode} is outside our delivery range`; feeSpan.innerText='N/A'; totalSpan.innerText='N/A'; }
  else{ serviceAreaMessage.className='service-ok'; serviceAreaMessage.textContent=`‚úÖ Service available. Distance: ${POSTCODE_DISTANCES[Number(postcode)].toFixed(1)} km. Fee: ${formatCurrency(fee)}`; feeSpan.innerText=formatCurrency(fee); totalSpan.innerText=formatCurrency(total); }

  subtotalSpan.innerText=formatCurrency(subtotal);

  let slots=getAvailableSlots(postcode);
  if(slots.length===0 && fee!==-1){
    const today=getDayIndex();
    for(let i=1;i<=6;i++){ const nextDay=(today+i)%7; slots=getAvailableSlotsByDay(postcode,nextDay); if(slots.length>0)break; }
  }

  deliverySlotEl.innerHTML='';
  const defaultOption=document.createElement('option');
  defaultOption.value=''; defaultOption.disabled=true; defaultOption.selected=true;
  defaultOption.textContent=slots.length>0?"Select a time slot":"No slots available";
  deliverySlotEl.appendChild(defaultOption);
  slots.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; deliverySlotEl.appendChild(o); });
  deliverySlotEl.disabled=slots.length===0;
  getPaymentBtn.disabled=slots.length===0;
}

postcodeEl.oninput=(e)=>updateSummary(e.target.value.trim());
updateSummary(postcodeEl.value.trim());

document.getElementById("generateOTP").onclick=()=>{ currentOTP=Math.floor(1000+Math.random()*9000); otpDisplay.innerText=`Generated OTP: ${currentOTP}`; };

// Payment Button
getPaymentBtn.onclick=async(e)=>{ 
  e.preventDefault(); clearError();
  const customer={name:nameEl.value.trim(),email:emailEl.value.trim(),mobile:mobileEl.value.trim(),address:addressEl.value.trim(),suburb:suburbEl.value.trim(),state:stateEl.value,postcode:postcodeEl.value.trim(),deliverySlot:deliverySlotEl.value};
  if(Object.values(customer).some(v=>!v)){ displayError("Please fill all customer fields and select a delivery slot."); return; }

  getPaymentBtn.disabled=true; getPaymentBtn.innerText="Processing...";
  try{
    const mockResponse={ok:true,json:()=>Promise.resolve({clientSecret:"pi_fake_client_secret_xyz",orderNumber:Math.floor(100000+Math.random()*900000).toString()})};
    const res=await mockResponse;
    const data=await res.json();
    clientSecret=data.clientSecret; window.orderNumber=data.orderNumber;
    elements=stripe.elements({clientSecret,appearance:{theme:'stripe'}});
    elements.create("payment").mount("#payment-element");
    paymentContainer.style.display='block'; placeOrderBtn.style.display='block'; getPaymentBtn.style.display='none';
    document.querySelectorAll('form input, form select').forEach(el=>el.disabled=true);
  }catch(err){ displayError("Network error. Check server."); getPaymentBtn.innerText="Proceed to Payment"; getPaymentBtn.disabled=false; }
};

// Place Order Button
placeOrderBtn.onclick=async(e)=>{
  e.preventDefault(); clearError();
  if(!currentOTP||Number(otpInput.value)!==currentOTP){ displayError("Invalid OTP. Generate and enter the correct OTP."); return; }
  placeOrderBtn.innerText="Processing Payment..."; placeOrderBtn.disabled=true;
  setTimeout(()=>{ window.location.href=`${window.location.origin}/success.html?order=${window.orderNumber}`; },1500);
};
</script>
</body>
</html>
