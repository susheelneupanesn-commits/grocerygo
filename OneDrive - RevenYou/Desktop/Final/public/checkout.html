<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ------------------------------------- */
/* 1. Base & Reset */
/* ------------------------------------- */
:root {
    --color-primary: #4CAF50; /* Green */
    --color-secondary: #ff9800; /* Orange */
    --color-text: #333;
    --color-light-gray: #f9f9f9;
    --color-border: #ccc;
    --color-error: #f44336;
    --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
}
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}
body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--color-light-gray);
    color: var(--color-text);
}
.container {
    max-width: 650px;
    margin: 0 auto;
    padding: 15px;
}
h1 {
    font-size: 1.8em;
    color: var(--color-primary);
    margin-bottom: 20px;
}

/* ------------------------------------- */
/* 2. Form Elements & Layout */
/* ------------------------------------- */
.form-group {
    margin-bottom: 20px;
}
label {
    display: block;
    margin-bottom: 5px;
    font-weight: 700;
    font-size: 0.95em;
}
input, select {
    display: block;
    width: 100%;
    padding: 12px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 1em;
    transition: border-color 0.3s;
}
input:focus, select:focus {
    border-color: var(--color-primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}
.input-row {
    display: flex;
    gap: 15px;
}
.input-row > .form-group {
    flex: 1;
    margin-bottom: 0;
}

/* ------------------------------------- */
/* 3. Summary & Payment */
/* ------------------------------------- */
.section-title {
    font-size: 1.4em;
    margin: 25px 0 15px 0;
    color: var(--color-primary);
}
#priceSummary {
    padding: 15px;
    background-color: #fff;
    border-radius: 8px;
    border: 1px solid #ddd;
}
#priceSummary div {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 1.05em;
}
#priceSummary strong {
    font-size: 1.2em;
    color: var(--color-primary);
}

#payment-element-container {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #fff;
    box-shadow: var(--shadow-light);
}

/* ------------------------------------- */
/* 4. Buttons & Messages */
/* ------------------------------------- */
button {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    font-weight: 700;
    cursor: pointer;
    margin-top: 15px;
    transition: background-color 0.3s, opacity 0.3s;
}
#getPaymentOptions {
    background-color: var(--color-primary);
    color: white;
}
#getPaymentOptions:hover:not(:disabled) {
    background-color: #43a047;
}
#placeOrder {
    background-color: var(--color-secondary);
    color: white;
}
#placeOrder:hover:not(:disabled) {
    background-color: #fb8c00;
}
button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
.error-message { 
    color: var(--color-error); 
    font-weight: 700;
    padding: 10px;
    border: 1px dashed var(--color-error);
    border-radius: 8px;
    margin-bottom: 15px;
}

/* ------------------------------------- */
/* 5. Service Area Message */
/* ------------------------------------- */
#serviceAreaMessage {
    padding: 10px;
    border-radius: 5px;
    margin-top: -10px; 
    margin-bottom: 10px;
    font-size: 0.9em;
    font-weight: bold;
}
.service-ok {
    background-color: #e8f5e9; /* Light green */
    color: #388e3c; /* Dark green */
}
.service-warn {
    background-color: #fff3e0; /* Light orange */
    color: #e65100; /* Dark orange */
}
</style>
</head>
<body>

<div class="container">
    <h1>üõí Your Order Checkout</h1>

    <div id="statusMessage" class="error-message" style="display:none;"></div>

    <form id="checkoutForm">
        <h2 class="section-title">Customer Details</h2>

        <div class="form-group">
            <label for="customerName">Full Name</label>
            <input id="customerName" placeholder="John Doe" value="Test Customer" required>
        </div>
        <div class="input-row">
            <div class="form-group">
                <label for="customerEmail">Email</label>
                <input id="customerEmail" type="email" placeholder="john@example.com" value="test@example.com" required>
            </div>
            <div class="form-group">
                <label for="customerMobile">Mobile</label>
                <input id="customerMobile" placeholder="0412345678" value="0412345678" required>
            </div>
        </div>

        <h2 class="section-title">Delivery Address</h2>
        <div class="form-group">
            <label for="customerAddress">Address Line 1</label>
            <input id="customerAddress" placeholder="123 Queen St" value="123 Queen St" required>
        </div>
        <div class="input-row">
            <div class="form-group">
                <label for="customerSuburb">Suburb</label>
                <input id="customerSuburb" placeholder="Brisbane" value="Brisbane" required>
            </div>
            <div class="form-group">
                <label for="customerState">State</label>
                <select id="customerState" required>
                    <option value="QLD" selected>QLD</option>
                    <option value="NSW">NSW</option>
                    <option value="VIC">VIC</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="customerPostcode">Postcode</label>
            <input id="customerPostcode" placeholder="4000" value="4000" required>
            <div id="serviceAreaMessage" style="display:none;"></div>
        </div>
        
        <div class="form-group">
            <label for="deliverySlot">Delivery Time Slot</label>
            <select id="deliverySlot" required></select>
        </div>
    </form>


    <hr>

    <h2 class="section-title">üßæ Order Summary</h2>
    <div id="priceSummary">
        <div>Subtotal: <span id="subtotalAmount"></span></div>
        <div>Delivery Fee: <span id="deliveryFee"></span></div>
        <div style="margin-top: 10px;"><strong>Grand Total:</strong> <span id="grandTotalAmount"></span></div>
    </div>

    <hr>

    <h2 class="section-title">üí≥ Payment</h2>

    <button id="getPaymentOptions">Proceed to Payment</button>

    <div id="payment-element-container" style="display:none;">
        <div id="payment-element"></div>
    </div>

    <button id="placeOrder" style="display:none;">Place Order & Pay</button>
    
    <hr>

    <h2 class="section-title">üîê OTP Verification (Testing Only)</h2>
    <button id="generateOTP">Generate OTP</button>
    <div id="otpDisplay" style="color:var(--color-error);font-weight:bold;margin-top:10px;"></div>
    <div class="form-group">
        <input id="otpInput" placeholder="Enter OTP">
    </div>

</div>

<script type="module">
// Stripe Publishable Key
const STRIPE_PUBLISHABLE_KEY = "pk_test_51SUX2cAtxwsqQt5Tf4eFuJC4uXKoauXjBAU5TiHC7MZnlR7rI6HIyHCMYJFeaCU7rSkQ4FBJD5q53QOw3DPKcOlg00VHp43m4l"; 
const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

// --- DOM ELEMENTS (Remains the same) ---
const nameElement = document.getElementById("customerName");
const emailElement = document.getElementById("customerEmail");
const mobileElement = document.getElementById("customerMobile");
const addressElement = document.getElementById("customerAddress");
const suburbElement = document.getElementById("customerSuburb");
const stateElement = document.getElementById("customerState");
const postcodeElement = document.getElementById("customerPostcode");
const deliverySlotElement = document.getElementById("deliverySlot");
const subtotalSpan = document.getElementById("subtotalAmount");
const feeSpan = document.getElementById("deliveryFee");
const totalSpan = document.getElementById("grandTotalAmount");
const getPaymentOptionsButton = document.getElementById("getPaymentOptions");
const placeOrderButton = document.getElementById("placeOrder");
const paymentElementContainer = document.getElementById("payment-element-container");
const otpDisplay = document.getElementById("otpDisplay");
const otpInput = document.getElementById("otpInput");
const statusMessage = document.getElementById("statusMessage");
const serviceAreaMessage = document.getElementById("serviceAreaMessage");

let elements; 
let clientSecret;
window.orderNumber; 
let currentOTP = null;

// -------------------------------------------------------------
// --- 1. LOGISTICS CONSTANTS (BASED ON YOUR EXACT LISTS) ---
// -------------------------------------------------------------

// Your exact Postcode Groups
const GROUP_A = [4300,4301,4303,4304,4305,4306,4307,4308,4311]; // Ipswich + Logan
const GROUP_B = [4169,4170,4171,4172,4173,4174,4178,4179]; // Redland Bay + half Brisbane council
const GROUP_C = [4000,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4017,4018,4025,4029,4030,4031,4032,4034,4035,4036,4051,4053,4054,4055,4059,4060,4061,4064,4065,4066,4067,4068,4069,4070,4072,4073,4074,4075,4076,4077,4078,4101,4102,4103,4104,4105,4106,4107,4108,4109,4110,4111,4112,4113,4114,4115,4116,4117,4118,4119,4120,4121,4122,4123,4124,4125,4127,4128,4129,4130,4132,4133,4151,4152,4153,4154,4155,4156,4157,4158,4159,4160,4161,4163,4164,4165]; // Rest of Brisbane + Moreton Bay

// Delivery Time Slots (8am-6pm)
const SLOTS = ["8:00-11:00","11:00-15:00","15:00-18:00"];

// Distance Mapping (Crucial for fee calculation)
// NOTE: This list needs ALL serviceable postcodes from A, B, and C groups!
const POSTCODE_DISTANCES = {
    // Group C (Brisbane Inner/Mid) - Example Distances
¬† ¬† 4000: 0, 4005: 3, 4006: 5, 4007: 7, 4030: 10, 4051: 12, 4101: 2, 4102: 4, 4120: 8, 4151: 10, 4160: 15,
    // Group B (Redlands/Brisbane Half) - Example Distances
    4169: 18, 4170: 20, 4171: 22, 4174: 25, 4179: 28,
    // Group A (Ipswich/Logan) - Example Distances
    4300: 32, 4301: 35, 4303: 40, 4305: 45, 4311: 50,
    // ... Fill in the rest of the 100+ postcodes here with their actual distances ...
};

// Delivery Fee Tiers
const DISTANCE_FEES = [
¬† { maxKm: 10, fee: 10 },
¬† { maxKm: 20, fee: 15 },
¬† { maxKm: 30, fee: 20 },
¬† { maxKm: Infinity, fee: 25 } // For 30+ km
];

// -------------------------------------------------------------
// --- 2. LOGISTICS FUNCTIONS (UPDATED ROTATIONAL LOGIC) ---
// -------------------------------------------------------------

function getPostcodeGroup(postcode){
¬† const pc = Number(postcode);
¬† if(GROUP_A.includes(pc)) return 'A';
¬† if(GROUP_B.includes(pc)) return 'B';
¬† if(GROUP_C.includes(pc)) return 'C';
¬† return null;
}
function getDayIndex(){ 
    const day = new Date().getDay(); 
    return day === 0 ? null : day; // 1=Mon, 6=Sat. Return null for Sunday (0)
}

function getAvailableSlots(postcode){
¬† const group = getPostcodeGroup(postcode);
¬† const day = getDayIndex(); // 1 (Mon) to 6 (Sat)
¬† if(!group || !day) return []; // No service on Sunday or invalid postcode

¬† // --- ROTATION LOGIC IMPLEMENTATION ---
¬† // This ensures a shuffle across the 3 slots (0, 1, 2) over 6 days (M-S)
¬† // SLOTS: 0: 8-11, 1: 11-15, 2: 15-18
¬† const rotation = {
¬† ¬† 'A': {
        // M-S Rotation: A always gets one slot (e.g., 0, 1, 2, 0, 1, 2)
        1: [SLOTS[0]], 2: [SLOTS[1]], 3: [SLOTS[2]], 
        4: [SLOTS[0]], 5: [SLOTS[1]], 6: [SLOTS[2]] 
    },
¬† ¬† 'B': {
        // M-S Rotation: B always gets one slot, offset by 1 from A (e.g., 1, 2, 0, 1, 2, 0)
        1: [SLOTS[1]], 2: [SLOTS[2]], 3: [SLOTS[0]], 
        4: [SLOTS[1]], 5: [SLOTS[2]], 6: [SLOTS[0]]
    },
¬† ¬† 'C': {
        // M-S Rotation: C always gets two slots, using the remaining slots each day.
        1: [SLOTS[1], SLOTS[2]], // A gets 0
        2: [SLOTS[0], SLOTS[2]], // A gets 1
        3: [SLOTS[0], SLOTS[1]], // A gets 2
        4: [SLOTS[1], SLOTS[2]], // A gets 0
        5: [SLOTS[0], SLOTS[2]], // A gets 1
        6: [SLOTS[0], SLOTS[1]]  // A gets 2
    }
¬† };
¬† 
¬† return rotation[group][day] || [];
}

function calculateDeliveryFee(postcode){
¬† const dist = POSTCODE_DISTANCES[Number(postcode)];
¬† if(dist===undefined) return -1; // -1 means non-serviceable
¬† for(const df of DISTANCE_FEES){
¬† ¬† if(dist<=df.maxKm) return df.fee;
¬† }
¬† return 25;
}

// -------------------------------------------------------------
// --- 3. UI, EVENT LISTENERS, & STRIPE LOGIC (Remains the same) ---
// -------------------------------------------------------------

function formatCurrency(amount) {
¬† return new Intl.NumberFormat('en-AU', { style:'currency', currency:'AUD' }).format(amount);
}
function displayError(message) { statusMessage.innerText = message; statusMessage.style.display = 'block'; }
function clearError() { statusMessage.style.display = 'none'; statusMessage.innerText = ''; }

const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley") || "[]");
let subtotal = trolley.reduce((s,i)=>s+(i.price || 0)*(i.quantity || 1),0);

const updateSummary = (postcode) => {
¬† const fee = calculateDeliveryFee(postcode);
¬† let total = subtotal + (fee > 0 ? fee : 0);
  
¬† // 1. Handle Service Area Message
  serviceAreaMessage.style.display = 'block';
  getPaymentOptionsButton.disabled = true; // Disable by default until slots are confirmed

  if (fee === -1) {
      serviceAreaMessage.className = 'service-area-message service-warn';
      serviceAreaMessage.textContent = `‚ö†Ô∏è Postcode ${postcode} is outside our current delivery range.`;
      feeSpan.innerText = 'N/A';
      totalSpan.innerText = 'N/A';
      total = 0;
  } else {
      serviceAreaMessage.className = 'service-area-message service-ok';
      serviceAreaMessage.textContent = `‚úÖ Delivery service available! Estimated Fee: ${formatCurrency(fee)}`;
      feeSpan.innerText = formatCurrency(fee);
      totalSpan.innerText = formatCurrency(total);
  }

¬† // 2. Update summary display
  subtotalSpan.innerText = formatCurrency(subtotal);
  
¬† // 3. Update Delivery Slots
¬† const slots = getAvailableSlots(postcode);
¬† deliverySlotElement.innerHTML = '';
¬† const defaultOption = document.createElement("option");
¬† defaultOption.value = "";
¬† defaultOption.disabled = true;
¬† defaultOption.selected = true;
¬† deliverySlotElement.appendChild(defaultOption);

  if (fee === -1) {
      defaultOption.textContent = "Cannot select slot (Out of area)";
      deliverySlotElement.disabled = true;
  } else if (slots.length === 0) {
      defaultOption.textContent = "No slots available today";
      deliverySlotElement.disabled = true;
      displayError("No delivery slots are available for your postcode today. Please check back tomorrow (Mon-Sat service only).");
  } else {
      defaultOption.textContent = "Select a time slot";
      deliverySlotElement.disabled = false;
      getPaymentOptionsButton.disabled = false; // Enable button once slots are available
      clearError(); // Clear error if slots are found
  }

¬† slots.forEach(slot => {
¬† ¬† ¬† const option = document.createElement('option');
¬† ¬† ¬† option.value = slot;
¬† ¬† ¬† option.textContent = slot;
¬† ¬† ¬† deliverySlotElement.appendChild(option);
¬† });
};


document.getElementById("generateOTP").onclick = () => {
¬† currentOTP = Math.floor(1000 + Math.random() * 9000); 
¬† otpDisplay.innerText = `Generated OTP: ${currentOTP}`;
};
postcodeElement.oninput = (e) => updateSummary(e.target.value.trim());
updateSummary(postcodeElement.value.trim()); 

// --- Payment and Order Logic (As provided previously) ---

getPaymentOptionsButton.onclick = async (e) => {
¬† ¬† e.preventDefault();
¬† ¬† clearError();
    
    // Basic Form Validation Check
    const customer = {
¬† ¬† ¬† ¬† name: nameElement.value.trim(), email: emailElement.value.trim(), mobile: mobileElement.value.trim(),
¬† ¬† ¬† ¬† address: addressElement.value.trim(), suburb: suburbElement.value.trim(), state: stateElement.value,
¬† ¬† ¬† ¬† postcode: postcodeElement.value.trim(), deliverySlot: deliverySlotElement.value, 
¬† ¬† };
    if (Object.values(customer).some(val => !val)) {
¬† ¬† ¬† ¬† displayError("Please ensure all customer fields and a delivery slot are selected.");
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† getPaymentOptionsButton.disabled = true;
¬† ¬† getPaymentOptionsButton.innerText = "Processing...";

¬† ¬† try {
        const res = await fetch("/api/create-payment-intent", {
¬† ¬† ¬† ¬† ¬† ¬† method: "POST", headers: { "Content-Type": "application/json" },
¬† ¬† ¬† ¬† ¬† ¬† body: JSON.stringify({ trolley, customer })
¬† ¬† ¬† ¬† });
    
¬† ¬† ¬† ¬† const data = await res.json();
¬† ¬† ¬† ¬† if (data.error) {
¬† ¬† ¬† ¬† ¬† ¬† displayError(`Server error: ${data.error}`);
¬† ¬† ¬† ¬† ¬† ¬† getPaymentOptionsButton.innerText = "Proceed to Payment";
¬† ¬† ¬† ¬† ¬† ¬† getPaymentOptionsButton.disabled = false;
¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† clientSecret = data.clientSecret;
¬† ¬† ¬† ¬† window.orderNumber = data.orderNumber;
    
¬† ¬† ¬† ¬† elements = stripe.elements({ clientSecret, appearance: { theme: 'stripe' } });
¬† ¬† ¬† ¬† elements.create("payment").mount("#payment-element");

¬† ¬† ¬† ¬† paymentElementContainer.style.display = 'block';
¬† ¬† ¬† ¬† placeOrderButton.style.display = 'block';
¬† ¬† ¬† ¬† getPaymentOptionsButton.style.display = 'none';
        
        document.querySelectorAll('form input, form select').forEach(el => el.disabled = true);
        
¬† ¬† } catch (err) {
¬† ¬† ¬† ¬† displayError("An unknown network error occurred. Check server connection.");
¬† ¬† ¬† ¬† getPaymentOptionsButton.innerText = "Proceed to Payment";
¬† ¬† ¬† ¬† getPaymentOptionsButton.disabled = false;
¬† ¬† }
};

placeOrderButton.onclick = async (e)=>{
¬† e.preventDefault();
¬† clearError();

¬† if(!currentOTP || Number(otpInput.value) !== currentOTP){
¬† ¬† displayError("Invalid OTP. Generate and enter the correct OTP.");
¬† ¬† return;
¬† }
¬†¬†
¬† placeOrderButton.innerText = "Processing Payment...";
¬† placeOrderButton.disabled = true;

¬† const { error: stripeError } = await stripe.confirmPayment({
¬† ¬† elements: elements,
¬† ¬† confirmParams: {
¬† ¬† ¬† return_url: `${window.location.origin}/success.html?order=${window.orderNumber}`,¬†
¬† ¬† },
¬† });

¬† if(stripeError){
¬† ¬† displayError(`Payment failed: ${stripeError.message}`);
¬† ¬† placeOrderButton.innerText = "Place Order & Pay";
¬† ¬† placeOrderButton.disabled = false;
¬† }
};
</script>
</body>
</html>
