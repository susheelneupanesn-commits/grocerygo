<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | GroceryGo</title>
<script src="https://js.stripe.com/v3/"></script>
<style>
  body { font-family: Arial; padding: 20px; }
  #card-element { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
  #payment-message { color: green; margin-top: 10px; }
</style>
</head>
<body>
<h2>Checkout</h2>

<form id="payment-form">
  <label>Name</label><br>
  <input type="text" id="name" required><br>
  <label>Email</label><br>
  <input type="email" id="email" required><br>
  <label>Phone</label><br>
  <input type="text" id="phone" required><br>
  <label>Address</label><br>
  <input type="text" id="address" required><br>
  <label>Postcode</label><br>
  <input type="text" id="postcode" required><br>

  <h3>Card Details</h3>
  <div id="card-element"></div>
  <button type="submit">Pay</button>
</form>

<div id="payment-message"></div>

<script>
const stripe = Stripe("pk_test_51SUX2KAmiKZAr3ZsMbzqoInpVR5IttKq4O5l0QP6ZUJQI9Ru01AnNl3ET3pcEP6NrQpGn2zw7iiSWaPWjtSvfzhp00g4X8HSOD");
const elements = stripe.elements();
const card = elements.create("card");
card.mount("#card-element");

const form = document.getElementById("payment-form");
const messageEl = document.getElementById("payment-message");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const customer = {
    name: document.getElementById("name").value,
    email: document.getElementById("email").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    postcode: document.getElementById("postcode").value,
    deliveryFee: 5.00,       // example
    deliveryDate: new Date().toISOString().split('T')[0],
    deliveryTime: "ASAP"
  };

  const trolley = [
    { name: "Sample Product", quantity: 1, price: 1000 }
  ];

  const amount = trolley.reduce((sum, i) => sum + i.price * i.quantity, 0) + customer.deliveryFee*100;

  // Create PaymentIntent
  const res = await fetch("/api/create-payment-intent", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount, trolley, customer })
  });
  const data = await res.json();

  const { clientSecret } = data;
  const result = await stripe.confirmCardPayment(clientSecret, {
    payment_method: { card, billing_details: { name: customer.name, email: customer.email } }
  });

  if (result.error) {
    messageEl.textContent = result.error.message;
    messageEl.style.color = "red";
  } else if (result.paymentIntent.status === "succeeded") {
    messageEl.textContent = `Payment successful! Order #${data.orderNumber}`;
  }
});
</script>
</body>
</html>
