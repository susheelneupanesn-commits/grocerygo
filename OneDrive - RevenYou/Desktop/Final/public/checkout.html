<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    input, select { width: 100%; padding: 10px; margin: 8px 0; }
    #card-element { padding: 12px; border: 1px solid #ccc; border-radius: 6px; background: white; }
    button { width: 100%; padding: 12px; background: black; color: white; border: none; border-radius: 6px; }
    .hidden { display: none; }
  </style>

  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body>

<div class="container">
  <h2>Checkout</h2>

  <label>Full Name</label>
  <input id="name" />

  <label>Phone</label>
  <input id="phone" />

  <label>Postcode</label>
  <input id="postcode" />

  <p id="postcodeMsg" style="color:red;"></p>

  <label>Delivery Slot</label>
  <select id="slot"></select>

  <h3>Order Summary</h3>
  <p>Subtotal: $<span id="subtotal">0.00</span></p>
  <p>Delivery Fee: $<span id="delivery">0.00</span></p>
  <p><strong>Total: $<span id="total">0.00</span></strong></p>

  <h3>Card Details</h3>
  <div id="card-element"></div>
  <p id="card-error" style="color:red;"></p>

  <button id="payBtn">Place Order & Pay</button>

  <p id="successMsg" style="color:green;font-weight:bold;"></p>
</div>

<script>
/* --------------------------------------------------------------
   1️⃣ INITIALISE SUPABASE
-------------------------------------------------------------- */
const supabase = supabaseJs.createClient(
  "https://gikdqaxdqfmzdvolkxbn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdpa2RxYXhkcWZtemR2b2xreGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyOTQwNDIsImV4cCI6MjA3Nzg3MDA0Mn0.pJ-9KfCxV7YT5loiURW14xRmf72s1EZRFRh4iKGnQis"
);

/* --------------------------------------------------------------
   2️⃣ STRIPE SETUP
-------------------------------------------------------------- */
const stripe = Stripe(
  "pk_test_51SUX2KAmiKZAr3ZsHxEue0cUDH0lVUC3aR0V8TtkOgLyuyNK80iU9KqXADQFELwch25igWkYie3XJr7pe39DI0J4005mJ5xL5S"
);

const elements = stripe.elements();
const cardElement = elements.create("card", { hidePostalCode: true });
cardElement.mount("#card-element");

/* --------------------------------------------------------------
   3️⃣ LOAD TROLLEY + SUBTOTAL
-------------------------------------------------------------- */
let trolley = JSON.parse(localStorage.getItem("trolley") || "[]");

let subtotal = trolley.reduce((s, i) => s + i.price * i.quantity, 0);
document.getElementById("subtotal").innerText = subtotal.toFixed(2);

/* --------------------------------------------------------------
   4️⃣ POSTCODE CHECK + DELIVERY FEE CALC
-------------------------------------------------------------- */
const SERVICABLE = [4000,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4017,4018,4025,4029,4030,4031,4032,4034,4035,4036,4051,4053,4054,4055,4059,4060,4061,4064,4065,4066,4067,4068,4069,4070,4072,4073,4074,4075,4076,4077,4078,4101,4102,4103,4104,4105,4106,4107,4108,4109,4110,4111,4112,4113,4114,4115,4116,4117,4118,4119,4120,4121,4122,4123,4124,4125,4127,4128,4129,4130,4132,4133,4151,4152,4153,4154,4155,4156,4157,4158,4159,4160,4161,4163,4164,4165,4169,4170,4171,4172,4173,4174,4178,4179,4183,4184,4205,4207,4280,4285,4300,4301,4303,4304,4305,4306,4307,4308,4311,4340,4346,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,4518,4519,4520,4521];

document.getElementById("postcode").addEventListener("input", () => {
  checkDelivery();
});

function checkDelivery() {
  const pc = parseInt(document.getElementById("postcode").value);
  const msg = document.getElementById("postcodeMsg");

  if (!SERVICABLE.includes(pc)) {
    msg.innerText = "Sorry, we do not service this postcode.";
    return false;
  }

  msg.innerText = "";
  
  // Distance = difference from 4000
  const diff = Math.abs(pc - 4000);
  let fee = 20;
  if (diff <= 10) fee = 10;
  else if (diff <= 20) fee = 15;

  document.getElementById("delivery").innerText = fee.toFixed(2);
  document.getElementById("total").innerText = (subtotal + fee).toFixed(2);

  return fee;
}

/* --------------------------------------------------------------
   5️⃣ DELIVERY SLOT (8 HOURS FROM NOW)
-------------------------------------------------------------- */
const slotSelect = document.getElementById("slot");

function loadSlots() {
  const now = new Date();
  now.setHours(now.getHours() + 8);

  for (let i=0; i<5; i++) {
    const t = new Date(now.getTime() + i * 60 * 60 * 1000);
    const label = t.toLocaleString();
    const opt = document.createElement("option");
    opt.value = label;
    opt.textContent = label;
    slotSelect.appendChild(opt);
  }
}
loadSlots();

/* --------------------------------------------------------------
   6️⃣ PAYMENT + ORDER INSERT
-------------------------------------------------------------- */
document.getElementById("placeOrder").onclick

  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const postcode = parseInt(document.getElementById("postcode").value);
  const slot = document.getElementById("slot").value;

  const fee = checkDelivery();
  if (!fee) return;

  const totalAmount = Math.round((subtotal + fee) * 100);

  // Create payment intent
  const res = await fetch("/api/create-payment-intent", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      amount: totalAmount,
      trolley,
      customer: { name, phone, postcode, deliveryFee: fee, slot }
    })
  });

  const data = await res.json();

  const result = await stripe.confirmCardPayment(data.clientSecret, {
    payment_method: {
      card: cardElement,
      billing_details: { name }
    }
  });

  if (result.error) {
    document.getElementById("card-error").innerText = result.error.message;
    return;
  }

  if (result.paymentIntent.status === "succeeded") {
    const orderNo = "GGO-" + Math.floor(100000 + Math.random() * 900000);
    document.getElementById("successMsg").innerText =
      `Your order has been successful! Your order number is ${orderNo}.`;

    // Save final order to Supabase
    await supabase.from("orders").insert({
      order_number: orderNo,
      name,
      phone,
      postcode,
      delivery_slot: slot,
      items: trolley,
      subtotal,
      delivery_fee: fee,
      total: subtotal + fee,
      status: "Paid"
    });

    localStorage.removeItem("trolley");
  }
});
</script>

</body>
</html>
