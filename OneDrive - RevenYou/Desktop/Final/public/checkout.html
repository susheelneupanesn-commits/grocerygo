<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-commerce Checkout</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .StripeElement {
            box-sizing: border-box; height: 44px; padding: 12px;
            border: 1px solid #d1d5db; border-radius: 0.5rem;
            background-color: white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 150ms ease;
        }
        .StripeElement--focus { box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5); border-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-6">

    <div class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-8 space-y-8 border border-gray-100 mt-10">
        <h1 class="text-3xl font-bold text-gray-900 text-center border-b pb-4">
            Order Payment
        </h1>
        
        <!-- Order Summary -->
        <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-200">
            <h2 class="text-xl font-semibold text-indigo-800 mb-2">Your Order</h2>
            <div id="order-details" class="space-y-1">
                <div class="flex justify-between"><span>Product X</span><span>$10.00</span></div>
                <div class="flex justify-between"><span>Delivery</span><span>$9.99</span></div>
            </div>
            <div class="border-t border-indigo-300 my-3"></div>
            <div class="flex justify-between font-extrabold text-2xl text-indigo-700">
                <span>TOTAL</span>
                <span>$19.99 USD</span>
            </div>
        </div>
        
        <!-- Payment Form -->
        <form id="payment-form" class="space-y-6">
            
            <div id="auth-status" class="text-center text-sm p-2 rounded-lg">Authenticating...</div>
            
            <!-- Customer Info -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Billing Name</label>
                <input id="name" type="text" value="Jane Doe" required class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            </div>

            <!-- Stripe Payment Element Container -->
            <div>
                <label for="card-element" class="block text-sm font-medium text-gray-700 mb-2">
                    Card Details
                </label>
                <div id="card-element"></div>
            </div>

            <!-- Message Box -->
            <div id="message-box" class="hidden p-4 rounded-lg text-sm" role="alert">
                <p id="message-text" class="font-medium"></p>
            </div>
            
            <button id="submit-button" type="submit" 
                    class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50"
                    disabled>
                <span id="button-text">Pay $19.99</span>
                <div id="spinner" class="hidden inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-white align-middle mr-2"></div>
            </button>
        </form>
    </div>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, doc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Load Stripe.js library
        const stripeScript = document.createElement('script');
        stripeScript.src = "https://js.stripe.com/v3/";
        document.head.appendChild(stripeScript);
        
        // --- Globals ---
        window.ORDER_TOTAL_CENTS = 1999;
        window.ORDER_ITEMS = [ { name: "Product X", price: 1000 }, { name: "Delivery", price: 999 } ];
        window.serverUrl = 'http://localhost:3000/create-payment-intent';
        
        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const authStatusElement = document.getElementById('auth-status');

        // Firestore paths
        const publicOrdersPath = `/artifacts/${appId}/public/data/orders`;

        // 1. Initialize Firebase and Authenticate
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `User ID: ${userId.substring(0, 8)}... (Authenticated)`;
                        authStatusElement.className = 'text-center text-sm p-2 rounded-lg bg-green-100 text-green-700';
                        initializeStripe(); // Initialize Stripe only after Firebase is ready
                    } else {
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                             await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusElement.textContent = `Error: Cannot connect to database.`;
                authStatusElement.className = 'text-center text-sm p-2 rounded-lg bg-red-100 text-red-700';
            }
        }

        // 2. Stripe Setup
        function initializeStripe() {
            // IMPORTANT: Replace this with your actual Stripe Publishable Key
            const stripePublishableKey = 'pk_test_51O7c7wJ1Gz7cR3z3sW2yT8oV6nG3kB0xV0iT7vW1tZ2mX6qT9b4k3pYlX2fG0wW8lR6pYt0tZ4uP0yF3'; 
            
            const stripe = Stripe(stripePublishableKey);
            const elements = stripe.elements();
            const card = elements.create('card');
            card.mount('#card-element');

            const form = document.getElementById('payment-form');
            const submitButton = document.getElementById('submit-button');
            
            submitButton.disabled = false; // Enable initially now that auth is done

            card.on('change', function(event) {
                submitButton.disabled = !event.complete;
                if (event.error) {
                    displayMessage(event.error.message, true);
                } else {
                    document.getElementById('message-box').classList.add('hidden');
                }
            });

            form.addEventListener('submit', (e) => handlePayment(e, stripe, card));
        }
        
        // 3. Payment Handling
        async function handlePayment(event, stripe, card) {
            event.preventDefault();
            if (!userId) return displayMessage("Authentication not complete. Please wait.", true);
            
            showProcessing(true);
            
            let orderDocRef;

            try {
                // A. Create the Order in Firestore (Status: PENDING)
                const newOrder = {
                    customerId: userId,
                    customerName: document.getElementById('name').value,
                    items: window.ORDER_ITEMS,
                    amount: window.ORDER_TOTAL_CENTS,
                    status: 'PENDING',
                    createdAt: new Date(),
                    lastUpdated: new Date()
                };

                orderDocRef = await addDoc(collection(db, publicOrdersPath), newOrder);
                const orderId = orderDocRef.id;

                displayMessage(`Order created: ${orderId}. Requesting payment intent...`, false, 'bg-blue-100 text-blue-700');
                
                // B. Fetch the Client Secret from Node.js Server
                const response = await fetch(window.serverUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amountInCents: window.ORDER_TOTAL_CENTS, orderId: orderId })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const clientSecret = data.clientSecret;

                // C. Confirm Payment with Stripe
                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: card,
                        billing_details: { name: document.getElementById('name').value },
                    }
                });

                if (result.error) {
                    // Payment failed, update status to FAILED
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'FAILED',
                        lastUpdated: new Date(),
                        paymentError: result.error.message
                    });
                    displayMessage(`Payment Failed: ${result.error.message}. Status set to FAILED in Firestore.`, true);
                } else if (result.paymentIntent.status === 'succeeded') {
                    // Payment succeeded, update status to PAID
                    await updateDoc(doc(db, publicOrdersPath, orderId), {
                        status: 'PAID',
                        stripePaymentIntentId: result.paymentIntent.id,
                        lastUpdated: new Date()
                    });
                    displayMessage('Payment SUCCESSFUL! Order placed and marked as PAID in Firestore.', false, 'bg-green-100 text-green-700');
                    form.reset();
                    card.clear();
                    submitButton.disabled = true;
                } else {
                    // Handle other statuses (e.g., requires_action)
                    displayMessage(`Payment status: ${result.paymentIntent.status}. Please check Stripe dashboard.`, true);
                }

            } catch (error) {
                console.error('[Checkout Error]', error);
                
                // If an order was created but the payment intent failed (A->B), mark it failed
                if (orderDocRef) {
                     await updateDoc(doc(db, publicOrdersPath, orderDocRef.id), {
                        status: 'FAILED_API_ERROR',
                        lastUpdated: new Date(),
                        serverError: error.message
                    });
                }
                displayMessage(`System Error: ${error.message}. Ensure 'server.js' is running.`, true);
            } finally {
                showProcessing(false);
            }
        }
        
        // --- UI Helpers ---
        function showProcessing(isProcessing) {
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            submitButton.disabled = isProcessing;
            spinner.classList.toggle('hidden', !isProcessing);
            buttonText.textContent = isProcessing ? 'Processing...' : 'Pay $19.99';
        }

        function displayMessage(text, isError = false, bgColorClass = null) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageBox.className = `p-4 rounded-lg text-sm`;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-700', 'text-green-700', 'text-blue-700');

            if (bgColorClass) {
                messageBox.classList.add(bgColorClass);
            } else {
                messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
                messageText.classList.add(isError ? 'text-red-700' : 'text-green-700');
            }
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        // Start the application
        initializeFirebase();
    </script>
</body>
</html>
