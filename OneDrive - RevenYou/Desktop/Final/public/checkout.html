<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>
<style>
  /* Basic styling for inputs and layout */
  .container { max-width: 600px; margin: 0 auto; padding: 20px; }
  label { display: block; margin-top: 10px; font-weight: bold; }
  input, select, button { display: block; width: 100%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  #priceSummary div { display: flex; justify-content: space-between; margin-bottom: 5px; }
  #payment-element-container { margin-top: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
</style>
</head>
<body>

<div class="container">
<h1>Checkout</h1>

## Customer Details
<label for="customerName">Full Name</label>
<input id="customerName" placeholder="John Doe" value="Test Customer">

<label for="customerEmail">Email</label>
<input id="customerEmail" type="email" placeholder="john@example.com" value="test@example.com">

<label for="customerMobile">Mobile</label>
<input id="customerMobile" placeholder="0412345678" value="0412345678">

<label for="customerAddress">Address</label>
<input id="customerAddress" placeholder="123 Queen St" value="123 Queen St">

<label for="customerSuburb">Suburb</label>
<input id="customerSuburb" placeholder="Brisbane" value="Brisbane">

<label for="customerState">State</label>
<select id="customerState">
    <option value="QLD" selected>QLD</option>
    <option value="NSW">NSW</option>
    <option value="VIC">VIC</option>
</select>

<label for="customerPostcode">Postcode</label>
<input id="customerPostcode" placeholder="4000" value="4000">

---

## Order Summary
<div id="priceSummary">
    <div>Subtotal: <span id="subtotalAmount"></span></div>
    <div>Delivery Fee: <span id="deliveryFee"></span></div>
    <div><strong>Grand Total:</strong> <span id="grandTotalAmount"></span></div>
</div>

---

## Payment

<button id="getPaymentOptions">Get Payment Options</button>

<div id="payment-element-container" style="display:none;">
    <div id="payment-element"></div>
</div>

---

## OTP Verification (For Testing)
<button id="generateOTP">Generate OTP</button>
<div id="otpDisplay" style="color:red;font-weight:bold;margin-top:10px;"></div>
<input id="otpInput" placeholder="Enter OTP">

<button id="placeOrder" style="display:none;">Place Order & Pay</button>

</div>

<script type="module">

const STRIPE_PUBLISHABLE_KEY = "pk_test_51SUX2cAtxwsqQt5Tf4eFuJC4uXKoauXjBAU5TiHC7MZnlR7rI6HIyHCMYJFeaCU7rSkQ4FBJD5q53QOw3DPKcOlg00VHp43m4l"; 
const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

// DOM Elements
const paymentElementContainer = document.getElementById("payment-element-container");
const getPaymentOptionsButton = document.getElementById("getPaymentOptions");
const placeOrderButton = document.getElementById("placeOrder");
let elements; 

// ---- POSTCODE GROUPS ----
const GROUP_A = [4300,4301,4303,4304,4305,4306,4307,4308,4311]; // Ipswich + Logan
const GROUP_B = [4169,4170,4171,4172,4173,4174,4178,4179]; // Redland Bay + half Brisbane council
const GROUP_C = [4000,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4017,4018,4025,4029,4030,4031,4032,4034,4035,4036,4051,4053,4054,4055,4059,4060,4061,4064,4065,4066,4067,4068,4069,4070,4072,4073,4074,4075,4076,4077,4078,4101,4102,4103,4104,4105,4106,4107,4108,4109,4110,4111,4112,4113,4114,4115,4116,4117,4118,4119,4120,4121,4122,4123,4124,4125,4127,4128,4129,4130,4132,4133,4151,4152,4153,4154,4155,4156,4157,4158,4159,4160,4161,4163,4164,4165]; // Rest of Brisbane + Moreton Bay

// ---- DELIVERY TIME SLOTS ----
const SLOTS = ["8:00-11:00","11:00-15:00","15:00-18:00"];

// Function to get group based on postcode
function getPostcodeGroup(postcode){
  const pc = Number(postcode);
  if(GROUP_A.includes(pc)) return 'A';
  if(GROUP_B.includes(pc)) return 'B';
  if(GROUP_C.includes(pc)) return 'C';
  return null;
}

// Function to get today's day index (0=Sunday, 1=Monday...6=Saturday)
function getDayIndex(){
  const d = new Date();
  return d.getDay();
}

// Get available slots for postcode group on the current day
function getAvailableSlots(postcode){
  const group = getPostcodeGroup(postcode);
  if(!group) return [];
  const day = getDayIndex(); // 0-6

  // Define rotation mapping for Mon-Sat
  const rotation = {
    'A': {1: [SLOTS[0]],3:[SLOTS[1]],5:[SLOTS[2]]}, // Monday, Wednesday, Friday
    'B': {2: [SLOTS[0]],4:[SLOTS[1]],6:[SLOTS[2]]}, // Tuesday, Thursday, Saturday
    'C': {1: [SLOTS[1],SLOTS[2]],3:[SLOTS[2],SLOTS[0]],5:[SLOTS[0],SLOTS[1]],2:[SLOTS[1],SLOTS[2]],4:[SLOTS[2],SLOTS[0]],6:[SLOTS[0],SLOTS[1]]} // Rotating all days
  };
  return rotation[group][day] || [];
}

// ---- DELIVERY FEE BASED ON DISTANCE FROM BRISBANE CONVENTION CENTRE ----
const DISTANCE_FEES = [
  { maxKm: 10, fee: 10 },
  { maxKm: 20, fee: 15 },
  { maxKm: 30, fee: 20 },
  { maxKm: Infinity, fee: 25 }
];

// Map postcodes to approximate distance in km from Brisbane Convention Centre
const POSTCODE_DISTANCES = {
  // Example distances (replace with actual values)
  4000: 0, 4005:2, 4006:3, 4007:4, 4008:5, 4009:8,
  4010:12, 4011:14, 4012:22, 4013:25, 4014:35, 4017:42
  // Add all your serviceable postcodes here with distance
};

function calculateDeliveryFee(postcode){
  const dist = POSTCODE_DISTANCES[postcode];
  if(dist===undefined) return 25;
  for(const df of DISTANCE_FEES){
    if(dist<=df.maxKm) return df.fee;
  }
  return 25;
}

// ---- TROLLEY & INITIAL CALCULATIONS ----
const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley") || "[]");
if(!trolley.length){
  alert("Your trolley is empty");
}
let subtotal = trolley.reduce((s,i)=>s+(i.price*i.quantity),0);
let deliveryFee = 0;

document.getElementById("subtotalAmount").innerText = formatCurrency(subtotal);

const updateSummary = (postcode) => {
  deliveryFee = calculateDeliveryFee(postcode);
  document.getElementById("deliveryFee").innerText = formatCurrency(deliveryFee);
  document.getElementById("grandTotalAmount").innerText = formatCurrency(subtotal + deliveryFee);

  // Update delivery slot dropdown
  let slotContainer = document.getElementById("deliverySlotContainer");
  if(!slotContainer){
    slotContainer = document.createElement("select");
    slotContainer.id = "deliverySlotContainer";
    const label = document.createElement("label");
    label.innerText = "Delivery Time Slot";
    document.getElementById("customerPostcode").after(label);
    label.after(slotContainer);
  }
  slotContainer.innerHTML = "";
  const slots = getAvailableSlots(postcode);
  if(slots.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.innerText = "No slots available for your postcode today";
    slotContainer.appendChild(opt);
  } else {
    slots.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = s;
      opt.innerText = s;
      slotContainer.appendChild(opt);
    });
  }
}

document.getElementById("customerPostcode").oninput = (e) => updateSummary(e.target.value.trim());
updateSummary(document.getElementById("customerPostcode").value.trim());

// OTP generation
let currentOTP = null;
function generateOTP() {
  currentOTP = Math.floor(100000 + Math.random()*900000);
  document.getElementById("otpDisplay").innerText = `Your OTP for testing: ${currentOTP}`;
}
document.getElementById("generateOTP").onclick = generateOTP;

// --- REST OF YOUR STRIPE PAYMENT LOGIC REMAINS EXACTLY THE SAME ---

getPaymentOptionsButton.onclick = async (e) => {
    e.preventDefault();
    const name = document.getElementById("customerName").value.trim();
    const email = document.getElementById("customerEmail").value.trim();
    const phone = document.getElementById("customerMobile").value.trim();
    const address = document.getElementById("customerAddress").value.trim();
    const suburb = document.getElementById("customerSuburb").value.trim();
    const state = document.getElementById("customerState").value;
    const postcode = document.getElementById("customerPostcode").value.trim();

    if (!name || !email || !phone || !address || !suburb || !state || !postcode) {
        alert("Please fill all required customer fields.");
        return;
    }

    getPaymentOptionsButton.innerText = "Processing...";
    getPaymentOptionsButton.disabled = true;

    const res = await fetch("/api/create-payment-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ trolley, customer: { name, email, phone, address, suburb, state, postcode } })
    });

    const data = await res.json();
    if (data.error) {
        alert(data.error);
        getPaymentOptionsButton.innerText = "Get Payment Options";
        getPaymentOptionsButton.disabled = false;
        return;
    }

    const clientSecret = data.clientSecret;
    window.orderNumber = data.orderNumber;

    elements = stripe.elements({ clientSecret });
    const paymentElement = elements.create("payment", { layout: 'tabs' });
    paymentElement.mount("#payment-element");

    paymentElementContainer.style.display = 'block';
    placeOrderButton.style.display = 'block';
    getPaymentOptionsButton.style.display = 'none';
};

placeOrderButton.onclick = async (e)=>{
  e.preventDefault();
  const name = document.getElementById("customerName").value.trim();
  const email = document.getElementById("customerEmail").value.trim();
  const phone = document.getElementById("customerMobile").value.trim();
  const address = document.getElementById("customerAddress").value.trim();
  const suburb = document.getElementById("customerSuburb").value.trim();
  const state = document.getElementById("customerState").value;
  const postcode = document.getElementById("customerPostcode").value.trim();
  const otpInput = document.getElementById("otpInput").value.trim();
  
  if(!otpInput || otpInput != currentOTP){
    alert("Invalid OTP. Generate and enter the OTP.");
    return;
  }
  
  placeOrderButton.innerText = "Processing Payment...";
  placeOrderButton.disabled = true;

  const { error: stripeError } = await stripe.confirmPayment({
    elements: elements,
    confirmParams: {
      return_url: `${window.location.origin}/order-success.html?order=${window.orderNumber}`, 
      payment_method_data: {
         billing_details: { 
             name: name,
             email: email,
             phone: phone,
             address: {
                line1: address,
                city: suburb,
                state: state,
                postal_code: postcode,
                country: "AU"
             }
         }
      }
    },
  });

  if(stripeError){
    alert("Payment failed: "+stripeError.message);
    placeOrderButton.innerText = "Place Order & Pay";
    placeOrderButton.disabled = false;
  }
};

</script>

</body>
</html>
