<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>
<style>
body{font-family:Arial,sans-serif;background:#f7f8fa;margin:0;padding:20px;}
.container{background:#fff;padding:20px;max-width:750px;margin:0 auto;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.1);}
h1,h2{color:#0072ce;margin-bottom:12px;}
label{font-weight:bold;margin-bottom:4px;display:block;}
input,select,textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;margin-bottom:12px;font-size:1em;}
textarea{height:80px;resize:none;}
.row{display:flex;gap:12px;flex-wrap:wrap;}
.row div{flex:1;min-width:130px;}
#priceSummary div{font-size:14px;color:#777;margin-bottom:4px;}
#priceSummary .grandTotal{font-size:18px;color:#000;font-weight:bold;margin-top:8px;}
.bottom-bar{display:flex;justify-content:flex-start;margin-top:20px;gap:12px;}
.bottom-bar button{background:#0072ce;border:none;color:white;padding:10px 16px;font-size:1em;border-radius:6px;cursor:pointer;flex:1;}
.bottom-bar button:hover{background:#005fa3;}
#card-element{padding:12px;border:1px solid #ccc;border-radius:6px;background:#fff;margin-bottom:10px;}
#messageOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);justify-content:center;align-items:center;z-index:1000;}
#messageBox{background:#28a745;padding:28px 20px;border-radius:10px;font-size:1.3em;font-weight:bold;color:white;text-align:center;max-width:420px;}
@media(max-width:480px){.row{flex-direction:column;}.bottom-bar{flex-direction:column;gap:10px;}}
</style>
</head>
<body>
<div class="container">
<h1>Checkout</h1>

<label>Full Name</label><input type="text" id="customerName" placeholder="John Doe">
<div class="row">
  <div><label>Email</label><input type="email" id="customerEmail" placeholder="john@example.com"></div>
  <div><label>Mobile Number</label><input type="text" id="customerMobile" placeholder="0412345678"></div>
</div>

<label>Delivery Address</label><input type="text" id="customerAddress" placeholder="123 Queen St">
<div class="row">
  <div><label>Suburb</label><input type="text" id="customerSuburb" placeholder="Brisbane"></div>
  <div><label>State</label>
    <select id="customerState">
      <option value="QLD" selected>Queensland</option>
      <option value="NSW">New South Wales</option>
      <option value="VIC">Victoria</option>
      <option value="WA">Western Australia</option>
      <option value="SA">South Australia</option>
      <option value="TAS">Tasmania</option>
      <option value="NT">Northern Territory</option>
      <option value="ACT">ACT</option>
    </select>
  </div>
  <div>
    <label>Postcode</label>
    <input type="text" id="customerPostcode" placeholder="4000">
    <small id="postcodeMessage" style="display:block;color:red;font-size:0.9em;"></small>
  </div>
</div>

<label>Select your preferred delivery time</label>
<select id="deliverySlot"><option value="">Choose your time slot</option></select>

<div id="priceSummary">
  <div>Subtotal: <span id="subtotalAmount">$0.00</span></div>
  <div>Delivery Fee: <span id="deliveryFee">$0.00</span></div>
  <div class="grandTotal">Grand Total: <span id="grandTotalAmount">$0.00</span></div>
</div>

<h2>Payment Details</h2>
<label>Cardholder Name</label><input type="text" id="cardName" placeholder="John Doe">
<div><label>Card Details</label><div id="card-element"></div></div>

<label>Special Instructions</label><textarea id="specialInstructions" placeholder="E.g., Leave at front door"></textarea>

<div class="bottom-bar">
  <button id="backTrolley">◀️ Back to Trolley</button>
  <button id="placeOrder">Place Order & Pay</button>
</div>
</div>

<div id="messageOverlay"><div id="messageBox"></div></div>

<script>
// ✅ Approved postcodes
const allowedPostcodes = [
  4000,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4017,4018,
  4025,4029,4030,4031,4032,4034,4035,4036,4051,4053,4054,4055,4059,
  4060,4061,4064,4065,4066,4067,4068,4069,4070,4072,4073,4074,4075,
  4076,4077,4078,4101,4102,4103,4104,4105,4106,4107,4108,4109,4110,
  4111,4112,4113,4114,4115,4116,4117,4118,4119,4120,4121,4122,4123,
  4124,4125,4127,4128,4129,4130,4132,4133,4151,4152,4153,4154,4155,
  4156,4157,4158,4159,4160,4161,4163,4164,4165,4169,4170,4171,4172,
  4173,4174,4178,4179,4183,4184,4205,4207,4280,4285,4300,4301,4303,
  4304,4305,4306,4307,4308,4311,4340,4346,4500,4501,4502,4503,4504,
  4505,4506,4507,4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,
  4518,4519,4520,4521
];

const messageOverlay = document.getElementById("messageOverlay");
const messageBox = document.getElementById("messageBox");
messageOverlay.addEventListener("click", () => { messageOverlay.style.display="none"; });

// Format currency
const formatCurrency = (amount) => new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'}).format(amount);

// Trolley and totals
const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley")||"[]");
if(!trolley.length){ alert("Your trolley is empty!"); window.location.href="trolley.html"; }

let subtotal = trolley.reduce((sum,item)=>sum+(item.price||0)*item.quantity,0);
let deliveryFee = 0;

function updateTotals(){
  const grandTotal = subtotal+deliveryFee;
  document.getElementById("subtotalAmount").innerText=formatCurrency(subtotal);
  document.getElementById("deliveryFee").innerText=formatCurrency(deliveryFee);
  document.getElementById("grandTotalAmount").innerText=formatCurrency(grandTotal);
}
updateTotals();

// Postcode live validation
const postcodeInput = document.getElementById("customerPostcode");
const postcodeMessage = document.getElementById("postcodeMessage");

postcodeInput.addEventListener("input", ()=>{
  const value = postcodeInput.value.trim();
  if(!value){ postcodeMessage.innerText=""; postcodeInput.style.borderColor="#ccc"; return; }
  const code = parseInt(value,10);
  if(allowedPostcodes.includes(code)){
    postcodeMessage.innerText="✅ Delivery available in this area";
    postcodeMessage.style.color="green";
    postcodeInput.style.borderColor="green";
  } else {
    postcodeMessage.innerText="❌ Delivery NOT available in this area";
    postcodeMessage.style.color="red";
    postcodeInput.style.borderColor="red";
  }
});

// Delivery slots next 7 days
const deliverySlotSelect = document.getElementById("deliverySlot");
for(let i=0;i<7;i++){
  const d=new Date(); d.setDate(d.getDate()+i);
  const day = d.toLocaleDateString('en-AU',{weekday:'short',day:'numeric',month:'short'});
  ["10am–2pm","2pm–6pm"].forEach(slot=>{
    const opt=document.createElement("option");
    opt.value=`${day} ${slot}`; opt.textContent=`${day} ${slot}`;
    deliverySlotSelect.appendChild(opt);
  });
}

// Stripe
const stripe = Stripe("pk_test_51SUX2KAmiKZAr3Zsst3DLkjb2baO00udZQmzHBzqTqrZKJHoUM5g2WjUZmQVJdWNYBcq6KdcHIoedSOchASoCuTr00Ivou7q1b");
const elements = stripe.elements();
const card = elements.create("card");
card.mount("#card-element");

// Back to trolley
document.getElementById("backTrolley").onclick=()=>window.location.href="trolley.html";

// Place order
document.getElementById("placeOrder").onclick=async ()=>{
  const name=document.getElementById("customerName").value.trim();
  const email=document.getElementById("customerEmail").value.trim();
  const phone=document.getElementById("customerMobile").value.trim();
  const address=document.getElementById("customerAddress").value.trim();
  const suburb=document.getElementById("customerSuburb").value.trim();
  const state=document.getElementById("customerState").value;
  const postcode=document.getElementById("customerPostcode").value.trim();
  const slot=document.getElementById("deliverySlot").value;
  const cardName=document.getElementById("cardName").value.trim();
  const special=document.getElementById("specialInstructions").value.trim();
  const country="AU";

  if(!name||!email||!phone||!address||!suburb||!state||!postcode||!slot||!cardName){
    alert("Please fill all fields and select a delivery slot."); return;
  }

  if(!allowedPostcodes.includes(parseInt(postcode,10))){
    alert("Sorry, delivery is not available in your area ("+postcode+")."); return;
  }

  const grandTotal=subtotal+deliveryFee;
  const amountInCents=Math.round(grandTotal*100);

  try{
    const response = await fetch("/create-payment-intent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        amount:amountInCents,
        trolley,
        customer:{name,email,phone,address,suburb,state,postcode,slot,special}
      })
    });

    const data=await response.json();
    if(data.error) throw new Error(data.error);

    const result = await stripe.confirmCardPayment(data.clientSecret,{
      payment_method:{
        card:card,
        billing_details:{
          name:cardName,email,phone,address:{line1:address,city:suburb,state,postal_code:postcode,country}
        }
      }
    });

    if(result.error){
      messageBox.innerHTML="❌ Payment failed: "+result.error.message+"<br><small>Click anywhere to dismiss</small>";
      messageOverlay.style.display="flex"; return;
    }

    let countdown=5;
    messageBox.innerHTML=`✅ Payment Successful!<br>Your order no: GGO-${Math.floor(100000+Math.random()*900000)}<br>Redirecting in ${countdown}...`;
    messageOverlay.style.display="flex";
    localStorage.removeItem("grocerygo_trolley");

    const interval=setInterval(()=>{
      countdown--; 
      messageBox.innerHTML=`✅ Payment Successful!<br>Your order no: GGO-${Math.floor(100000+Math.random()*900000)}<br>Redirecting in ${countdown}...`;
      if(countdown<=0){ clearInterval(interval); window.location.href="index.html"; }
    },1000);

  }catch(err){
    messageBox.innerHTML="❌ Error: "+err.message+"<br><small>Click anywhere to dismiss</small>";
    messageOverlay.style.display="flex";
  }
};
</script>
</body>
</html>
