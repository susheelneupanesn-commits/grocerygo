<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GroceryGo | Checkout</title>
<script src="https://js.stripe.com/v3/"></script>

<!-- Firebase Config -->
<script>
  // Replace these values with your Firebase project config
  const __app_id = "grocerygo-app";
  const __firebase_config = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  let db, auth, userId, isAuthReady = false;

  async function initFirebase() {
    try {
      if (!__firebase_config || Object.keys(__firebase_config).length === 0) {
        console.error("Firebase configuration is missing.");
        return;
      }
      const app = initializeApp(__firebase_config);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
        } else {
          const anonUser = await signInAnonymously(auth);
          userId = anonUser.user.uid;
        }
        isAuthReady = true;
        console.log("Firebase Auth Ready. User ID:", userId);
      });

    } catch (e) {
      console.error("Firebase Initialization Error:", e);
    }
  }

  initFirebase();

  // Delivery fee logic
  const SERVICE_AREAS = {
    "4000":10,"4001":10,"4005":10,"4006":10,"4010":10,"4064":10,"4066":10,
    "4031":15,"4034":15,"4075":15,"4101":15,"4120":15,"4151":15,"4017":15,
    "4500":20,"4207":20,"4300":20,"4305":20
  };
  const MAX_FEE = 20;
  const NOT_SERVICEABLE_FEE = MAX_FEE + 1;

  function formatCurrency(amount){return new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'}).format(amount);}
  function calculateDeliveryFee(postcode){ return SERVICE_AREAS[postcode] || NOT_SERVICEABLE_FEE; }

  function displayMessage(message, success=false){
    const overlay = document.getElementById("messageOverlay");
    const box = document.getElementById("messageBox");
    box.className = success ? 'message-success' : 'message-error';
    box.innerHTML = message;
    overlay.style.display="flex";
    if(!success) overlay.onclick=()=>overlay.style.display="none";
  }

  const trolley = JSON.parse(localStorage.getItem("grocerygo_trolley") || "[]");
  if(!trolley.length){ displayMessage("Your trolley is empty. Redirecting..."); setTimeout(()=>window.location.href="/index.html",1500); }

  let subtotal = trolley.reduce((sum,item)=>sum+(item.price||0)*item.quantity,0);
  let deliveryFee = 0;
  function updateTotals(){ 
    const grandTotal = subtotal+deliveryFee;
    document.getElementById("subtotalAmount").innerText = formatCurrency(subtotal);
    document.getElementById("deliveryFee").innerText = formatCurrency(deliveryFee);
    document.getElementById("grandTotalAmount").innerText = formatCurrency(grandTotal);
  }
  updateTotals();

  const deliverySlotSelect = document.getElementById("deliverySlot");
  const MIN_HOURS = 8;
  const cutoff = new Date(); cutoff.setHours(cutoff.getHours()+MIN_HOURS);
  for(let i=0;i<7;i++){
    const d=new Date(); d.setDate(d.getDate()+i);
    const day=d.toLocaleDateString('en-AU',{weekday:'short',day:'numeric',month:'short'});
    [{startHour:10,label:"10am–2pm"},{startHour:14,label:"2pm–6pm"}].forEach(slot=>{
      const t=new Date(d); t.setHours(slot.startHour,0,0,0);
      if(t>cutoff){const opt=document.createElement("option");opt.value=`${day} ${slot.label}`;opt.textContent=`${day} ${slot.label}`;deliverySlotSelect.appendChild(opt);}
    });
  }
  if(deliverySlotSelect.options.length===1){const opt=document.createElement("option");opt.disabled=true;opt.textContent="No delivery slots available today. Check tomorrow.";deliverySlotSelect.appendChild(opt);}

  document.getElementById("customerPostcode").oninput=(e)=>{
    const pc=e.target.value.trim(); const msg=document.getElementById("postcodeMessage"); const input=e.target;
    if(pc&&pc.length===4&&!isNaN(pc)){
      deliveryFee=calculateDeliveryFee(pc);
      if(deliveryFee>MAX_FEE){msg.innerText=`❌ Delivery not available (${pc}).`; msg.style.color='#ef4444'; input.style.borderColor='#ef4444'; deliveryFee=0;}
      else{msg.innerText=`✅ Delivery fee: ${formatCurrency(deliveryFee)}`; msg.style.color='#10b981'; input.style.borderColor='#10b981';}
    } else{ msg.innerText=pc.length>0?"Please enter valid 4-digit postcode":""; input.style.borderColor='#ccc'; deliveryFee=0; }
    updateTotals();
  };

  const stripe = Stripe("pk_test_51SUX2KAmiKZAr3Zsst3DLkjb2baO00udZQmzHBzqTqrZKJHoUM5g2WjUZmQVJdWNYBcq6KdcHIoedSOchASoCuTr00Ivou7q1b");
  const elements = stripe.elements();
  const card = elements.create("card",{hidePostalCode:true,style:{base:{fontSize:'16px',fontFamily:'Arial, sans-serif','::placeholder':{color:'#aab7c4'}}}});
  card.mount("#card-element");

  document.getElementById("backTrolley").onclick=()=>window.location.href="/index.html";

  document.getElementById("placeOrder").onclick=async()=>{
    const name=document.getElementById("customerName").value.trim();
    const email=document.getElementById("customerEmail").value.trim();
    const phone=document.getElementById("customerMobile").value.trim();
    const address=document.getElementById("customerAddress").value.trim();
    const suburb=document.getElementById("customerSuburb").value.trim();
    const state=document.getElementById("customerState").value;
    const postcode=document.getElementById("customerPostcode").value.trim();
    const slot=document.getElementById("deliverySlot").value;
    const cardName=document.getElementById("cardName").value.trim();
    const special=document.getElementById("specialInstructions").value.trim();

    if(!name||!email||!phone||!address||!suburb||!state||!postcode||!slot||!cardName){displayMessage("Please fill all required fields and select a delivery slot."); return;}
    deliveryFee=calculateDeliveryFee(postcode);
    if(deliveryFee>MAX_FEE){displayMessage(`Sorry, delivery not available in ${postcode}`); return;}
    const finalTotal=subtotal+deliveryFee;
    const amountInCents=Math.round(finalTotal*100);
    if(!isAuthReady||!userId){displayMessage("App not ready. Please wait."); return;}

    const btn=document.getElementById("placeOrder"); btn.disabled=true; btn.textContent="Processing...";

    try{
      const response=await fetch("/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:amountInCents,trolley,customer:{name,email,phone,address,suburb,state,postcode,slot,special,deliveryFee}})});
      const data=await response.json();
      if(data.error) throw new Error(data.error);

      const result=await stripe.confirmCardPayment(data.clientSecret,{
        payment_method:{card, billing_details:{name:cardName,email,phone,address:{line1:address,city:suburb,state,postal_code:postcode,country:'AU'}}}
      });

      if(result.error){ displayMessage(`Payment failed: ${result.error.message}`); btn.disabled=false; btn.textContent="Place Order & Pay"; return;}

      if(result.paymentIntent.status==="succeeded"){
        const orderNumber=Math.floor(100000+Math.random()*900000);
        const orderData={orderId:result.paymentIntent.id,orderNumber:`GGO-${orderNumber}`,userId,customer:{name,email,phone,address,suburb,state,postcode,slot,special},items:trolley.map(i=>({name:i.name,quantity:i.quantity,price:i.price})),totals:{subtotal,deliveryFee,grandTotal:finalTotal,amountInCents},status:'Processing',created:new Date().toISOString()};
        const ordersCollectionRef=collection(db, `artifacts/${__app_id}/users/${userId}/orders`);
        await addDoc(ordersCollectionRef,orderData);

        let countdown=5;
        const successMessage=document.getElementById("messageBox");
        successMessage.innerHTML=`✅ Payment Successful!<br>Your order no: GGO-${orderNumber}<br>Redirecting in ${countdown}...`;
        document.getElementById("messageOverlay").style.display="flex";
        const interval=setInterval(()=>{
          countdown--; successMessage.innerHTML=`✅ Payment Successful!<br>Your order no: GGO-${orderNumber}<br>Redirecting in ${countdown}...`;
          if(countdown<=0){clearInterval(interval); localStorage.removeItem("grocerygo_trolley"); window.location.href="/index.html";}
        },1000);
      }

    }catch(err){console.error(err); displayMessage(`❌ Error: ${err.message}`); btn.disabled=false; btn.textContent="Place Order & Pay";}
  };
</script>

<style>
body{font-family:'Inter',sans-serif;background:#f7f8fa;margin:0;padding:20px;}
.container{background:#fff;padding:25px;max-width:800px;margin:0 auto;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);display:flex;flex-direction:column;gap:15px;}
h1,h2{color:#0072ce;margin-bottom:0;font-weight:700;}
label{font-weight:600;margin-bottom:4px;display:block;font-size:0.95em;color:#333;}
input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;margin-bottom:12px;font-size:1em;transition:border-color 0.3s;}
input:focus,select:focus,textarea:focus{border-color:#0072ce;outline:none;box-shadow:0 0 0 2px rgba(0,114,206,0.2);}
textarea{height:80px;resize:vertical;}
.row{display:flex;gap:15px;flex-wrap:wrap;}.row div{flex:1;min-width:150px;}
#postcodeMessage{margin-top:-10px;margin-bottom:12px;font-weight:500;}
#priceSummary{padding:15px;background:#eef2ff;border-radius:8px;margin-top:10px;}
#priceSummary div{font-size:15px;color:#4b5563;margin-bottom:6px;display:flex;justify-content:space-between;}
#priceSummary .grandTotal{font-size:1.25em;color:#1f2937;font-weight:bold;margin-top:10px;padding-top:8px;border-top:1px dashed #c4c4c4;}
#card-element{padding:12px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff;margin-bottom:10px;min-height:50px;display:flex;align-items:center;}
.bottom-bar{display:flex;justify-content:space-between;margin-top:20px;gap:15px;}
.bottom-bar button{background:#0072ce;border:none;color:white;padding:12px 20px;font-size:1em;border-radius:8px;cursor:pointer;flex:1;transition:background-color 0.3s,box-shadow 0.3s;font-weight:600;}
.bottom-bar button:hover:not(:disabled){background:#005fa3;box-shadow:0 4px 8px rgba(0,114,206,0.3);}
.bottom-bar button:disabled{background:#9ca3af;cursor:not-allowed;}
#backTrolley{background:#6b7280;}#backTrolley:hover{background:#4b5563;}
#messageOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000;}
#messageBox{padding:30px 25px;border-radius:12px;font-size:1.1em;font-weight:bold;color:white;text-align:center;max-width:450px;box-shadow:0 10px 25px rgba(0,0,0,0.3);}
.message-success{background-color:#10b981;}
.message-error{background-color:#ef4444;}
@media(max-width:640px){.row{flex-direction:column;gap:0;}.bottom-bar{flex-direction:column;gap:10px;}.container{padding:15px;}}
</style>
</head>
<body>
<div class="container" autocomplete="off">
<h1>Checkout</h1>
<label>Full Name</label><input type="text" id="customerName" placeholder="John Doe" autocomplete="name">
<div class="row">
<div><label>Email</label><input type="email" id="customerEmail" placeholder="john@example.com" autocomplete="email"></div>
<div><label>Mobile Number</label><input type="text" id="customerMobile" placeholder="0412345678" autocomplete="tel"></div>
</div>
<label>Delivery Address</label><input type="text" id="customerAddress" placeholder="123 Queen St" autocomplete="street-address">
<div class="row">
<div><label>Suburb</label><input type="text" id="customerSuburb" placeholder="Brisbane" autocomplete="address-level2"></div>
<div><label>State</label>
<select id="customerState" autocomplete="address-level1">
<option value="QLD" selected>Queensland</option>
<option value="NSW">New South Wales</option>
<option value="VIC">Victoria</option>
<option value="WA">Western Australia</option>
<option value="SA">South Australia</option>
<option value="TAS">Tasmania</option>
<option value="NT">Northern Territory</option>
<option value="ACT">ACT</option>
</select>
</div>
<div><label>Postcode (For Delivery Fee)</label><input type="text" id="customerPostcode" placeholder="4000" autocomplete="postal-code"><small id="postcodeMessage"></small></div>
</div>
<label>Select your preferred delivery time</label>
<select id="deliverySlot"><option value="">Choose your time slot</option></select>
<div id="priceSummary">
<div>Subtotal:<span></span><span id="subtotalAmount">$0.00</span></div>
<div>Delivery Fee:<span></span><span id="deliveryFee">$0.00</span></div>
<div class="grandTotal">Grand Total:<span></span><span id="grandTotalAmount">$0.00</span></div>
</div>
<h2>Payment Details</h2>
<label>Cardholder Name</label><input type="text" id="cardName" placeholder="John Doe" autocomplete="cc-name">
<div><label>Card Details</label><div id="card-element"></div></div>
<label>Special Instructions</label><textarea id="specialInstructions" placeholder="E.g., Leave at front door"></textarea>
<div class="bottom-bar">
<button id="backTrolley">◀️ Back to Trolley</button>
<button id="placeOrder">Place Order & Pay</button>
</div>
</div>
<div id="messageOverlay"><div id="messageBox"></div></div>
</body>
</html>
