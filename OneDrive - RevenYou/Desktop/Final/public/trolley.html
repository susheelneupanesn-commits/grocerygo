<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GroceryGo | Trolley</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .qty-btn { padding: 2px 8px; margin: 0 2px; cursor: pointer; }
    .summary-buttons button { margin-right: 10px; padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>
<header>
  <h1>
    <div class="logo-container">
      <span class="logo-trolley-g">G<span class="logo-grocery-text">Grocery</span></span>
      <span class="logo-o">o</span>
    </div>
  </h1>
  <nav>
    <a href="index.html">HOME</a>
    <a href="store.html">STORE</a>
    <a href="about.html">ABOUT US</a>
    <a href="contact.html">CONTACT</a>
  </nav>
  <div class="header-tools">
    <a href="trolley.html" class="trolley-icon">ðŸ›’</a>
  </div>
</header>

<main class="cart-page-main">
  <h1>Your Shopping Cart</h1>

  <div class="cart-flex-wrapper">
    <div class="trolley-table-wrapper">
      <table class="trolley-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Unit Price</th>
            <th>Quantity</th>
            <th>Item Subtotal (AUD $)</th>
          </tr>
        </thead>
        <tbody id="trolleyTable">
          <tr>
            <td colspan="5" class="empty-cart-message">
              Your cart is empty. <a href="store.html">Start shopping now!</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <aside class="order-summary">
      <h2>Order Summary</h2>
      <div class="summary-item"><span>Subtotal:</span> <span id="trolleySubtotal">$0.00</span></div>
      <div class="summary-item"><span>Delivery Fee:</span> <span>Calculated on next page</span></div>

      <div class="summary-buttons">
        <button id="continueShoppingBtn">Continue Shopping</button>
        <button id="clearTrolleyBtn">Empty Cart</button>
        <button id="proceedCheckoutBtn">Proceed Checkout</button>
      </div>
      <div id="confirmPopup" style="
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  background: hsl(52, 95%, 46%);
  color: #333;
  padding: 20px 30px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  z-index: 10000;
  text-align: center;
">
  <p id="confirmText" style="margin-bottom:15px;font-weight:600;"></p>
  <button id="confirmYes" style="padding:6px 12px;margin-right:10px;cursor:pointer;background:#f57c00;color:white;border:none;border-radius:4px;">Yes</button>
  <button id="confirmNo" style="padding:6px 12px;cursor:pointer;background:#9e9e9e;color:white;border:none;border-radius:4px;">No</button>
</div>
    </aside>
  </div>
</main>

<footer>
  <p>Â© 2025 GroceryGo. All rights reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://gikdqaxdqfmzdvolkxbn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdpa2RxYXhkcWZtemR2b2xreGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyOTQwNDIsImV4cCI6MjA3Nzg3MDA0Mn0.pJ-9KfCxV7YT5loiURW14xRmf72s1EZRFRh4iKGnQis";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const LS_KEY = 'grocerygo_trolley';
let trolley = JSON.parse(localStorage.getItem(LS_KEY)) || [];

// Update header trolley count
function updateTrolleyCount() {
  const el = document.getElementById('trolleyCount');
  if(el) el.textContent = trolley.reduce((sum, item) => sum + item.quantity, 0);
}

// Save trolley and update count
function saveTrolley() {
  localStorage.setItem(LS_KEY, JSON.stringify(trolley));
  updateTrolleyCount();
}

// Render trolley table
function renderTrolley() {
  const trolleyBody = document.getElementById('trolleyTable');
  const subtotalEl = document.getElementById('trolleySubtotal');

  if(!trolley.length) {
    trolleyBody.innerHTML = `<tr><td colspan="4" class="empty-cart-message">Your cart is empty. <a href="store.html">Start shopping now!</a></td></tr>`;
    subtotalEl.textContent = '$0.00';
    localStorage.setItem('grocerygo_subtotal', "0.00");
    updateTrolleyCount();
    return;
  }

  trolleyBody.innerHTML = '';
  let subtotal = 0;

  trolley.forEach((item, idx) => {
    const totalPrice = (item.price || 0) * item.quantity;
    subtotal += totalPrice;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.name} <br> ${item.brand || ''} ${item.variant ? '('+item.variant+')' : ''}</td>
      <td>$${item.price.toFixed(2)}</td>
      <td>
        <button class="qty-btn" onclick="changeQty(${idx}, -1)">-</button>
        ${item.quantity}
        <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
      </td>
      <td>$${totalPrice.toFixed(2)}</td>
    `;
    trolleyBody.appendChild(row);
  });

  subtotalEl.textContent = `$${subtotal.toFixed(2)}`;

  // SAVE SUBTOTAL FOR CHECKOUT
  localStorage.setItem('grocerygo_subtotal', subtotal.toFixed(2));

  updateTrolleyCount();
}


// Change quantity with confirmation on removal
function changeQty(idx, delta) {
  const item = trolley[idx];
  if(item.quantity + delta <= 0) {
    if(confirm(`Are you sure you want to remove "${item.name}${item.variant ? ' ('+item.variant+')' : ''}" from your trolley?`)) {
      trolley.splice(idx, 1);
    } else return;
  } else {
    item.quantity += delta;
  }
  saveTrolley();
  renderTrolley();
}

// Clear entire trolley
document.getElementById('clearTrolleyBtn').addEventListener('click', () => {
  if(confirm('Are you sure you want to empty your trolley?')) {
    trolley = [];
    saveTrolley();
    renderTrolley();
  }
});

// Continue shopping and checkout buttons
document.getElementById('continueShoppingBtn').addEventListener('click', () => {
  window.location.href = 'store.html';
});
document.getElementById('proceedCheckoutBtn').addEventListener('click', () => {
  window.location.href = 'checkout.html';
});

document.addEventListener('DOMContentLoaded', renderTrolley);
</script>
