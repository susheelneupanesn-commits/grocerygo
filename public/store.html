<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GroceryGo | Store</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
/* ---------- YOUR EXISTING STYLES (UNCHANGED) ---------- */
:root{
  --primary-color:#DC143C;
  --secondary-color:#003893;
  --highlight-color:#FFD700;
  --bg-color:#f8f9fa;
  --text-color:#222;
  --border-color:#ddd;
  --nepali-blue:#003893;
}
*{box-sizing:border-box}
body{font-family:'Poppins',sans-serif;margin:0;background:var(--bg-color);color:var(--text-color);line-height:1.6}
header{background:linear-gradient(to right,var(--primary-color),var(--secondary-color));color:#fff;padding:15px 10px 5px 10px;text-align:center;position:sticky;top:0;z-index:1000;}
header h1{margin:0 0 5px 0;font-size:30px;font-weight:900;display:flex;justify-content:center;align-items:center;height:60px;letter-spacing:-2px;}
.logo-container{display:flex;align-items:center;position:relative;padding-left:10px}
.logo-trolley-g{font-size:55px;color:white;font-weight:900;line-height:1;position:relative;padding-right:2px;text-shadow:1px 1px 0 var(--primary-color),2px 2px 2px rgba(0,0,0,0.5)}
.logo-grocery-text{position:absolute;top:-4px;left:10px;font-size:14px;font-weight:700;color:#FF8C00;letter-spacing:0.5px;white-space:nowrap;text-shadow:0 0 1px rgba(0,0,0,0.4);z-index:10;transform:rotate(-5deg);padding:2px 4px;background:rgba(255,255,255,0.1);border-radius:3px}
.logo-o{font-size:55px;color:white;font-weight:900;line-height:1;text-shadow:1px 1px 0 var(--primary-color),2px 2px 2px rgba(0,0,0,0.5);transform:translateX(-5px) rotate(2deg);position:relative;z-index:5}
nav{margin-top:5px}
nav a{color:white;text-decoration:none;margin:0 10px;font-weight:600;font-size:14px;padding:5px 0;display:inline-block}
nav a:hover{text-decoration:underline}
.header-tools{display:flex;align-items:center;width:100%;max-width:1200px;margin:0 auto;padding:5px 10px;gap:10px}
.search-wrap{flex:1 !important;display:flex;position:relative;margin-right:0 !important;max-width:none !important;}
#headerSearch{width:100%;padding:8px 15px;border:none;border-radius:6px;font-size:16px;box-sizing:border-box}
#headerSearchSuggestions{border:1px solid var(--border-color);border-radius:0 0 8px 8px;max-height:300px;overflow-y:auto;background:white;position:absolute;width:100%;display:none;z-index:120;color:var(--text-color);box-shadow:0 4px 6px rgba(0,0,0,0.12);top:100%}
#headerSearchSuggestions div{padding:8px 12px;cursor:pointer}
#headerSearchSuggestions div:hover{background:var(--highlight-color);color:#000}
#trolleyIcon{cursor:pointer;font-size:18px;font-weight:700;display:flex;align-items:center;padding:5px 10px;border:2px solid var(--highlight-color);border-radius:6px;background:rgba(255,255,255,0.08);transition:background 0.2s;white-space:nowrap}
#trolleyIcon:hover{background:rgba(255,255,255,0.14)}
#trolleyCount{background:var(--highlight-color);color:var(--text-color);padding:1px 6px;border-radius:50%;margin-left:8px;font-size:14px;font-weight:900}
.banner{background:teal;color:white;padding:10px 0;text-align:center;font-weight:700;font-size:16px;position:relative;overflow:hidden;z-index:999;height:36px}
.banner-content{display:flex;justify-content:center;align-items:center;white-space:nowrap;height:100%}
.banner-text{display:inline-block;padding-right:12px}
.banner-add-btn{background:var(--highlight-color);color:var(--text-color);border:none;padding:3px 8px;border-radius:4px;font-size:0.9em;font-weight:700;cursor:pointer;margin-left:10px}
.banner-add-btn:hover{background:#ffc300}
.container{width:95%;max-width:1200px;margin:20px auto;padding:10px}
#productGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;margin-top:20px}
.product-card{background:white;padding:15px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.06);text-align:center;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;min-height:420px;transition:transform 0.3s, box-shadow 0.3s}
.product-card:hover{transform:translateY(-5px);box-shadow:0 8px 16px rgba(0,0,0,0.12)}
.product-image-container{height:180px;width:100%;display:flex;justify-content:center;align-items:center}
.product-card img{max-width:100%;max-height:100%;object-fit:contain;border-radius:6px}
.product-info{flex-grow:1;text-align:left;margin-bottom:10px}
.product-name{font-weight:600;margin:5px 0 0;font-size:1.1em;min-height:40px}
.product-brand{color:#555;font-size:0.9em;margin-bottom:5px;display:block}
.product-price{font-size:1.4em;font-weight:700;color:var(--primary-color);margin-bottom:5px;display:block}
.add-to-cart-btn{width:100%;margin-top:10px;padding:10px 12px;border-radius:8px;font-size:1.1em;background:var(--primary-color);color:white;border:none;cursor:pointer;transition:0.2s}
.add-to-cart-btn:hover{background:var(--secondary-color)}
#centerToast{display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);background:var(--nepali-blue);color:white;padding:10px 16px;border-radius:6px;z-index:999;font-weight:700;text-align:center}
footer{background:var(--nepali-blue);color:white;text-align:center;padding:15px 0;font-size:14px;margin-top:40px}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <h1>
    <div class="logo-container">
      <span class="logo-trolley-g">G<span class="logo-grocery-text">Grocery</span></span>
      <span class="logo-o">o</span>
    </div>
  </h1>

  <nav>
    <a href="index.html">HOME</a>
    <a href="store.html">STORE</a>
    <a href="about.html">ABOUT US</a>
    <a href="contact.html">CONTACT</a>
  </nav>

  <div class="header-tools">
    <div class="search-wrap">
      <input id="headerSearch" placeholder="ðŸ” Search (e.g., 'rice', 'MDH')..." autocomplete="off">
      <div id="headerSearchSuggestions"></div>
    </div>
    <div id="trolleyIcon" onclick="window.location.href='trolley.html'"> ðŸ›’ <span id="trolleyCount">0</span></div>
  </div>

  <div class="banner">
    <div class="banner-content">
      <span id="dynamicBannerText">Welcome to GroceryGo! New stock just arrived!</span>
      <button class="banner-add-btn">Add</button>
    </div>
  </div>
</header>

<!-- MAIN -->
<div class="container">
  <h2>Our Store</h2>
  <div id="productGrid"></div>
</div>

<footer>Â© 2025 GroceryGo. All rights reserved.</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* -------------------------------------
      SUPABASE + GLOBAL SEARCH FIX
-------------------------------------- */
const SUPABASE_URL = "https://gikdqaxdqfmzdvolkxbn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdpa2RxYXhkcWZtemR2b2xreGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyOTQwNDIsImV4cCI6MjA3Nzg3MDA0Mn0.pJ-9KfCxV7YT5loiURW14xRmf72s1EZRFRh4iKGnQis";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const LS_SEARCH = "grocerygo_searchQuery";
const LS_TROLLEY = "grocerygo_trolley";

let products = [];
let trolley = JSON.parse(localStorage.getItem(LS_TROLLEY)) || [];

/* ------------------ TROLLEY FUNCTIONS ------------------ */
function updateTrolleyCount(){
  const el = document.getElementById("trolleyCount");
  if(el) el.textContent = trolley.reduce((s,i)=>s+i.quantity,0);
}
function saveTrolley(){
  localStorage.setItem(LS_TROLLEY, JSON.stringify(trolley));
  updateTrolleyCount();
}
function showToast(msg){
  let t=document.getElementById("centerToast");
  if(!t){t=document.createElement("div");t.id="centerToast";document.body.appendChild(t);}
  t.textContent=msg;t.style.display="block";
  setTimeout(()=>t.style.display="none",1500);
}
function addToTrolley(p,variant,price){
  const existing = trolley.find(i=>i.id===p.id && i.variant===variant);
  if(existing){existing.quantity++;} 
  else{trolley.push({id:p.id,name:p.Item||p.name,brand:p.brand||"",variant,price,quantity:1});}
  saveTrolley();
  showToast(`${p.Item||p.name}${variant?` (${variant})`:''} added!`);
}

/* ------------------ FILTER FOR SEARCH ------------------ */
function filterProducts(q){
  q = q.toLowerCase();
  return products.filter(p =>
    (p.Item && p.Item.toLowerCase().includes(q)) ||
    (p.brand && p.brand.toLowerCase().includes(q))
  );
}

/* ------------------ RENDER PRODUCTS ------------------ */
function renderProducts(list){
  const grid = document.getElementById("productGrid");
  grid.innerHTML = "";

  list.forEach(p=>{
    if(typeof p.variants==="string") p.variants = JSON.parse(p.variants);
    if(typeof p.placeholder_images==="string") p.placeholder_images = JSON.parse(p.placeholder_images);

    const price = p.variants?.length ? Number(p.variants[0].price) : Number(p.price);
    const img = p.placeholder_images?.[0] || "https://via.placeholder.com/300x200?text=No+Image";

    const card=document.createElement("div");
    card.className="product-card";
    card.innerHTML=`
      <div class="product-image-container"><img src="${img}"></div>
      <div class="product-info">
        <span class="product-name">${p.Item||p.name}</span>
        <span class="product-brand">${p.brand||""}</span>
        <span class="product-size">${p.pack_size || (p.variants && p.variants.length ? p.variants[0].name : '')}</span>
        <span class="product-price">$${price.toFixed(2)}</span>
        ${p.variants?.length ? `<select class="product-variant">
            ${p.variants.map(v=>`<option value="${v.name}">${v.name} â€” $${Number(v.price).toFixed(2)}</option>`).join("")}
        </select>` : ""}
      </div>
      <button class="add-to-cart-btn">Add to Trolley</button>
    `;

    card.querySelector(".add-to-cart-btn").onclick=()=>{
      const v = card.querySelector(".product-variant")?.value || p.variants?.[0]?.name || "";
      const vp = p.variants?.find(x=>x.name===v)?.price || p.price;
      addToTrolley(p,v,Number(vp));
    };

    grid.appendChild(card);
  });
}

/* ------------------ SEARCH DROPDOWN (FIXED) ------------------ */
const searchInput = document.getElementById('headerSearch');
const suggestionBox = document.getElementById('headerSearchSuggestions');
let searchTimeout = null;

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim();
  if (searchTimeout) clearTimeout(searchTimeout);

  if (!q) {
    suggestionBox.style.display = 'none';
    renderProducts(products);
    return;
  }

  searchTimeout = setTimeout(async () => {
    const matches = filterProducts(q);

    suggestionBox.innerHTML = '';
    matches.slice(0,10).forEach(p => {
      const div = document.createElement('div');
      div.innerText = p.Item + (p.brand ? ` (${p.brand})` : '');
      div.onclick = () => {
        searchInput.value = p.Item;
        suggestionBox.style.display = 'none';
        renderProducts(filterProducts(p.Item));
      };
      suggestionBox.appendChild(div);
    });

    suggestionBox.style.display = matches.length ? 'block' : 'none';
  }, 250);
});

document.addEventListener('click', e => {
  if (!searchInput.contains(e.target) && !suggestionBox.contains(e.target)) {
    suggestionBox.style.display = 'none';
  }
});

/* ------------------ LOAD PRODUCTS ------------------ */
async function loadProducts(){
  const {data,error} = await supabaseClient.from("products").select("*");
  if(error){console.error(error);return;}

  products = data || [];

  // If redirected from other pages with search query
  const saved = localStorage.getItem(LS_SEARCH);
  if(saved){
    searchInput.value = saved;
    renderProducts(filterProducts(saved));
    localStorage.removeItem(LS_SEARCH);
  } else {
    renderProducts(products);
  }
}

/* ------------------ INIT ------------------ */
document.addEventListener("DOMContentLoaded",()=>{
  updateTrolleyCount();
  loadProducts();
});
</script>

</body>
</html>
